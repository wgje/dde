# ä¸“æ³¨æ¨¡å¼ï¼ˆFocus Modeï¼‰ç­–åˆ’æ¡ˆ

> **æ ¸å¿ƒç†å¿µ**ï¼šä»»åŠ¡ä¸æ˜¯é™æ€çš„æ–‡æœ¬ï¼Œè€Œæ˜¯å¿…é¡»æµåŠ¨çš„æµä½“ã€‚å µä½äº†ï¼Œå°±å¾—å…ˆç–é€šï¼›æµä¸‹å»äº†ï¼Œå°±å˜æˆäº†åœ°åŸºã€‚

---

## ã€‡ã€å®¡æŸ¥æ‘˜è¦ä¸å˜æ›´è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ |
|------|------|----------|
| 1.0 | 2026-01-22 | åˆå§‹ç­–åˆ’æ¡ˆ |
| 1.1 | 2026-01-22 | æ·±åº¦å®¡æŸ¥ä¼˜åŒ–ï¼šè¡¥å……ç¦»çº¿åŒæ­¥ã€æƒé™æ ¡éªŒã€API æˆæœ¬æ§åˆ¶ã€é”™è¯¯å¤„ç†ã€å¯è®¿é—®æ€§ã€æ•°æ®è¿ç§»ç­‰ |
| 1.2 | 2026-01-23 | æŠ€æœ¯æ¶æ„å‡çº§ï¼šé‡‡ç”¨ Groq + Supabase Edge Function ä¸‰æ˜æ²»æ¶æ„ï¼Œæ›¿æ¢ OpenAI Whisper |
| 1.3 | 2026-01-23 | ä»£ç å®ç°éªŒè¯ï¼šä¿®å¤ Edge Function Deno è¯­æ³•ã€RLS ç­–ç•¥æ‹†åˆ†ã€iOS Safari å…¼å®¹ã€å®Œæ•´ç¦»çº¿é˜Ÿåˆ— |

### æŠ€æœ¯æ¶æ„äº®ç‚¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Angular å‰ç«¯    â”‚     â”‚  Supabase Edge Function  â”‚     â”‚    Groq API     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”€â”€â–º â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”€â”€â–º â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  é‡‡é›†éº¦å…‹é£æ•°æ®   â”‚     â”‚  æŒæœ‰ GROQ_API_KEY       â”‚     â”‚  whisper-large  â”‚
â”‚  æ‰“åŒ…æˆ Blob     â”‚     â”‚  æ¥æ”¶ Blobï¼Œè½¬å‘ç»™ Groq   â”‚     â”‚  -v3 è½¬å†™       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸‰æ˜æ²»æ¶æ„ä¼˜åŠ¿**ï¼š
- âœ… **å®‰å…¨**ï¼šAPI Key æ°¸ä¸æš´éœ²åœ¨å‰ç«¯ï¼ˆé€šè¿‡ `supabase secrets set` å­˜å‚¨ï¼‰
- âœ… **æé€Ÿ**ï¼šGroq è½¬å†™å“åº”é€šå¸¸ 1-2 ç§’ï¼ˆæ¯” OpenAI å¿« 5-10 å€ï¼‰
- âœ… **ä½æˆæœ¬**ï¼šGroq æ¯” OpenAI Whisper æ›´ä¾¿å®œ
- âœ… **æ— éœ€è‡ªå»ºåç«¯**ï¼šSupabase Edge Function å³å¼€å³ç”¨

### å®¡æŸ¥å‘ç°çš„é—®é¢˜ï¼ˆå·²å…¨éƒ¨è§£å†³ï¼‰

| é—®é¢˜ | çŠ¶æ€ | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| ID ç­–ç•¥è¿è§„ | âœ… å·²ä¿®å¤ | ç§»é™¤ `DEFAULT gen_random_uuid()`ï¼Œå®¢æˆ·ç«¯ç”Ÿæˆ |
| ç¼ºå°‘ç¦»çº¿åŒæ­¥ | âœ… å·²ä¿®å¤ | éµå¾ª Offline-firstï¼ŒIndexedDB + RetryQueue |
| API Key ç¡¬ç¼–ç  | âœ… å·²ä¿®å¤ | Edge Function ä»£ç†ï¼Œ`supabase secrets` å­˜å‚¨ |
| ç¼ºå°‘é”™è¯¯å¤„ç† | âœ… å·²ä¿®å¤ | Result Pattern + FocusErrorCodes |
| ç¼ºå°‘å¯è®¿é—®æ€§ | âœ… å·²ä¿®å¤ | é”®ç›˜å¿«æ·é”® + ARIA æ ‡ç­¾ |
| ç¼ºå°‘é…é¢æ§åˆ¶ | âœ… å·²ä¿®å¤ | æ¯ç”¨æˆ·æ¯æ—¥ 50 æ¬¡é™é¢ |
| ç¼ºå°‘ç”¨æˆ·åå¥½ | âœ… å·²ä¿®å¤ | å¯åœ¨è®¾ç½®ä¸­ç¦ç”¨å¤§é—¨ |
| Edge Function è¯­æ³•é”™è¯¯ | âœ… å·²ä¿®å¤ | æ›´æ–° Deno å¯¼å…¥ã€FormData ç±»å‹å®‰å…¨ã€é”™è¯¯ç±»å‹å®ˆå« |
| RLS ç­–ç•¥å•ä¸€ | âœ… å·²ä¿®å¤ | æŒ‰æ“ä½œæ‹†åˆ†ï¼ˆSELECT/INSERT/UPDATE/DELETEï¼‰ |
| iOS Safari ä¸æ”¯æŒ webm | âœ… å·²ä¿®å¤ | åŠ¨æ€æ£€æµ‹ mimeTypeï¼Œå›é€€åˆ° mp4 |
| ç¦»çº¿é˜Ÿåˆ—ä¸å®Œæ•´ | âœ… å·²ä¿®å¤ | IndexedDB å­˜å‚¨ + ç½‘ç»œæ¢å¤è‡ªåŠ¨é‡è¯• |
| é…é¢æ£€æŸ¥ RLS ç»•è¿‡é—®é¢˜ | âœ… å·²ä¿®å¤ | ä½¿ç”¨ service_role å¯†é’¥ |

---

## ä¸€ã€åŠŸèƒ½æ¦‚è¿°

### 1.1 è®¾è®¡èƒŒæ™¯

ä¼ ç»Ÿä»»åŠ¡ç®¡ç†å·¥å…·å­˜åœ¨çš„é—®é¢˜ï¼š
- æŠŠæ‰€æœ‰æœªå®Œæˆæ¡ç›®å †ç§¯åœ¨ä¸€èµ·ï¼Œåƒä¸€åº§éšæ—¶ä¼šåå¡Œçš„åƒåœ¾å±±
- åˆ—è¡¨ç»™äººè™šå‡çš„æŒæ§æ„Ÿï¼Œçœ‹åˆ°æ˜¨å¤©æ²¡å‹¾æ‰çš„çº¢å­—ï¼Œå¤§è„‘çš„ç¬¬ä¸€ååº”æ˜¯"é€ƒè·‘"è€Œé"å¼€å·¥"
- è‡ªåŠ¨é¡ºå»¶è¿‡æœŸä»»åŠ¡å¯¼è‡´éº»æœ¨ï¼Œå¤±å»å¯¹æ—¶é—´çš„æ•æ„Ÿåº¦


### 1.2 æ ¸å¿ƒæ¨¡å—

| æ¨¡å— | å‘½å | åŠŸèƒ½ |
|------|------|------|
| å¤§é—¨ | Gate | å¼ºåˆ¶ç»“ç®—æ˜¨æ—¥é—ç•™ï¼Œä¸å¤„ç†ä¸æ”¾è¡Œ |
| èšå…‰ç¯ | Spotlight | æç®€å•ä»»åŠ¡æ‰§è¡Œï¼Œå±è”½ä¸€åˆ‡å™ªéŸ³ |
| åœ°è´¨å±‚ | Strata | å·²å®Œæˆä»»åŠ¡å †å å¯è§†åŒ–ï¼Œå†å²å³åœ°åŸº |
| é»‘åŒ£å­ | Black Box | è¯­éŸ³è½¬æ–‡å­—çš„ç´§æ€¥æ•æ‰ï¼Œå…è®¸"ç²¾ç¥å æœº" |

### 1.3 æ ¸å¿ƒæµå‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¯åŠ¨åº”ç”¨                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸšª å¤§é—¨ (Gate)                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                â”‚
â”‚  æ˜¨æ—¥æœªå®Œæˆæ¡ç›®é€ä¸€å±•ç¤º                                            â”‚
â”‚  å¿…é¡»å¯¹æ¯ä¸ªæ¡ç›®åšå‡ºè£å†³ï¼šå·²è¯» / å®Œæˆ                                â”‚
â”‚  å…¨éƒ¨å¤„ç†å®Œæ¯•æ‰èƒ½é€šè¿‡                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”¦ èšå…‰ç¯ (Spotlight)                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                â”‚
â”‚  å±å¹•æ­£ä¸­å¤®åªæ˜¾ç¤ºä¸€ä»¶äº‹                                            â”‚
â”‚  åšå®Œåˆ’èµ°ï¼Œä¸‹ä¸€ä»¶æ‰æµ®ç°                                            â”‚
â”‚  èƒŒæ™¯éšçº¦å¯è§åœ°è´¨å±‚                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ—» åœ°è´¨å±‚ (Strata)                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                â”‚
â”‚  å·²å®Œæˆä»»åŠ¡ä¸‹æ²‰å †å                                                 â”‚
â”‚  æ–°è®°å½•è¦†ç›–æ—§è®°å½•                                                  â”‚
â”‚  ä¸‹æ»‘å¯è§å±‚å±‚æˆ˜ç»©                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€æ¨¡å—è¯¦ç»†è®¾è®¡

### 2.1 å¤§é—¨ (Gate)

> **è®¾è®¡ç†å¿µ**ï¼š  
> å¤§é—¨å¹¶éä¸ºäº†"æƒ©ç½š"ï¼Œè€Œæ˜¯ä¸ºäº†"é˜»æ–­"ã€‚è§†è§‰ä¸Šé‡‡ç”¨**æ²‰æµ¸å¼åœ°è´¨å±‚çº¹ç† (Sedimentary Texture)**ï¼Œåƒä¸€å—å·¨çŸ³æŒ¡åœ¨é¢å‰ï¼Œä»£è¡¨ç€æ˜¨å¤©ç§¯ç´¯çš„é‡é‡ã€‚ç”¨æˆ·å¿…é¡»"æ¬å¼€"ï¼ˆå¤„ç†ï¼‰è¿™äº›é‡é‡ï¼Œæ‰èƒ½è¿›å…¥ä»Šæ—¥çš„è½»ç›ˆçŠ¶æ€ã€‚è´¨æ„Ÿä¸Šä¸"åœ°è´¨å±‚"æ¨¡å—å‘¼åº”ï¼Œé‡‡ç”¨åšé‡çš„å²©çŸ³è‰²è°ƒä¸å±‚ç§¯çº¹ç†ã€‚

#### 2.1.1 è§¦å‘æ¡ä»¶

- æ¯æ—¥é¦–æ¬¡æ‰“å¼€åº”ç”¨
- å­˜åœ¨å‰ä¸€å¤©æœªæ ‡è®°"å®Œæˆ"çš„é»‘åŒ£å­æ¡ç›®

#### 2.1.2 äº¤äº’é€»è¾‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¤§é—¨ç•Œé¢                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                            â”‚  â”‚
â”‚  â”‚  ğŸ“‹ æ˜¨æ—¥é—ç•™ (2/5)                          â”‚  â”‚
â”‚  â”‚                                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚                                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  "å…ˆåšAæ¨¡å—ï¼Œç„¶åè¿Bæ•°æ®åº“ï¼Œ          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   ä¸å¯¹ï¼Œé‚£ä¸ªæ¥å£æœ‰é—®é¢˜ï¼Œè¦å…ˆå¼„C..."   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  ğŸ• æ˜¨å¤© 21:34                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                      â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚   ğŸ‘ï¸ å·²è¯»   â”‚    â”‚   âœ… å·²å®Œæˆ     â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â”‚  â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚
â”‚  (èƒŒæ™¯æ¨¡ç³Šé®ç½©ï¼Œé˜»æ­¢ç‚¹å‡»åæ–¹å†…å®¹)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.1.3 æŒ‰é’®è¡Œä¸º

| æŒ‰é’® | è¡Œä¸º | æ¡ç›®çŠ¶æ€å˜æ›´ |
|------|------|-------------|
| ğŸ‘ï¸ å·²è¯» | æ¡ç›®æ ‡è®°ä¸ºå·²è¯»ï¼Œè¿›å…¥ä¸‹ä¸€æ¡ | `isRead: true` |
| âœ… å·²å®Œæˆ | æ¡ç›®æ ‡è®°ä¸ºå®Œæˆï¼Œè¿›å…¥ä¸‹ä¸€æ¡ | `isCompleted: true` |
| â­ï¸ ç¨åæé†’ | è·³è¿‡å½“å‰æ¡ç›®ï¼Œä¸‹æ¬¡æ‰“å¼€å†æé†’ | `snoozeUntil: tomorrow` |

> **ğŸ†• æ–°å¢"ç¨åæé†’"**ï¼šç¼“è§£ç”¨æˆ·å› å¼ºåˆ¶é˜»å¡äº§ç”Ÿçš„çƒ¦èºæƒ…ç»ªï¼Œå…è®¸æœ€å¤šè·³è¿‡ 3 æ¬¡

#### 2.1.4 çŠ¶æ€æœº

```typescript
type GateState = 
  | 'checking'      // æ£€æŸ¥æ˜¯å¦æœ‰é—ç•™æ¡ç›®
  | 'reviewing'     // å±•ç¤ºé—ç•™æ¡ç›®ä¸­
  | 'completed'     // å…¨éƒ¨å¤„ç†å®Œæ¯•
  | 'bypassed'      // æ— é—ç•™æ¡ç›®ï¼Œç›´æ¥é€šè¿‡
  | 'disabled';     // ç”¨æˆ·ç¦ç”¨å¤§é—¨åŠŸèƒ½ï¼ˆåœ¨è®¾ç½®ä¸­å…³é—­ï¼‰

interface GateContext {
  pendingItems: BlackBoxEntry[];
  currentIndex: number;
  state: GateState;
  snoozeCount: number;  // ğŸ†• å½“æ—¥å·²è·³è¿‡æ¬¡æ•°ï¼Œä¸Šé™ 3
}
```

#### 2.1.5 ç”¨æˆ·åå¥½ï¼ˆğŸ†• æ–°å¢ï¼‰

```typescript
// å…è®¸ç”¨æˆ·åœ¨è®¾ç½®ä¸­å…³é—­å¤§é—¨åŠŸèƒ½
interface FocusPreferences {
  gateEnabled: boolean;           // æ˜¯å¦å¯ç”¨å¤§é—¨ï¼ˆé»˜è®¤ trueï¼‰
  spotlightEnabled: boolean;      // æ˜¯å¦å¯ç”¨èšå…‰ç¯æ¨¡å¼
  blackBoxEnabled: boolean;       // æ˜¯å¦å¯ç”¨é»‘åŒ£å­
  maxSnoozePerDay: number;        // æ¯æ—¥æœ€å¤§è·³è¿‡æ¬¡æ•°ï¼ˆé»˜è®¤ 3ï¼‰
}
```

#### 2.1.6 UI è§„èŒƒ

```css
/* å¤§é—¨é®ç½©å±‚ */
.gate-overlay {
  position: fixed;
  inset: 0;
  z-index: 9999;
  backdrop-filter: blur(12px); /* åŠ é‡æ¨¡ç³Šï¼Œå¢å¼ºéš”ç»æ„Ÿ */
  background: rgba(28, 25, 23, 0.7); /* stone-950 alpha */
}

/* å¤§é—¨å¡ç‰‡ - åœ°è´¨å±‚è®¾è®¡è¯­è¨€ */
.gate-card {
  /* åŸºç¡€è´¨æ„Ÿï¼šæ²‰ç§¯å²©/çŸ³æ¿ */
  @apply bg-stone-50/98 dark:bg-stone-800/98;
  
  /* è½®å»“ï¼šåšé‡ä¸”æœ‰å±‚æ¬¡æ„Ÿ */
  @apply rounded-xl;
  @apply border-x-2 border-t-2 border-stone-300 dark:border-stone-600;
  @apply border-b-8 border-b-stone-400 dark:border-b-stone-700; /* åŠ åšåº•éƒ¨ï¼Œæ¨¡æ‹Ÿé‡åŠ›ä¸æ²‰ç§¯ */
  
  /* æ·±åº¦ä¸é˜´å½± */
  @apply shadow-2xl shadow-stone-900/50;
  @apply max-w-md mx-auto;
  @apply animate-slide-up;
}

/* è¿›åº¦æŒ‡ç¤ºå™¨ */
.gate-progress {
  @apply text-xs font-bold tracking-wider;
  @apply text-stone-500 dark:text-stone-400;
  @apply uppercase; /* ç±»ä¼¼é“­æ–‡çš„åˆ»å°æ„Ÿ */
}

/* ğŸ†• ç„¦ç‚¹æ•è·ï¼šç¡®ä¿é”®ç›˜å¯è®¿é—® */
.gate-overlay:focus-within {
  outline: none;
}

.gate-card:focus-visible {
  @apply ring-4 ring-stone-400/50 ring-offset-2 ring-offset-stone-900;
}
```

---

### 2.2 èšå…‰ç¯ (Spotlight)

#### 2.2.1 è®¾è®¡åŸåˆ™

- **åˆ‡æ–­é€‰æ‹©**ï¼šé€‰æ‹©æ˜¯ç—›è‹¦çš„ã€è€—èƒ½çš„ï¼Œç³»ç»Ÿæ›¿ä½ å±è”½å¹²æ‰°
- **å•ç‚¹èšç„¦**ï¼šå±å¹•æ­£ä¸­å¤®åªæ˜¾ç¤ºä¸€ä»¶äº‹
- **è¿ç»­æ€§æç¤º**ï¼šèƒŒæ™¯éšçº¦å¯è§åœ°è´¨å±‚ï¼Œæé†’è¿›åº¦çš„è¿ç»­æ€§

#### 2.2.2 ç•Œé¢ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                  â”‚
â”‚                 ğŸ”¦ ä»Šæ—¥ä¸“æ³¨                       â”‚
â”‚                                                  â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚     â”‚                                    â”‚       â”‚
â”‚     â”‚      å®Œæˆç”¨æˆ·è®¤è¯æ¨¡å—é‡æ„            â”‚       â”‚
â”‚     â”‚                                    â”‚       â”‚
â”‚     â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚       â”‚
â”‚     â”‚                                    â”‚       â”‚
â”‚     â”‚  "éœ€è¦å…ˆå¤„ç†OAuthå›è°ƒé—®é¢˜ï¼Œ         â”‚       â”‚
â”‚     â”‚   ç„¶åæµ‹è¯•JWTåˆ·æ–°é€»è¾‘..."          â”‚       â”‚
â”‚     â”‚                                    â”‚       â”‚
â”‚     â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚       â”‚
â”‚     â”‚          â”‚   âœ… å®Œæˆ    â”‚          â”‚       â”‚
â”‚     â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚       â”‚
â”‚     â”‚                                    â”‚       â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                  â”‚
â”‚  â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„  â”‚
â”‚  (ä¸‹æ–¹éšçº¦å¯è§å·²å®Œæˆä»»åŠ¡çš„åœ°è´¨å±‚)                   â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.2.3 äº¤äº’è¡Œä¸º

| æ“ä½œ | è¡Œä¸º |
|------|------|
| ç‚¹å‡»"å®Œæˆ" | å½“å‰ä»»åŠ¡ä¸‹æ²‰è‡³åœ°è´¨å±‚ï¼Œä¸‹ä¸€ä¸ªä»»åŠ¡æµ®ç° |
| å‘ä¸‹æ»‘åŠ¨ | æŸ¥çœ‹åœ°è´¨å±‚å†å²è®°å½• |
| é•¿æŒ‰ä»»åŠ¡å¡ç‰‡ | å±•å¼€è¯¦æƒ…/ç¼–è¾‘ |

#### 2.2.4 ä»»åŠ¡æ¥æºä¼˜å…ˆçº§

```typescript
// èšå…‰ç¯ä»»åŠ¡é€‰æ‹©é€»è¾‘
function getSpotlightTask(): Task | null {
  // 1. ä¼˜å…ˆæ˜¾ç¤ºé»‘åŒ£å­ä¸­æ ‡è®°ä¸º"å·²è¯»ä½†æœªå®Œæˆ"çš„æ¡ç›®
  const pendingBlackBox = getUncompletedReadEntries();
  if (pendingBlackBox.length > 0) {
    return convertToTask(pendingBlackBox[0]);
  }
  
  // 2. å…¶æ¬¡æ˜¾ç¤ºå¾…åŠäº‹é¡¹ä¸­æ’åºæœ€é«˜çš„ä»»åŠ¡
  const todoTasks = getTodoTasks();
  if (todoTasks.length > 0) {
    return todoTasks[0];
  }
  
  // 3. æ— ä»»åŠ¡æ—¶æ˜¾ç¤ºç©ºçŠ¶æ€
  return null;
}
```

---

### 2.3 åœ°è´¨å±‚ (Strata)

#### 2.3.1 è®¾è®¡ç†å¿µ

- å·²å®Œæˆä»»åŠ¡ä¸è¯¥æ˜¯ç‚¹å‡»å½’æ¡£æ‰èƒ½çœ‹åˆ°çš„å†å²è®°å½•
- åƒåœ°è´¨å±‚ä¸€æ ·æ²‰æ·€åœ¨ç•Œé¢åº•éƒ¨
- ç‰©ç†ä¸Šçš„å †å æ„Ÿæ¯”å†·å†°å†°çš„æ‰“å‹¾æ›´æœ‰åŠ›é‡

#### 2.3.2 è§†è§‰ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                  â”‚
â”‚  â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚  â† ä»Šæ—¥æ–°å¢å±‚
â”‚  â–‘â–‘ âœ… å®Œæˆç”¨æˆ·è®¤è¯æ¨¡å—é‡æ„  â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚
â”‚  â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â† æ—¥æœŸåˆ†éš”çº¿
â”‚  â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’  â”‚  â† æ˜¨æ—¥å±‚
â”‚  â–’â–’ âœ… ä¿®å¤æ”¯ä»˜æ¥å£bug  â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’  â”‚
â”‚  â–’â–’ âœ… ä¼˜åŒ–é¦–é¡µåŠ è½½é€Ÿåº¦  â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’  â”‚
â”‚  â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“  â”‚  â† æ›´æ—©çš„å±‚
â”‚  â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“  â”‚
â”‚  â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“  â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.3.3 è§†è§‰å±‚çº§

| æ—¶é—´ | é€æ˜åº¦ | é¢œè‰² | äº¤äº’ |
|------|--------|------|------|
| ä»Šæ—¥ | 100% | ä¸»è‰²è°ƒ | å¯å±•å¼€æŸ¥çœ‹è¯¦æƒ… |
| æ˜¨æ—¥ | 70% | æ¬¡è‰²è°ƒ | å¯å±•å¼€æŸ¥çœ‹è¯¦æƒ… |
| æ›´æ—© | 40% | ç°è‰²è°ƒ | æŠ˜å ä¸ºæ‘˜è¦ |

---

### 2.4 é»‘åŒ£å­ (Black Box)

#### 2.4.1 è®¾è®¡ç†å¿µ

> é£æœºå æ¯äº†ï¼Œåªæœ‰é»‘åŒ£å­èƒ½å‘Šè¯‰åäººï¼ˆæ˜å¤©çš„ä½ ï¼‰å½“æ—¶å‘ç”Ÿäº†ä»€ä¹ˆã€‚

- å…è®¸"ç²¾ç¥å æœº"çš„å®½å®¹è®¾è®¡
- é™ä½è®°å½•ç²¾åº¦ä»¥å¯¹æŠ—åŒå€¦
- æŠŠ"è¯´è¯"å½“ä½œè¾“å…¥æ–¹å¼ï¼Œè€Œé"å½•éŸ³"å½“ä½œå­˜å‚¨æ ¼å¼

#### 2.4.2 æ ¸å¿ƒäº¤äº’

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ğŸ“¦ é»‘åŒ£å­                          å±•å¼€ â–¼  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  ğŸ¤  æŒ‰ä½è¯´è¯ï¼Œæ¾å¼€è½¬æ–‡å­—             â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                            â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2025-01-22 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚  â”‚
â”‚  â”‚                                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ "å…ˆåšAæ¨¡å—ï¼Œç„¶åè¿Bæ•°æ®åº“..."        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                              21:34   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ ğŸ‘ï¸  â”‚ â”‚ âœ…  â”‚ â”‚ ğŸ“ å½’æ¡£ â”‚        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ "é‚£ä¸ªæ¥å£æœ‰é—®é¢˜ï¼Œè¦å…ˆå¼„C..."         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                              21:32   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ ğŸ‘ï¸  â”‚ â”‚ âœ…  â”‚ â”‚ ğŸ“ å½’æ¡£ â”‚        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.4.3 æ¡ç›®çŠ¶æ€

```typescript
interface BlackBoxEntry {
  id: string;                    // UUID
  content: string;               // è¯­éŸ³è½¬å†™çš„æ–‡æœ¬
  createdAt: string;             // ISO æ—¶é—´æˆ³
  date: string;                  // YYYY-MM-DDï¼Œç”¨äºæŒ‰æ—¥åˆ†ç»„
  
  // çŠ¶æ€
  isRead: boolean;               // æ˜¯å¦å·²è¯»
  isCompleted: boolean;          // æ˜¯å¦å·²å®Œæˆ
  isArchived: boolean;           // æ˜¯å¦å·²å½’æ¡£
  
  // å…ƒæ•°æ®
  originalAudioDuration?: number; // åŸå§‹éŸ³é¢‘æ—¶é•¿ï¼ˆç§’ï¼‰ï¼Œè½¬å†™ååˆ é™¤éŸ³é¢‘
}
```

#### 2.4.4 æŒ‰é’®è¡Œä¸º

| æŒ‰é’® | å›¾æ ‡ | è¡Œä¸º |
|------|------|------|
| å·²è¯» | ğŸ‘ï¸ | æ ‡è®°ä¸ºå·²è¯»ï¼Œä¸ä¼šåœ¨å¤§é—¨ä¸­å‡ºç° |
| å®Œæˆ | âœ… | æ ‡è®°ä¸ºå®Œæˆï¼Œè®¡å…¥åœ°è´¨å±‚ |
| å½’æ¡£ | ğŸ“ | ç§»å…¥å½’æ¡£åŒºï¼Œä¸æ˜¾ç¤ºåœ¨ä¸»åˆ—è¡¨ |

#### 2.4.5 è¯­éŸ³è½¬æ–‡å­—æŠ€æœ¯æ–¹æ¡ˆ

> **æ¶æ„åŸåˆ™**ï¼šä¸‰æ˜æ²»æ¶æ„ - Angularï¼ˆå‰ç«¯é‡‡é›†ï¼‰â†’ Supabase Edge Functionï¼ˆä¸­è½¬ä»£ç†ï¼‰â†’ Groqï¼ˆå¼•æ“ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Angular å‰ç«¯    â”‚     â”‚  Supabase Edge Function  â”‚     â”‚    Groq API     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”€â”€â–º â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”€â”€â–º â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  é‡‡é›†éº¦å…‹é£æ•°æ®   â”‚     â”‚  æŒæœ‰ GROQ_API_KEY       â”‚     â”‚  whisper-large  â”‚
â”‚  æ‰“åŒ…æˆ Blob     â”‚     â”‚  æ¥æ”¶ Blobï¼Œè½¬å‘ç»™ Groq   â”‚     â”‚  -v3 è½¬å†™       â”‚
â”‚  è°ƒç”¨ Edge Func  â”‚ â—„â”€â”€ â”‚  æ‹¿åˆ°æ–‡å­—è¿”å›             â”‚ â—„â”€â”€ â”‚  è¿”å›è½¬å†™æ–‡æœ¬    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âš ï¸ å®‰å…¨åŸåˆ™**ï¼šåƒä¸‡ä¸è¦æŠŠ API Key æ”¾åœ¨ Angular å‰ç«¯ä»£ç é‡Œï¼ˆå³ä½¿æ˜¯ environment.ts ä¹Ÿä¸è¡Œï¼‰ã€‚æµè§ˆå™¨æ˜¯é€æ˜çš„ï¼Œä»»ä½•äººéƒ½èƒ½ F12 æ‹¿èµ°ä½ çš„ Keyã€‚

**é€‰å‹ç†ç”±ï¼šGroq vs OpenAI Whisper**

| å¯¹æ¯”é¡¹ | Groq (whisper-large-v3) | OpenAI Whisper |
|--------|------------------------|----------------|
| é€Ÿåº¦ | æå¿«ï¼ˆ1-2ç§’å†…å“åº”ï¼‰ | è¾ƒæ…¢ï¼ˆ5-10ç§’ï¼‰ |
| æˆæœ¬ | æ›´ä½ | è¾ƒé«˜ |
| æ¨¡å‹ | å¼€æº whisper-large-v3 | é—­æº |
| ä¸­æ–‡æ”¯æŒ | âœ… ä¼˜ç§€ | âœ… ä¼˜ç§€ |

```typescript
// âš ï¸ é‡è¦ï¼šAPI Key ä¸èƒ½æš´éœ²åœ¨å‰ç«¯ï¼
// æŠ€æœ¯é€‰å‹ï¼šå‰ç«¯é‡‡é›† + Supabase Edge Function ä»£ç†è½¬å†™

// å‰ç«¯é‡‡é›†ï¼ˆæµè§ˆå™¨åŸç”ŸAPIï¼‰
async function startRecording(): Promise<MediaRecorder> {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  const recorder = new MediaRecorder(stream, { 
    mimeType: 'audio/webm;codecs=opus' 
  });
  return recorder;
}

// ğŸ†• é€šè¿‡ Supabase Edge Function è°ƒç”¨ Groq è½¬å†™ï¼ˆä¿æŠ¤ API Keyï¼‰
async function transcribeAudio(audioBlob: Blob): Promise<Result<string, OperationError>> {
  const formData = new FormData();
  formData.append('file', audioBlob, 'recording.webm');
  
  try {
    // è°ƒç”¨ Supabase Edge Functionï¼Œè€Œéç›´æ¥è°ƒç”¨ Groq
    const { data, error } = await supabase.functions.invoke('transcribe', {
      body: formData,
    });
    
    if (error) {
      return failure(ErrorCodes.TRANSCRIBE_FAILED, error.message);
    }
    
    return success(data.text);
  } catch (error) {
    return failure(ErrorCodes.NETWORK_ERROR, 'è½¬å†™è¯·æ±‚å¤±è´¥');
  }
}

// å…³é”®åŸåˆ™ï¼šè½¬å†™å®Œæˆåç«‹å³åˆ é™¤éŸ³é¢‘æºæ–‡ä»¶
// åªå­˜å‚¨æ–‡æœ¬ï¼Œä¸ç»´æŠ¤éŸ³é¢‘æ–‡ä»¶
// éŸ³é¢‘æ–‡ä»¶åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­åªæ˜¯ä¸€ä¸ªè¿‡å®¢ï¼Œç”¨å®Œå³å¼ƒï¼Œæ²¡æœ‰ä»»ä½•å­˜å‚¨æˆæœ¬
```

#### 2.4.6 Edge Function å®ç°ï¼ˆGroq + Denoï¼‰

**åˆå§‹åŒ–å‡½æ•°**ï¼š
```bash
# å‡è®¾ä½ å·²ç»è£…äº† supabase cli
supabase functions new transcribe
```

**è®¾ç½®ç¯å¢ƒå˜é‡**ï¼ˆæŠŠ Groq Key å®‰å…¨å­˜å‚¨åœ¨ Supabaseï¼‰ï¼š
```bash
# âš ï¸ æ°¸è¿œä¸è¦æŠŠ Key å†™åœ¨ä»£ç é‡Œ
supabase secrets set GROQ_API_KEY=gsk_your_actual_key_here
```

**éƒ¨ç½²å‡½æ•°**ï¼š
```bash
supabase functions deploy transcribe
```

**Edge Function ä»£ç **ï¼š
```typescript
// supabase/functions/transcribe/index.ts
// æ³¨æ„ï¼šè¿™é‡Œæ˜¯ç”¨ Deno è¿è¡Œçš„ TypeScript

// Deno æ ‡å‡†åº“å’Œ Supabase ä¾èµ–
// éœ€è¦åœ¨ supabase/functions/transcribe/deno.json ä¸­é…ç½® import_map
import { serve } from 'https://deno.land/std@0.177.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.0'

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

const DAILY_QUOTA_PER_USER = 50 // æ¯ç”¨æˆ·æ¯æ—¥é™é¢

serve(async (req: Request) => {
  // å¤„ç†è·¨åŸŸé¢„æ£€
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    // 1. è®¤è¯æ£€æŸ¥
    const authHeader = req.headers.get('Authorization')
    if (!authHeader) {
      return new Response(
        JSON.stringify({ error: 'Unauthorized' }), 
        { status: 401, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    // âš ï¸ ä½¿ç”¨ SUPABASE_SERVICE_ROLE_KEY æŸ¥è¯¢é…é¢ï¼ˆç»•è¿‡ RLSï¼‰
    // ä½†ç”¨æˆ·è®¤è¯ä»ä½¿ç”¨ä¼ å…¥çš„ authHeader
    const supabaseAdmin = createClient(
      Deno.env.get('SUPABASE_URL')!,
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!  // Edge Function å¯ä»¥å®‰å…¨ä½¿ç”¨ service_role
    )
    
    const supabaseUser = createClient(
      Deno.env.get('SUPABASE_URL')!,
      Deno.env.get('SUPABASE_ANON_KEY')!,
      { global: { headers: { Authorization: authHeader } } }
    )

    const { data: { user }, error: authError } = await supabaseUser.auth.getUser()
    if (authError || !user) {
      return new Response(
        JSON.stringify({ error: 'Invalid token' }), 
        { status: 401, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    // 2. é…é¢æ£€æŸ¥ï¼ˆä½¿ç”¨ service_role æŸ¥è¯¢ï¼Œç¡®ä¿å‡†ç¡®ï¼‰
    const today = new Date().toISOString().split('T')[0]
    const { count, error: countError } = await supabaseAdmin
      .from('transcription_usage')
      .select('*', { count: 'exact', head: true })
      .eq('user_id', user.id)
      .eq('date', today)

    if (countError) {
      console.error('Quota check error:', countError)
      // é…é¢æ£€æŸ¥å¤±è´¥æ—¶ä»å…è®¸è¯·æ±‚ï¼Œé¿å…å½±å“æ­£å¸¸ä½¿ç”¨
    } else if ((count ?? 0) >= DAILY_QUOTA_PER_USER) {
      return new Response(
        JSON.stringify({ error: 'ä»Šæ—¥è½¬å†™æ¬¡æ•°å·²è¾¾ä¸Šé™', code: 'QUOTA_EXCEEDED' }), 
        { status: 429, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    // 3. ä» Angular æ¥æ”¶ FormData (åŒ…å«å½•éŸ³æ–‡ä»¶)
    const formData = await req.formData()
    const audioFile = formData.get('file') as File | null

    if (!audioFile || !(audioFile instanceof File)) {
      return new Response(
        JSON.stringify({ error: 'No audio file uploaded' }), 
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    // 4. æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ 25MBï¼ŒGroq é™åˆ¶ï¼‰
    const MAX_FILE_SIZE = 25 * 1024 * 1024
    if (audioFile.size > MAX_FILE_SIZE) {
      return new Response(
        JSON.stringify({ error: 'éŸ³é¢‘æ–‡ä»¶è¿‡å¤§ï¼Œè¯·æ§åˆ¶åœ¨ 25MB ä»¥å†…' }), 
        { status: 413, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    // 5. å‡†å¤‡å‘ç»™ Groq çš„æ•°æ®
    const groqFormData = new FormData()
    groqFormData.append('file', audioFile)
    groqFormData.append('model', 'whisper-large-v3')  // Groq ç›®å‰æœ€å¼ºçš„å¼€æºæ¨¡å‹
    // å¯é€‰ï¼šè®¾ç½® prompt å¼•å¯¼æ¨¡å‹è¾“å‡ºç®€ä½“ä¸­æ–‡
    groqFormData.append('prompt', 'è¿™æ˜¯ä¸€æ®µå…³äºè½¯ä»¶å¼€å‘çš„é¡¹ç›®æ€è·¯ï¼Œè¯·ç”¨ç®€ä½“ä¸­æ–‡è½¬å†™')
    groqFormData.append('language', 'zh')  // å¼ºåˆ¶ä¸­æ–‡

    // 6. è°ƒç”¨ Groq APIï¼ˆèµ° OpenAI å…¼å®¹æ¥å£ï¼‰
    const groqApiKey = Deno.env.get('GROQ_API_KEY')
    if (!groqApiKey) {
      console.error('GROQ_API_KEY not configured')
      return new Response(
        JSON.stringify({ error: 'è½¬å†™æœåŠ¡æœªé…ç½®' }), 
        { status: 503, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    const groqResponse = await fetch('https://api.groq.com/openai/v1/audio/transcriptions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${groqApiKey}`,
      },
      body: groqFormData,
    })

    if (!groqResponse.ok) {
      const errorText = await groqResponse.text()
      console.error('Groq Error:', groqResponse.status, errorText)
      
      // æ ¹æ® Groq é”™è¯¯ç è¿”å›åˆé€‚çš„å“åº”
      if (groqResponse.status === 429) {
        return new Response(
          JSON.stringify({ error: 'Groq API è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•' }), 
          { status: 429, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
        )
      }
      
      return new Response(
        JSON.stringify({ error: 'è½¬å†™æœåŠ¡æš‚ä¸å¯ç”¨' }), 
        { status: 502, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      )
    }

    const data = await groqResponse.json()

    // 7. è®°å½•ä½¿ç”¨é‡ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡å“åº”ï¼‰
    // ä½¿ç”¨ EdgeRuntime.waitUntil ç¡®ä¿åå°ä»»åŠ¡å®Œæˆ
    const recordUsage = async () => {
      try {
        await supabaseAdmin.from('transcription_usage').insert({
          id: crypto.randomUUID(),
          user_id: user.id,
          date: today,
          audio_seconds: Math.round(audioFile.size / 16000)  // ä¼°ç®—ï¼šwebm opus çº¦ 16KB/s
        })
      } catch (e) {
        console.error('Failed to record usage:', e)
      }
    }
    // Deno Deploy æ”¯æŒ waitUntil
    // @ts-ignore - EdgeRuntime åœ¨ Supabase Edge Functions ä¸­å¯ç”¨
    if (typeof EdgeRuntime !== 'undefined' && EdgeRuntime.waitUntil) {
      EdgeRuntime.waitUntil(recordUsage())
    } else {
      // æœ¬åœ°å¼€å‘æ—¶åŒæ­¥æ‰§è¡Œ
      await recordUsage()
    }

    // 8. è¿”å›è½¬å†™åçš„æ–‡æœ¬ç»™ Angular
    return new Response(JSON.stringify({ text: data.text }), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      status: 200,
    })

  } catch (error: unknown) {
    console.error('Transcribe Error:', error)
    const message = error instanceof Error ? error.message : 'Unknown error'
    return new Response(JSON.stringify({ error: message }), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      status: 500,
    })
  }
})
```

**å…³é”®ç‚¹è¯´æ˜**ï¼š
- **Groq é€Ÿåº¦æå¿«**ï¼š`Thinking...` çŠ¶æ€é€šå¸¸åœ¨ 1-2 ç§’å†…ç»“æŸ
- **OpenAI å…¼å®¹æ¥å£**ï¼šGroq ä½¿ç”¨ `/openai/v1/audio/transcriptions`ï¼Œæ–¹ä¾¿è¿ç§»
- **å®‰å…¨éš”ç¦»**ï¼šGROQ_API_KEY å®‰å…¨åœ°èººåœ¨ Supabase ç¯å¢ƒå˜é‡é‡Œï¼Œå‰ç«¯åªè´Ÿè´£ä¼  Blob
- **é…é¢æ§åˆ¶**ï¼šæ¯ç”¨æˆ·æ¯æ—¥ 50 æ¬¡ï¼Œé˜²æ­¢æ»¥ç”¨

#### 2.4.7 å¼€æºå‚è€ƒ

| é¡¹ç›® | ç”¨é€” | é“¾æ¥ |
|------|------|------|
| Lobe Chat | è¯­éŸ³è¾“å…¥äº¤äº’å‚è€ƒ | [lobehub/lobe-chat](https://github.com/lobehub/lobe-chat) |
| use-whisper | React Whisperå°è£… | [chengsokdara/use-whisper](https://github.com/chengsokdara/use-whisper) |

---

## ä¸‰ã€UI ç»„ä»¶è§„èŒƒ

### 3.1 é›†æˆä½ç½®

åŸºäºç°æœ‰ UI ç»“æ„ï¼Œä¸“æ³¨æ¨¡å¼ç»„ä»¶å°†é›†æˆåœ¨ä¾§è¾¹æ åŒºåŸŸï¼š

```html
<!-- ç°æœ‰ç»“æ„ -->
<div class="flex-1 overflow-y-auto overflow-x-hidden p-3 flex flex-col gap-3">
  
  <!-- å¾…åŠäº‹é¡¹ï¼ˆä¿ç•™ï¼‰ -->
  <div class="rounded-xl bg-orange-50/60 dark:bg-stone-800/60">
    ...
  </div>
  
  <!-- å¾…åˆ†é…ï¼ˆä¿ç•™ï¼‰ -->
  <div class="rounded-xl bg-teal-50/60 dark:bg-stone-800/60">
    ...
  </div>
  
  <!-- ğŸ†• é»‘åŒ£å­ï¼ˆæ–°å¢ï¼‰ -->
  <div class="rounded-xl bg-amber-50/60 dark:bg-stone-800/60">
    ...
  </div>
  
  <!-- ğŸ†• åœ°è´¨å±‚ï¼ˆæ–°å¢ï¼‰ -->
  <div class="rounded-xl bg-stone-100/60 dark:bg-stone-800/60">
    ...
  </div>
  
</div>

<!-- ğŸ†• å¤§é—¨é®ç½©å±‚ï¼ˆå…¨å±€ï¼‰ -->
<div class="gate-overlay" *ngIf="gateService.isActive()">
  ...
</div>
```

### 3.2 è‰²å½©è§„èŒƒ

| æ¨¡å— | æµ…è‰²æ¨¡å¼ | æ·±è‰²æ¨¡å¼ | å¼ºè°ƒè‰² |
|------|----------|----------|--------|
| å¤§é—¨ | `bg-stone-50/95` | `bg-stone-800/95` | `stone-600` |
| èšå…‰ç¯ | `bg-white` | `bg-stone-900` | `blue-500` |
| åœ°è´¨å±‚ | `bg-stone-100/60` | `bg-stone-800/60` | `stone-400` |
| é»‘åŒ£å­ | `bg-amber-50/60` | `bg-stone-800/60` | `amber-500` |

### 3.3 åŠ¨ç”»è§„èŒƒ

```css
/* å¤§é—¨å…¥åœºï¼ˆå·¨çŸ³å è½æ„Ÿï¼‰ */
@keyframes gate-enter {
  0% {
    opacity: 0;
    transform: translateY(-40px) scale(0.98); /* ä»ä¸Šæ–¹å è½ */
  }
  60% {
    opacity: 1;
    transform: translateY(10px) scale(1.02); /* æ’å‡»å›å¼¹ */
  }
  100% {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

/* ä»»åŠ¡ä¸‹æ²‰åˆ°åœ°è´¨å±‚ */
@keyframes task-sink {
  from {
    opacity: 1;
    transform: translateY(0);
  }
  to {
    opacity: 0.7;
    transform: translateY(20px);
  }
}

/* ä¸‹ä¸€ä¸ªä»»åŠ¡æµ®ç° */
@keyframes task-emerge {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* å½•éŸ³æŒ‰é’®è„‰å†² */
@keyframes recording-pulse {
  0%, 100% {
    box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
  }
  50% {
    box-shadow: 0 0 0 12px rgba(239, 68, 68, 0);
  }
}
```

---

## å››ã€æ•°æ®æ¨¡å‹

### 4.1 é»‘åŒ£å­æ¡ç›®

```typescript
interface BlackBoxEntry {
  id: string;                    // crypto.randomUUID() - âš ï¸ å¿…é¡»å®¢æˆ·ç«¯ç”Ÿæˆï¼
  projectId: string;             // æ‰€å±é¡¹ç›®
  userId: string;                // æ‰€å±ç”¨æˆ·
  
  // å†…å®¹
  content: string;               // è½¬å†™æ–‡æœ¬
  
  // æ—¶é—´
  createdAt: string;             // ISO æ—¶é—´æˆ³
  date: string;                  // YYYY-MM-DD
  updatedAt: string;             // LWW å…³é”®
  
  // çŠ¶æ€
  isRead: boolean;
  isCompleted: boolean;
  isArchived: boolean;
  
  // ğŸ†• è·³è¿‡/ç¨åæé†’
  snoozeUntil?: string;          // ISO æ—¥æœŸï¼Œè·³è¿‡è‡³è¯¥æ—¥æœŸ
  snoozeCount?: number;          // å·²è·³è¿‡æ¬¡æ•°
  
  // è½¯åˆ é™¤
  deletedAt: string | null;
  
  // ğŸ†• ç¦»çº¿åŒæ­¥å…ƒæ•°æ®
  syncStatus?: 'pending' | 'synced' | 'conflict';
  localCreatedAt?: string;       // æœ¬åœ°åˆ›å»ºæ—¶é—´ï¼ˆç”¨äºç¦»çº¿æ’åºï¼‰
}
```

### 4.2 è½¬å†™ä½¿ç”¨é‡è¡¨ï¼ˆé…é¢æ§åˆ¶ï¼‰

```sql
-- è½¬å†™ API ä½¿ç”¨é‡è¿½è¸ªï¼ˆé˜²æ­¢æ»¥ç”¨ï¼‰
-- âš ï¸ æ³¨æ„ï¼šæ­¤è¡¨éœ€è¦ service_role æ‰èƒ½ç»•è¿‡ RLS è¿›è¡Œå¯é çš„é…é¢æ£€æŸ¥
CREATE TABLE transcription_usage (
  id UUID PRIMARY KEY,  -- âš ï¸ ç”± Edge Function ä½¿ç”¨ crypto.randomUUID() ç”Ÿæˆ
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  date DATE NOT NULL DEFAULT CURRENT_DATE,
  audio_seconds INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- æ¯æ—¥ä½¿ç”¨é‡ç´¢å¼•ï¼ˆç¡®ä¿åŒä¸€ç”¨æˆ·åŒä¸€å¤©åªèƒ½æœ‰å¤šæ¡è®°å½•ç”¨äºè®¡æ•°ï¼‰
CREATE INDEX idx_transcription_usage_user_date 
  ON transcription_usage(user_id, date);

-- RLS
-- âš ï¸ é‡è¦ï¼šEdge Function ä½¿ç”¨ service_role ç»•è¿‡ RLS è¿›è¡Œé…é¢æ£€æŸ¥å’Œè®°å½•
-- æ™®é€šç”¨æˆ·åªèƒ½è¯»å–è‡ªå·±çš„ä½¿ç”¨é‡ï¼ˆç”¨äºå‰ç«¯æ˜¾ç¤ºå‰©ä½™é…é¢ï¼‰
ALTER TABLE transcription_usage ENABLE ROW LEVEL SECURITY;

CREATE POLICY "ç”¨æˆ·åªèƒ½è¯»å–è‡ªå·±çš„ä½¿ç”¨é‡"
  ON transcription_usage FOR SELECT
  USING (auth.uid() = user_id);

-- INSERT/UPDATE/DELETE ç”± service_role æ‰§è¡Œï¼Œæ— éœ€ç”¨æˆ·ç­–ç•¥
```

### 4.3 æ•°æ®åº“ Schema

```sql
-- é»‘åŒ£å­æ¡ç›®è¡¨
-- âš ï¸ é‡è¦ï¼šç§»é™¤ DEFAULT gen_random_uuid()ï¼Œéµå¾ªé¡¹ç›®æ ¸å¿ƒè§„åˆ™
CREATE TABLE black_box_entries (
  id UUID PRIMARY KEY,  -- ç”±å®¢æˆ·ç«¯ crypto.randomUUID() ç”Ÿæˆ
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  
  content TEXT NOT NULL,
  
  date DATE NOT NULL DEFAULT CURRENT_DATE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  is_read BOOLEAN DEFAULT FALSE,
  is_completed BOOLEAN DEFAULT FALSE,
  is_archived BOOLEAN DEFAULT FALSE,
  
  -- è·³è¿‡/ç¨åæé†’
  snooze_until DATE DEFAULT NULL,
  snooze_count INTEGER DEFAULT 0,
  
  deleted_at TIMESTAMPTZ DEFAULT NULL
);

-- ç´¢å¼•
CREATE INDEX idx_black_box_user_date ON black_box_entries(user_id, date);
CREATE INDEX idx_black_box_project ON black_box_entries(project_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_black_box_pending ON black_box_entries(user_id, is_read, is_completed) 
  WHERE deleted_at IS NULL AND is_archived = FALSE;
-- å¢é‡åŒæ­¥ç´¢å¼•ï¼ˆä¸ç°æœ‰æ¶æ„ä¸€è‡´ï¼‰
CREATE INDEX idx_black_box_updated_at ON black_box_entries(updated_at);

-- updated_at è§¦å‘å™¨ï¼ˆä¸ç°æœ‰è¡¨ç»“æ„ä¸€è‡´ï¼‰
-- âš ï¸ å‰æï¼šupdate_updated_at_column() å‡½æ•°å·²åœ¨ init-supabase.sql ä¸­å®šä¹‰
DROP TRIGGER IF EXISTS update_black_box_entries_updated_at ON black_box_entries;
CREATE TRIGGER update_black_box_entries_updated_at
  BEFORE UPDATE ON black_box_entries
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- RLS - ä¸ç°æœ‰ tasks è¡¨ç­–ç•¥ä¿æŒä¸€è‡´
ALTER TABLE black_box_entries ENABLE ROW LEVEL SECURITY;

-- SELECTï¼šç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ¡ç›®ï¼Œæˆ–æ‰€å±é¡¹ç›®çš„æ¡ç›®
CREATE POLICY "black_box_select_policy" ON black_box_entries 
  FOR SELECT USING (
    auth.uid() = user_id OR
    project_id IN (
      SELECT id FROM projects WHERE owner_id = auth.uid()
      UNION
      SELECT project_id FROM project_members WHERE user_id = auth.uid()
    )
  );

-- INSERTï¼šç”¨æˆ·åªèƒ½åˆ›å»ºè‡ªå·±çš„æ¡ç›®
CREATE POLICY "black_box_insert_policy" ON black_box_entries
  FOR INSERT WITH CHECK (auth.uid() = user_id);

-- UPDATEï¼šç”¨æˆ·åªèƒ½æ›´æ–°è‡ªå·±çš„æ¡ç›®
CREATE POLICY "black_box_update_policy" ON black_box_entries
  FOR UPDATE USING (auth.uid() = user_id);

-- DELETEï¼šç”¨æˆ·åªèƒ½åˆ é™¤è‡ªå·±çš„æ¡ç›®
CREATE POLICY "black_box_delete_policy" ON black_box_entries
  FOR DELETE USING (auth.uid() = user_id);
```

### 4.4 ç”¨æˆ·åå¥½æ‰©å±•ï¼ˆğŸ†• æ–°å¢ï¼‰

```typescript
// æ‰©å±•ç°æœ‰ user_preferences.data JSONB
interface UserPreferencesData {
  // ... ç°æœ‰åå¥½
  focus?: FocusPreferences;
}

interface FocusPreferences {
  gateEnabled: boolean;           // æ˜¯å¦å¯ç”¨å¤§é—¨ï¼ˆé»˜è®¤ trueï¼‰
  spotlightEnabled: boolean;      // æ˜¯å¦å¯ç”¨èšå…‰ç¯æ¨¡å¼
  blackBoxEnabled: boolean;       // æ˜¯å¦å¯ç”¨é»‘åŒ£å­
  maxSnoozePerDay: number;        // æ¯æ—¥æœ€å¤§è·³è¿‡æ¬¡æ•°ï¼ˆé»˜è®¤ 3ï¼‰
}
```

### 4.5 çŠ¶æ€ç®¡ç†

```typescript
// stores.ts æ‰©å±•

// é»‘åŒ£å­çŠ¶æ€
export const blackBoxEntriesMap = signal<Map<string, BlackBoxEntry>>(new Map());
export const blackBoxEntriesByDate = signal<Map<string, Set<string>>>(new Map());

// å¤§é—¨çŠ¶æ€
export const gateState = signal<GateState>('checking');
export const gatePendingItems = signal<BlackBoxEntry[]>([]);
export const gateCurrentIndex = signal<number>(0);
export const gateSnoozeCount = signal<number>(0);  // ğŸ†• å½“æ—¥è·³è¿‡æ¬¡æ•°

// èšå…‰ç¯çŠ¶æ€
export const spotlightTask = signal<Task | null>(null);
export const isSpotlightMode = signal<boolean>(false);

// ğŸ†• ç”¨æˆ·åå¥½
export const focusPreferences = signal<FocusPreferences>({
  gateEnabled: true,
  spotlightEnabled: true,
  blackBoxEnabled: true,
  maxSnoozePerDay: 3
});

// è®¡ç®—å±æ€§
export const pendingBlackBoxEntries = computed(() => {
  const entries = Array.from(blackBoxEntriesMap().values());
  const yesterday = getYesterdayDate();
  const today = getTodayDate();
  
  return entries.filter(e => 
    e.date <= yesterday && 
    !e.isRead && 
    !e.isCompleted && 
    !e.isArchived &&
    !e.deletedAt &&
    // ğŸ†• æ’é™¤è¢«è·³è¿‡ä¸”æœªåˆ°æé†’æ—¥æœŸçš„æ¡ç›®
    (!e.snoozeUntil || e.snoozeUntil <= today)
  );
});

// ğŸ†• å¯è·³è¿‡æ£€æŸ¥
export const canSnooze = computed(() => {
  return gateSnoozeCount() < focusPreferences().maxSnoozePerDay;
});
```

---

## äº”ã€æœåŠ¡æ¶æ„

### 5.1 æ–°å¢æœåŠ¡

```
src/services/
â”œâ”€â”€ black-box.service.ts         # é»‘åŒ£å­ CRUD
â”œâ”€â”€ black-box-sync.service.ts    # é»‘åŒ£å­åŒæ­¥ï¼ˆéµå¾ª Offline-firstï¼‰
â”œâ”€â”€ gate.service.ts              # å¤§é—¨é€»è¾‘
â”œâ”€â”€ spotlight.service.ts         # èšå…‰ç¯é€»è¾‘
â”œâ”€â”€ strata.service.ts            # åœ°è´¨å±‚é€»è¾‘
â””â”€â”€ speech-to-text.service.ts    # è¯­éŸ³è½¬æ–‡å­—

src/app/features/focus/
â””â”€â”€ services/
    â””â”€â”€ focus-preference.service.ts  # ğŸ†• ä¸“æ³¨æ¨¡å¼åå¥½ç®¡ç†
```

### 5.2 æœåŠ¡èŒè´£

#### BlackBoxServiceï¼ˆğŸ†• è¡¥å……ç¦»çº¿åŒæ­¥é€»è¾‘ï¼‰

```typescript
@Injectable({ providedIn: 'root' })
export class BlackBoxService {
  private syncService = inject(BlackBoxSyncService);
  
  /**
   * åˆ›å»ºé»‘åŒ£å­æ¡ç›®
   * éµå¾ª Offline-firstï¼šæœ¬åœ°å†™å…¥ â†’ UI æ›´æ–° â†’ åå°æ¨é€
   */
  create(data: Partial<BlackBoxEntry>): Result<BlackBoxEntry, OperationError> {
    const entry: BlackBoxEntry = {
      id: crypto.randomUUID(),  // âš ï¸ å®¢æˆ·ç«¯ç”Ÿæˆ UUID
      projectId: this.projectState.currentProjectId()!,
      userId: this.auth.currentUserId()!,
      content: data.content ?? '',
      date: getTodayDate(),
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      isRead: false,
      isCompleted: false,
      isArchived: false,
      deletedAt: null,
      syncStatus: 'pending',  // ğŸ†• æ ‡è®°å¾…åŒæ­¥
      localCreatedAt: new Date().toISOString()
    };
    
    // 1. æœ¬åœ°å†™å…¥ IndexedDB
    this.localStorage.save('black_box_entries', entry);
    
    // 2. æ›´æ–°çŠ¶æ€
    blackBoxEntriesMap.update(map => {
      const newMap = new Map(map);
      newMap.set(entry.id, entry);
      return newMap;
    });
    
    // 3. åå°æ¨é€ï¼ˆé˜²æŠ– 3sï¼Œä¸ç°æœ‰æ¶æ„ä¸€è‡´ï¼‰
    this.syncService.scheduleSync(entry);
    
    return success(entry);
  }
  
  /**
   * æ›´æ–°æ¡ç›®
   */
  update(id: string, updates: Partial<BlackBoxEntry>): Result<void, OperationError> {
    const entry = blackBoxEntriesMap().get(id);
    if (!entry) {
      return failure(ErrorCodes.DATA_NOT_FOUND, 'æ¡ç›®ä¸å­˜åœ¨');
    }
    
    const updated = {
      ...entry,
      ...updates,
      updatedAt: new Date().toISOString()
    };
    
    // æœ¬åœ°ä¼˜å…ˆ
    this.localStorage.save('black_box_entries', updated);
    blackBoxEntriesMap.update(map => {
      const newMap = new Map(map);
      newMap.set(id, updated);
      return newMap;
    });
    
    // åå°åŒæ­¥
    this.syncService.scheduleSync(updated);
    
    return success(undefined);
  }
}
```

#### GateService

```typescript
@Injectable({ providedIn: 'root' })
export class GateService {
  private state = gateState;
  private pendingItems = gatePendingItems;
  private currentIndex = gateCurrentIndex;
  private snoozeCount = gateSnoozeCount;
  private preferences = inject(PreferenceService);
  private blackBoxService = inject(BlackBoxService);
  
  /**
   * æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºå¤§é—¨
   * ğŸ†• å°Šé‡ç”¨æˆ·åå¥½è®¾ç½®
   */
  checkGate(): void {
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç¦ç”¨äº†å¤§é—¨
    if (!focusPreferences().gateEnabled) {
      this.state.set('disabled');
      return;
    }
    
    const pending = pendingBlackBoxEntries();
    if (pending.length > 0) {
      this.pendingItems.set(pending);
      this.currentIndex.set(0);
      this.resetDailySnoozeCount();
      this.state.set('reviewing');
    } else {
      this.state.set('bypassed');
    }
  }
  
  // æ ‡è®°å½“å‰æ¡ç›®ä¸ºå·²è¯»
  markAsRead(): void {
    const current = this.getCurrentEntry();
    if (current) {
      this.blackBoxService.update(current.id, { isRead: true });
      this.nextEntry();
    }
  }
  
  // æ ‡è®°å½“å‰æ¡ç›®ä¸ºå®Œæˆ
  markAsCompleted(): void {
    const current = this.getCurrentEntry();
    if (current) {
      this.blackBoxService.update(current.id, { isCompleted: true });
      this.nextEntry();
    }
  }
  
  /**
   * ğŸ†• è·³è¿‡å½“å‰æ¡ç›®ï¼ˆç¨åæé†’ï¼‰
   */
  snooze(): Result<void, OperationError> {
    if (!canSnooze()) {
      return failure(ErrorCodes.QUOTA_EXCEEDED, 'ä»Šæ—¥è·³è¿‡æ¬¡æ•°å·²è¾¾ä¸Šé™');
    }
    
    const current = this.getCurrentEntry();
    if (current) {
      const tomorrow = getTomorrowDate();
      this.blackBoxService.update(current.id, { 
        snoozeUntil: tomorrow,
        snoozeCount: (current.snoozeCount ?? 0) + 1
      });
      this.snoozeCount.update(c => c + 1);
      this.nextEntry();
    }
    
    return success(undefined);
  }
  
  // åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ¡ç›®
  private nextEntry(): void {
    const nextIndex = this.currentIndex() + 1;
    if (nextIndex >= this.pendingItems().length) {
      this.state.set('completed');
    } else {
      this.currentIndex.set(nextIndex);
    }
  }
  
  /**
   * ğŸ†• é‡ç½®æ¯æ—¥è·³è¿‡æ¬¡æ•°ï¼ˆæ–°çš„ä¸€å¤©ï¼‰
   */
  private resetDailySnoozeCount(): void {
    const lastResetDate = localStorage.getItem('gate_snooze_reset_date');
    const today = getTodayDate();
    if (lastResetDate !== today) {
      this.snoozeCount.set(0);
      localStorage.setItem('gate_snooze_reset_date', today);
    }
  }
  
  // æ˜¯å¦å¤§é—¨æ¿€æ´»ä¸­
  isActive(): boolean {
    return this.state() === 'reviewing';
  }
  
  // ğŸ†• è·å–å½“å‰æ¡ç›®
  getCurrentEntry(): BlackBoxEntry | null {
    const items = this.pendingItems();
    const index = this.currentIndex();
    return items[index] ?? null;
  }
}
```

#### SpeechToTextServiceï¼ˆä½¿ç”¨ Supabase Edge Function è°ƒç”¨ Groqï¼‰

```typescript
// speech-to-text.service.ts
import { Injectable, signal, inject } from '@angular/core';
import { SupabaseClientService } from '../../services/supabase-client.service';
import { ToastService } from '../../services/toast.service';
import { NetworkAwarenessService } from '../../services/network-awareness.service';

@Injectable({ providedIn: 'root' })
export class SpeechToTextService {
  private supabaseClient = inject(SupabaseClientService);
  private toast = inject(ToastService);
  private network = inject(NetworkAwarenessService);
  
  private mediaRecorder: MediaRecorder | null = null;
  private audioChunks: Blob[] = [];
  
  // ä½¿ç”¨ Signal ç®¡ç†çŠ¶æ€ï¼Œç»„ä»¶ç›´æ¥è¯»å–
  isRecording = signal(false);
  isTranscribing = signal(false);
  offlinePendingCount = signal(0);  // ç¦»çº¿å¾…å¤„ç†æ•°é‡
  
  // IndexedDB å­˜å‚¨é”®
  private readonly IDB_STORE = 'offline_audio_cache';
  
  /**
   * å¼€å§‹å½•éŸ³
   * âš ï¸ iOS Safari å…¼å®¹æ€§ï¼šéœ€è¦åœ¨ç”¨æˆ·æ‰‹åŠ¿å†…è°ƒç”¨
   */
  async startRecording(): Promise<void> {
    try {
      // iOS Safari å…¼å®¹æ€§æ£€æŸ¥
      const mimeType = this.getSupportedMimeType();
      
      const stream = await navigator.mediaDevices.getUserMedia({ 
        audio: {
          echoCancellation: true,
          noiseSuppression: true,
          sampleRate: 16000  // Whisper æœ€ä½³é‡‡æ ·ç‡
        } 
      });
      
      this.mediaRecorder = new MediaRecorder(stream, {
        mimeType,
        audioBitsPerSecond: 128000
      });
      this.audioChunks = [];

      this.mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) {
          this.audioChunks.push(event.data);
        }
      };

      // æ¯ç§’æ”¶é›†ä¸€æ¬¡æ•°æ®ï¼Œé¿å…ä¸¢å¤±
      this.mediaRecorder.start(1000);
      this.isRecording.set(true);
    } catch (err) {
      console.error('æ— æ³•è°ƒç”¨éº¦å…‹é£', err);
      // æ›´å‹å¥½çš„é”™è¯¯æç¤º
      if (err instanceof DOMException) {
        if (err.name === 'NotAllowedError') {
          this.toast.show('è¯·å…è®¸éº¦å…‹é£æƒé™åé‡è¯•', 'error');
        } else if (err.name === 'NotFoundError') {
          this.toast.show('æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡', 'error');
        }
      }
      throw err;
    }
  }
  
  /**
   * è·å–æµè§ˆå™¨æ”¯æŒçš„éŸ³é¢‘æ ¼å¼
   * iOS Safari ä¸æ”¯æŒ webmï¼Œéœ€è¦ä½¿ç”¨ mp4
   */
  private getSupportedMimeType(): string {
    const types = [
      'audio/webm;codecs=opus',
      'audio/webm',
      'audio/mp4',
      'audio/ogg;codecs=opus',
      'audio/wav'
    ];
    
    for (const type of types) {
      if (MediaRecorder.isTypeSupported(type)) {
        return type;
      }
    }
    
    // é»˜è®¤ä¸æŒ‡å®šï¼Œè®©æµè§ˆå™¨é€‰æ‹©
    return '';
  }
  
  /**
   * åœæ­¢å½•éŸ³å¹¶è½¬å†™
   * ä½¿ç”¨ Supabase Edge Function è°ƒç”¨ Groq API
   */
  async stopAndTranscribe(): Promise<string> {
    return new Promise((resolve, reject) => {
      if (!this.mediaRecorder) {
        reject(new Error('æœªå¼€å§‹å½•éŸ³'));
        return;
      }

      this.mediaRecorder.onstop = async () => {
        this.isRecording.set(false);
        this.isTranscribing.set(true);

        const mimeType = this.mediaRecorder?.mimeType || 'audio/webm';
        const audioBlob = new Blob(this.audioChunks, { type: mimeType });
        
        // æ£€æŸ¥å½•éŸ³æ˜¯å¦å¤ªçŸ­
        if (audioBlob.size < 1000) {
          this.isTranscribing.set(false);
          this.toast.show('å½•éŸ³å¤ªçŸ­ï¼Œè¯·æŒ‰ä½ä¹…ä¸€ç‚¹', 'warning');
          resolve('');
          return;
        }

        try {
          // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
          if (!this.network.isOnline()) {
            // ç¦»çº¿ï¼šæš‚å­˜åˆ° IndexedDBï¼Œç¨åé‡è¯•
            await this.saveToOfflineCache(audioBlob);
            this.toast.show('å·²ä¿å­˜ï¼Œè”ç½‘åè‡ªåŠ¨è½¬å†™', 'info');
            resolve('[ç¦»çº¿å½•éŸ³ï¼Œç¨åè½¬å†™]');
            return;
          }
          
          // åœ¨çº¿ï¼šç›´æ¥è½¬å†™
          const text = await this.transcribeBlob(audioBlob);
          resolve(text);
        } catch (error) {
          console.error('è½¬å†™å¤±è´¥', error);
          
          // ç½‘ç»œé”™è¯¯æ—¶ä¹Ÿæš‚å­˜
          if (error instanceof TypeError && error.message.includes('fetch')) {
            await this.saveToOfflineCache(audioBlob);
            this.toast.show('ç½‘ç»œé”™è¯¯ï¼Œå·²ä¿å­˜å¾…é‡è¯•', 'warning');
            resolve('[è½¬å†™å¤±è´¥ï¼Œç¨åé‡è¯•]');
          } else {
            reject(error);
          }
        } finally {
          this.isTranscribing.set(false);
          // æ¸…ç†æµï¼Œé‡Šæ”¾éº¦å…‹é£
          this.mediaRecorder?.stream.getTracks().forEach(track => track.stop());
        }
      };

      this.mediaRecorder.stop();
    });
  }
  
  /**
   * å®é™…è°ƒç”¨ Edge Function è¿›è¡Œè½¬å†™
   */
  private async transcribeBlob(audioBlob: Blob): Promise<string> {
    const formData = new FormData();
    // æ ¹æ® mimeType è®¾ç½®æ­£ç¡®çš„æ–‡ä»¶æ‰©å±•å
    const ext = audioBlob.type.includes('mp4') ? 'mp4' : 'webm';
    formData.append('file', audioBlob, `recording.${ext}`);

    const { data, error } = await this.supabaseClient.client().functions.invoke('transcribe', {
      body: formData,
    });

    if (error) {
      // å¤„ç†ç‰¹å®šé”™è¯¯
      if (error.message?.includes('QUOTA_EXCEEDED')) {
        this.toast.show('ä»Šæ—¥è½¬å†™æ¬¡æ•°å·²è¾¾ä¸Šé™', 'warning');
        throw new Error('é…é¢å·²ç”¨å®Œ');
      }
      throw error;
    }
    
    return data.text;
  }
  
  /**
   * ç¦»çº¿æ—¶æš‚å­˜å½•éŸ³åˆ° IndexedDB
   */
  private async saveToOfflineCache(blob: Blob): Promise<void> {
    try {
      const db = await this.openIndexedDB();
      const tx = db.transaction(this.IDB_STORE, 'readwrite');
      const store = tx.objectStore(this.IDB_STORE);
      
      await store.add({
        id: crypto.randomUUID(),
        blob: blob,
        createdAt: new Date().toISOString(),
        mimeType: blob.type
      });
      
      this.offlinePendingCount.update(c => c + 1);
    } catch (e) {
      console.error('Failed to cache audio offline:', e);
    }
  }
  
  /**
   * ç½‘ç»œæ¢å¤åå¤„ç†ç¦»çº¿ç¼“å­˜
   */
  async processOfflineCache(): Promise<void> {
    if (!this.network.isOnline()) return;
    
    try {
      const db = await this.openIndexedDB();
      const tx = db.transaction(this.IDB_STORE, 'readonly');
      const store = tx.objectStore(this.IDB_STORE);
      const items = await store.getAll();
      
      for (const item of items) {
        try {
          const text = await this.transcribeBlob(item.blob);
          // TODO: åˆ›å»º BlackBoxEntry
          console.log('Offline transcription:', text);
          
          // åˆ é™¤å·²å¤„ç†çš„ç¼“å­˜
          const deleteTx = db.transaction(this.IDB_STORE, 'readwrite');
          await deleteTx.objectStore(this.IDB_STORE).delete(item.id);
          this.offlinePendingCount.update(c => Math.max(0, c - 1));
        } catch (e) {
          console.error('Failed to process offline item:', e);
        }
      }
    } catch (e) {
      console.error('Failed to process offline cache:', e);
    }
  }
  
  private async openIndexedDB(): Promise<IDBDatabase> {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open('focus_mode', 1);
      request.onerror = () => reject(request.error);
      request.onsuccess = () => resolve(request.result);
      request.onupgradeneeded = (event) => {
        const db = (event.target as IDBOpenDBRequest).result;
        if (!db.objectStoreNames.contains(this.IDB_STORE)) {
          db.createObjectStore(this.IDB_STORE, { keyPath: 'id' });
        }
      };
    });
  }
  
  /**
   * æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒå½•éŸ³
   */
  isSupported(): boolean {
    return !!(navigator.mediaDevices?.getUserMedia) && typeof MediaRecorder !== 'undefined';
  }
  
  /**
   * ğŸ†• è·å–ä¸æ”¯æŒæ—¶çš„é™çº§æ–¹æ¡ˆæç¤º
   */
  getFallbackMessage(): string {
    if (!this.isSupported()) {
      return 'å½“å‰æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³ï¼Œè¯·ä½¿ç”¨æ–‡å­—è¾“å…¥';
    }
    return '';
  }
}
```

**å…³é”®ç‚¹**ï¼š
- **ä½¿ç”¨ Supabase SDK**ï¼š`supabase.functions.invoke('transcribe')` è€Œéç›´æ¥ fetch
- **Signal çŠ¶æ€ç®¡ç†**ï¼š`isRecording` å’Œ `isTranscribing` ç›´æ¥æš´éœ²ç»™ç»„ä»¶
- **è‡ªåŠ¨æ¸…ç†**ï¼šå½•éŸ³åœæ­¢åç«‹å³é‡Šæ”¾éº¦å…‹é£èµ„æº
- **æ•°æ®æµå‘**ï¼šMic â†’ Browser Blob â†’ Edge Function â†’ Groq â†’ Text â†’ Browser â†’ å­˜å…¥ DB

---

## å…­ã€ç»„ä»¶ç»“æ„

### 6.1 æ–°å¢ç»„ä»¶

```
src/app/features/focus/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ gate/
â”‚   â”‚   â”œâ”€â”€ gate-overlay.component.ts      # å¤§é—¨é®ç½©
â”‚   â”‚   â”œâ”€â”€ gate-card.component.ts         # å¤§é—¨å¡ç‰‡
â”‚   â”‚   â””â”€â”€ gate-actions.component.ts      # å¤§é—¨æŒ‰é’®ç»„
â”‚   â”‚
â”‚   â”œâ”€â”€ spotlight/
â”‚   â”‚   â”œâ”€â”€ spotlight-view.component.ts    # èšå…‰ç¯è§†å›¾
â”‚   â”‚   â””â”€â”€ spotlight-card.component.ts    # èšå…‰ç¯ä»»åŠ¡å¡
â”‚   â”‚
â”‚   â”œâ”€â”€ strata/
â”‚   â”‚   â”œâ”€â”€ strata-view.component.ts       # åœ°è´¨å±‚è§†å›¾
â”‚   â”‚   â”œâ”€â”€ strata-layer.component.ts      # å•æ—¥å±‚
â”‚   â”‚   â””â”€â”€ strata-item.component.ts       # å•ä¸ªå·²å®Œæˆé¡¹
â”‚   â”‚
â”‚   â””â”€â”€ black-box/
â”‚       â”œâ”€â”€ black-box-panel.component.ts   # é»‘åŒ£å­é¢æ¿
â”‚       â”œâ”€â”€ black-box-recorder.component.ts # å½•éŸ³æŒ‰é’®
â”‚       â”œâ”€â”€ black-box-entry.component.ts   # å•ä¸ªæ¡ç›®
â”‚       â””â”€â”€ black-box-date-group.component.ts # æ—¥æœŸåˆ†ç»„
â”‚
â””â”€â”€ services/
    â”œâ”€â”€ gate.service.ts
    â”œâ”€â”€ spotlight.service.ts
    â”œâ”€â”€ strata.service.ts
    â””â”€â”€ speech-to-text.service.ts
```

### 6.2 é»‘åŒ£å­é¢æ¿ç»„ä»¶

```typescript
// black-box-panel.component.ts
@Component({
  selector: 'app-black-box-panel',
  standalone: true,
  imports: [CommonModule, BlackBoxRecorderComponent, BlackBoxEntryComponent],
  template: `
    <div class="rounded-xl bg-amber-50/60 dark:bg-stone-800/60 
                border border-amber-100/50 dark:border-stone-700/50 
                backdrop-blur-md overflow-hidden">
      
      <!-- æ ‡é¢˜æ  -->
      <div class="px-3 py-2.5 cursor-pointer flex justify-between items-center 
                  group select-none hover:bg-amber-100/30 dark:hover:bg-stone-700/30"
           (click)="toggleExpand()">
        <span class="font-bold text-stone-700 dark:text-stone-100 text-xs 
                     flex items-center gap-2">
          <span class="w-1.5 h-1.5 rounded-full bg-amber-500 
                       shadow-[0_0_6px_rgba(245,158,11,0.4)]"></span>
          ğŸ“¦ é»‘åŒ£å­
          @if (pendingCount() > 0) {
            <span class="bg-amber-500 text-white text-[9px] px-1.5 py-0.5 
                         rounded-full font-mono">
              {{ pendingCount() }}
            </span>
          }
        </span>
        <span class="text-stone-300 dark:text-stone-500 text-[10px] 
                     transition-transform duration-300"
              [class.rotate-180]="isExpanded()">
          â–¼
        </span>
      </div>
      
      <!-- å†…å®¹åŒº -->
      @if (isExpanded()) {
        <div class="px-2 pb-2 animate-slide-down">
          
          <!-- å½•éŸ³æŒ‰é’® -->
          <app-black-box-recorder 
            (transcribed)="onTranscribed($event)" />
          
          <!-- æ¡ç›®åˆ—è¡¨ï¼ˆæŒ‰æ—¥æœŸåˆ†ç»„ï¼‰ -->
          @for (group of entriesByDate(); track group.date) {
            <div class="mt-3">
              <div class="text-[10px] text-stone-400 dark:text-stone-500 
                          font-mono mb-1.5 px-1">
                {{ group.date | date:'yyyy-MM-dd' }}
              </div>
              
              @for (entry of group.entries; track entry.id) {
                <app-black-box-entry 
                  [entry]="entry"
                  (markRead)="onMarkRead(entry.id)"
                  (markCompleted)="onMarkCompleted(entry.id)"
                  (archive)="onArchive(entry.id)" />
              }
            </div>
          }
          
        </div>
      }
      
    </div>
  `,
  changeDetection: ChangeDetectionStrategy.OnPush
})
export class BlackBoxPanelComponent {
  private blackBoxService = inject(BlackBoxService);
  
  isExpanded = signal(true);
  entriesByDate = this.blackBoxService.entriesByDate;
  pendingCount = this.blackBoxService.pendingCount;
  
  toggleExpand(): void {
    this.isExpanded.update(v => !v);
  }
  
  onTranscribed(text: string): void {
    this.blackBoxService.create({ content: text });
  }
  
  onMarkRead(id: string): void {
    this.blackBoxService.update(id, { isRead: true });
  }
  
  onMarkCompleted(id: string): void {
    this.blackBoxService.update(id, { isCompleted: true });
  }
  
  onArchive(id: string): void {
    this.blackBoxService.update(id, { isArchived: true });
  }
}
```

### 6.3 å½•éŸ³æŒ‰é’®ç»„ä»¶ï¼ˆå¯¹è®²æœºäº¤äº’ï¼‰

```typescript
// black-box-recorder.component.ts
@Component({
  selector: 'app-black-box-recorder',
  standalone: true,
  template: `
    <div class="black-box-container">
      <!-- è½¬å†™ç»“æœå±•ç¤º -->
      @if (transcription()) {
        <div class="result-card mb-2 p-2 bg-amber-50 dark:bg-stone-700 rounded-lg text-xs">
          <p>{{ transcription() }}</p>
        </div>
      }

      <!-- å½•éŸ³æŒ‰é’®ï¼šç±»ä¼¼å¯¹è®²æœºçš„æŒ‰ä½è¯´è¯æ•ˆæœ -->
      <button 
        class="record-btn w-full px-4 py-5 rounded-lg transition-all
               flex items-center justify-center gap-2 text-sm font-medium
               select-none touch-none"
        [class.recording]="voiceService.isRecording()"
        [class.loading]="voiceService.isTranscribing()"
        [class]="voiceService.isRecording() 
          ? 'bg-red-500 text-white shadow-lg shadow-red-500/30 scale-[0.98]' 
          : voiceService.isTranscribing()
            ? 'bg-stone-200 dark:bg-stone-600 cursor-wait'
            : 'bg-amber-100/80 dark:bg-stone-700/80 text-amber-700 dark:text-amber-300 
               hover:bg-amber-200 dark:hover:bg-stone-600 border-2 border-dashed border-amber-300 dark:border-stone-500'"
        (mousedown)="start()" 
        (mouseup)="stop()"
        (mouseleave)="stop()" 
        (touchstart)="start()" 
        (touchend)="stop()">
        
        @if (voiceService.isTranscribing()) {
          <span class="animate-spin">â³</span>
          <span>Thinking...</span>
        } @else if (voiceService.isRecording()) {
          <span class="w-3 h-3 rounded-full bg-white animate-ping"></span>
          <span>Listening...</span>
        } @else {
          <span>ğŸ¤</span>
          <span>Hold to Dump Brain</span>
        }
      </button>
    </div>
  `,
  styles: [`
    /* å½•éŸ³æŒ‰é’®è„‰å†²æ•ˆæœ */
    .recording {
      animation: recording-pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes recording-pulse {
      0%, 100% {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
      }
      50% {
        box-shadow: 0 0 0 12px rgba(239, 68, 68, 0);
      }
    }
    
    /* é˜²æ­¢é•¿æŒ‰é€‰ä¸­æ–‡æœ¬ */
    .record-btn {
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
    }
  `],
  changeDetection: ChangeDetectionStrategy.OnPush
})
export class BlackBoxRecorderComponent {
  voiceService = inject(SpeechToTextService);
  transcription = signal('');
  
  @Output() transcribed = new EventEmitter<string>();

  start() {
    if (this.voiceService.isTranscribing()) return;
    this.voiceService.startRecording();
  }

  async stop() {
    if (!this.voiceService.isRecording()) return;
    
    try {
      // åœæ­¢å½•éŸ³å¹¶ç«‹åˆ»è§¦å‘è½¬å†™
      const text = await this.voiceService.stopAndTranscribe();
      // æ›´æ–°æœ¬åœ°çŠ¶æ€ç”¨äºå±•ç¤º
      this.transcription.set(text);
      // é€šçŸ¥çˆ¶ç»„ä»¶
      if (text.trim()) {
        this.transcribed.emit(text);
        // TODO: è¿™é‡Œå¯ä»¥ç›´æ¥è°ƒç”¨ BlackBoxService å­˜å…¥æ•°æ®åº“
        // this.blackBoxService.create({ content: text });
      }
    } catch (e) {
      console.error('Failed', e);
    }
  }
}
```

**å…³é”®è®¾è®¡ç‚¹**ï¼š
- **OnPush ä¸ Signals**ï¼šçŠ¶æ€å˜åŒ–è‡ªåŠ¨è§¦å‘ UI åˆ·æ–°ï¼Œæ— éœ€æ‰‹åŠ¨ `detectChanges`
- **å¯¹è®²æœºäº¤äº’**ï¼šæŒ‰ä½è¯´è¯ã€æ¾å¼€è½¬å†™ï¼Œ`Thinking...` çŠ¶æ€æçŸ­ï¼ˆ1-2 ç§’ï¼‰
- **é˜²è¯¯è§¦**ï¼š`user-select: none` + `touch-callout: none` é˜²æ­¢é•¿æŒ‰é€‰ä¸­æ–‡æœ¬
- **æ•°æ®æµå‘**ï¼šMic â†’ Browser Blob â†’ Edge Function â†’ Groq â†’ Text â†’ Browser â†’ å­˜å…¥ DB

---

## ä¸ƒã€é…ç½®å¸¸é‡

```typescript
// src/config/focus.config.ts

export const FOCUS_CONFIG = {
  // å¤§é—¨é…ç½®
  GATE: {
    // æ£€æŸ¥é—ç•™æ¡ç›®çš„æ—¶é—´èŒƒå›´ï¼ˆå¤©ï¼‰
    PENDING_DAYS_RANGE: 7,
    // åŠ¨ç”»æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
    TRANSITION_DURATION: 300,
  },
  
  // èšå…‰ç¯é…ç½®
  SPOTLIGHT: {
    // ä»»åŠ¡å®Œæˆåå»¶è¿Ÿæ˜¾ç¤ºä¸‹ä¸€ä¸ªï¼ˆæ¯«ç§’ï¼‰
    NEXT_TASK_DELAY: 500,
    // èƒŒæ™¯åœ°è´¨å±‚é€æ˜åº¦
    STRATA_BACKGROUND_OPACITY: 0.3,
  },
  
  // åœ°è´¨å±‚é…ç½®
  STRATA: {
    // æ˜¾ç¤ºçš„æœ€å¤§å¤©æ•°
    MAX_DISPLAY_DAYS: 30,
    // é€æ˜åº¦è¡°å‡ç³»æ•°
    OPACITY_DECAY: 0.15,
    // æœ€å°é€æ˜åº¦
    MIN_OPACITY: 0.3,
  },
  
  // é»‘åŒ£å­é…ç½®
  BLACK_BOX: {
    // å½•éŸ³æœ€å¤§æ—¶é•¿ï¼ˆç§’ï¼‰
    MAX_RECORDING_DURATION: 120,
    // è½¬å†™ API è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰- Groq æå¿«ï¼Œé€šå¸¸ 1-2 ç§’
    TRANSCRIBE_TIMEOUT: 10000,
    // æ¡ç›®æ¯æ—¥æ˜¾ç¤ºä¸Šé™
    MAX_ENTRIES_PER_DAY: 50,
  },
  
  // è¯­éŸ³è½¬æ–‡å­—é…ç½®ï¼ˆGroq + whisper-large-v3ï¼‰
  SPEECH_TO_TEXT: {
    // ğŸ†• Groq ä½¿ç”¨çš„æ¨¡å‹ï¼ˆç›®å‰æœ€å¼ºçš„å¼€æºæ¨¡å‹ï¼‰
    MODEL: 'whisper-large-v3',
    // è¯­è¨€
    LANGUAGE: 'zh',
    // éŸ³é¢‘æ ¼å¼
    AUDIO_MIME_TYPE: 'audio/webm;codecs=opus',
    // æ¯æ—¥é…é¢é™åˆ¶
    DAILY_QUOTA: 50,
    // ğŸ†• Edge Function åç§°
    EDGE_FUNCTION_NAME: 'transcribe',
    // ğŸ†• Groq API ç«¯ç‚¹ï¼ˆä»…åœ¨ Edge Function ä¸­ä½¿ç”¨ï¼‰
    GROQ_API_ENDPOINT: 'https://api.groq.com/openai/v1/audio/transcriptions',
  },
  
  // åŒæ­¥é…ç½®ï¼ˆä¸ä¸»æ¶æ„å¯¹é½ï¼‰
  SYNC: {
    // é˜²æŠ–å»¶è¿Ÿï¼ˆä¸ SYNC_CONFIG.DEBOUNCE_DELAY ä¸€è‡´ï¼‰
    DEBOUNCE_DELAY: 3000,
    // IndexedDB å­˜å‚¨é”®å‰ç¼€
    IDB_PREFIX: 'focus_',
  },
} as const;

// é”™è¯¯ç 
export const FocusErrorCodes = {
  QUOTA_EXCEEDED: 'FOCUS_QUOTA_EXCEEDED',
  TRANSCRIBE_FAILED: 'FOCUS_TRANSCRIBE_FAILED',
  RECORDING_NOT_SUPPORTED: 'FOCUS_RECORDING_NOT_SUPPORTED',
  RECORDING_PERMISSION_DENIED: 'FOCUS_RECORDING_PERMISSION_DENIED',
} as const;
```

---

## å…«ã€å®ç°è·¯çº¿å›¾

### Phase 0: å‡†å¤‡å·¥ä½œ

- [ ] åœ¨ `src/utils/result.ts` ä¸­æ·»åŠ ä¸“æ³¨æ¨¡å¼é”™è¯¯ç 
- [ ] åœ¨ `src/models/index.ts` ä¸­æ·»åŠ  `BlackBoxEntry` ç±»å‹å®šä¹‰
- [ ] åˆ›å»º Edge Function `supabase/functions/transcribe`
- [ ] åœ¨ Supabase æ·»åŠ  `GROQ_API_KEY` ç¯å¢ƒå˜é‡ï¼š`supabase secrets set GROQ_API_KEY=gsk_xxx`
- [ ] éƒ¨ç½² Edge Functionï¼š`supabase functions deploy transcribe`
- [ ] åˆ›å»º `transcription_usage` è¡¨ï¼ˆé…é¢æ§åˆ¶ï¼‰

### Phase 1: é»‘åŒ£å­åŸºç¡€åŠŸèƒ½ï¼ˆ1-2 å‘¨ï¼‰

- [ ] åˆ›å»º `black_box_entries` æ•°æ®åº“è¡¨
- [ ] å®ç° `BlackBoxService` CRUDï¼ˆå«ç¦»çº¿åŒæ­¥ï¼‰
- [ ] å®ç° `BlackBoxSyncService` åŒæ­¥é€»è¾‘
- [ ] å®ç° `SpeechToTextService` å½•éŸ³åŠŸèƒ½
- [ ] é›†æˆ Groq API è½¬å†™ï¼ˆé€šè¿‡ Edge Functionï¼‰
- [ ] å®Œæˆ `BlackBoxPanelComponent` UI
- [ ] å®Œæˆ `BlackBoxRecorderComponent` å½•éŸ³æŒ‰é’®
- [ ] å®ç°æ–‡å­—è¾“å…¥é™çº§æ–¹æ¡ˆ

### Phase 2: å¤§é—¨æœºåˆ¶ï¼ˆ1 å‘¨ï¼‰

- [ ] å®ç° `GateService` çŠ¶æ€ç®¡ç†
- [ ] å®Œæˆ `GateOverlayComponent` é®ç½©å±‚
- [ ] å®Œæˆ `GateCardComponent` æ¡ç›®å±•ç¤º
- [ ] å®ç°æ¯æ—¥é¦–æ¬¡æ‰“å¼€æ£€æµ‹é€»è¾‘
- [ ] æ·»åŠ å·²è¯»/å®ŒæˆæŒ‰é’®äº¤äº’
- [ ] æ·»åŠ "ç¨åæé†’"åŠŸèƒ½
- [ ] æ·»åŠ ç”¨æˆ·åå¥½è®¾ç½®ï¼ˆå¯ç¦ç”¨å¤§é—¨ï¼‰

### Phase 3: èšå…‰ç¯æ¨¡å¼ï¼ˆ1 å‘¨ï¼‰

- [ ] å®ç° `SpotlightService` ä»»åŠ¡é€‰æ‹©é€»è¾‘
- [ ] å®Œæˆ `SpotlightViewComponent` å•ä»»åŠ¡ç•Œé¢
- [ ] å®ç°ä»»åŠ¡å®ŒæˆåŠ¨ç”»
- [ ] æ·»åŠ ä¸å¾…åŠäº‹é¡¹çš„è”åŠ¨
- [ ] å®ç°ä¸ç°æœ‰ä»»åŠ¡ç³»ç»Ÿçš„æ•°æ®è”åŠ¨

### Phase 4: åœ°è´¨å±‚å¯è§†åŒ–ï¼ˆ1 å‘¨ï¼‰

- [ ] å®ç° `StrataService` å†å²èšåˆ
- [ ] å®Œæˆ `StrataViewComponent` åˆ†å±‚æ˜¾ç¤º
- [ ] å®ç°é€æ˜åº¦æ¸å˜æ•ˆæœ
- [ ] æ·»åŠ æ»šåŠ¨å±•å¼€äº¤äº’
- [ ] é›†æˆç°æœ‰å·²å®Œæˆä»»åŠ¡æ•°æ®

### Phase 5: æ•´åˆä¸ä¼˜åŒ–ï¼ˆ1 å‘¨ï¼‰

- [ ] æ¨¡å—é—´çŠ¶æ€è”åŠ¨æµ‹è¯•
- [ ] ç§»åŠ¨ç«¯ PWA é€‚é…
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] E2E æµ‹è¯•è¦†ç›–
- [ ] å¯è®¿é—®æ€§æµ‹è¯•ï¼ˆé”®ç›˜å¯¼èˆªã€å±å¹•é˜…è¯»å™¨ï¼‰
- [ ] ç¦»çº¿åŠŸèƒ½æµ‹è¯•

---

## ä¹ã€é£é™©ä¸ç¼“è§£

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| Groq API æˆæœ¬ | é«˜é¢‘ä½¿ç”¨äº§ç”Ÿè´¹ç”¨ | â‘  æ¯æ—¥é…é¢é™åˆ¶ï¼ˆ50æ¬¡/ç”¨æˆ·ï¼‰â‘¡ Groq æ¯” OpenAI æ›´ä¾¿å®œ |
| Groq æœåŠ¡å¯ç”¨æ€§ | æœåŠ¡ä¸­æ–­ | â‘  ç›‘æ§ Edge Function æ—¥å¿— â‘¡ å¤‡é€‰ï¼šOpenAI Whisper é™çº§ |
| æµè§ˆå™¨å½•éŸ³å…¼å®¹æ€§ | iOS Safari é™åˆ¶ | â‘  æ£€æµ‹æ”¯æŒæƒ…å†µ â‘¡ é™çº§ä¸ºæ‰‹åŠ¨æ–‡å­—è¾“å…¥ |
| å¤§é—¨é˜»å¡ä½“éªŒ | ç”¨æˆ·çƒ¦èºè·³è¿‡ | â‘  æ·»åŠ "ç¨åæé†’"ï¼ˆæ¯æ—¥ä¸Šé™3æ¬¡ï¼‰â‘¡ ç”¨æˆ·å¯åœ¨è®¾ç½®ä¸­ç¦ç”¨ |
| è½¬å†™å‡†ç¡®åº¦ | å…³é”®è¯è¯†åˆ«é”™è¯¯ | â‘  prompt å¼•å¯¼ä¸­æ–‡è¾“å‡º â‘¡ å…è®¸æ‰‹åŠ¨ç¼–è¾‘è½¬å†™ç»“æœ |
| ç¦»çº¿å½•éŸ³ | æ–­ç½‘æ—¶æ— æ³•è½¬å†™ | â‘  éŸ³é¢‘æš‚å­˜ IndexedDB â‘¡ æ¢å¤ç½‘ç»œåè‡ªåŠ¨é‡è¯• |
| API Key æ³„éœ² | å®‰å…¨é£é™© | â‘  é€šè¿‡ Edge Function ä»£ç† â‘¡ æ°¸ä¸æš´éœ²åœ¨å‰ç«¯ â‘¢ ä½¿ç”¨ `supabase secrets` |
| æ•°æ®ä¸€è‡´æ€§ | å¤šè®¾å¤‡åŒæ­¥å†²çª | â‘  LWW ç­–ç•¥ â‘¡ ä¸ç°æœ‰åŒæ­¥æ¶æ„ä¿æŒä¸€è‡´ |

---

## åã€éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- [ ] é¦–æ¬¡æ‰“å¼€åº”ç”¨æ—¶ï¼Œè‹¥æœ‰æ˜¨æ—¥æœªå¤„ç†æ¡ç›®ï¼Œå¤§é—¨æ­£ç¡®é˜»å¡
- [ ] å¤§é—¨ä¸­æ‰€æœ‰æ¡ç›®å¤„ç†å®Œæ¯•åï¼Œè‡ªåŠ¨è¿›å…¥ä¸»ç•Œé¢
- [ ] ç”¨æˆ·å¯åœ¨è®¾ç½®ä¸­ç¦ç”¨å¤§é—¨åŠŸèƒ½
- [ ] "ç¨åæé†’"åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼Œæ¯æ—¥ä¸Šé™ç”Ÿæ•ˆ
- [ ] é»‘åŒ£å­å½•éŸ³æŒ‰é’®æŒ‰ä½è¯´è¯ã€æ¾å¼€è½¬æ–‡å­—
- [ ] ä¸æ”¯æŒå½•éŸ³çš„æµè§ˆå™¨æ˜¾ç¤ºæ–‡å­—è¾“å…¥æ¡†
- [ ] è½¬å†™æ–‡æœ¬æ­£ç¡®å­˜å‚¨å¹¶æŒ‰æ—¥æœŸåˆ†ç»„æ˜¾ç¤º
- [ ] è¾¾åˆ°æ¯æ—¥é…é¢åæ˜¾ç¤ºå‹å¥½æç¤º
- [ ] æ¡ç›®çŠ¶æ€ï¼ˆå·²è¯»/å®Œæˆ/å½’æ¡£ï¼‰æ­£ç¡®åˆ‡æ¢
- [ ] èšå…‰ç¯æ¨¡å¼åªæ˜¾ç¤ºå•ä¸ªä¼˜å…ˆä»»åŠ¡
- [ ] åœ°è´¨å±‚æ­£ç¡®å †å æ˜¾ç¤ºå†å²å®Œæˆä»»åŠ¡

### æ€§èƒ½éªŒæ”¶

- [ ] å½•éŸ³å¯åŠ¨å»¶è¿Ÿ < 500ms
- [ ] **Groq è½¬å†™å“åº”æ—¶é—´ < 3s**ï¼ˆ60ç§’éŸ³é¢‘ï¼Œæ¯” OpenAI å¿« 5-10 å€ï¼‰
- [ ] å¤§é—¨åŠ¨ç”»æµç•…ï¼Œæ— å¡é¡¿
- [ ] åœ°è´¨å±‚æ»šåŠ¨æµç•…
- [ ] ç¦»çº¿æ—¶é»‘åŒ£å­æ¡ç›®å¯æ­£å¸¸åˆ›å»º

### å…¼å®¹æ€§éªŒæ”¶

- [ ] Chrome / Edge / Safari æ¡Œé¢ç«¯æ­£å¸¸
- [ ] iOS Safari PWA æ­£å¸¸ï¼ˆå«é™çº§æ–¹æ¡ˆï¼‰
- [ ] Android Chrome PWA æ­£å¸¸
- [ ] é”®ç›˜å¯¼èˆªæ­£å¸¸ï¼ˆTab/Enter/Escapeï¼‰
- [ ] å±å¹•é˜…è¯»å™¨å‹å¥½

### å®‰å…¨éªŒæ”¶

- [ ] GROQ_API_KEY ä¸æš´éœ²åœ¨å‰ç«¯ä»£ç ä¸­
- [ ] Edge Function æ­£ç¡®æ ¡éªŒç”¨æˆ·èº«ä»½
- [ ] é…é¢é™åˆ¶ç”Ÿæ•ˆï¼Œé˜²æ­¢æ»¥ç”¨

---

## åä¸€ã€ä¸ç°æœ‰ç³»ç»Ÿçš„é›†æˆï¼ˆğŸ†• æ–°å¢ç« èŠ‚ï¼‰

### 11.1 æ•°æ®è¿ç§»ç­–ç•¥

ä¸“æ³¨æ¨¡å¼ä¸éœ€è¦è¿ç§»ç°æœ‰æ•°æ®ï¼Œä½†éœ€è¦ä¸ç°æœ‰ä»»åŠ¡ç³»ç»Ÿè”åŠ¨ï¼š

```typescript
// èšå…‰ç¯ä»»åŠ¡æ¥æºä¼˜å…ˆçº§
function getSpotlightTask(): Task | null {
  // 1. é»‘åŒ£å­ä¸­"å·²è¯»æœªå®Œæˆ"çš„æ¡ç›®ï¼ˆè½¬æ¢ä¸ºè™šæ‹Ÿä»»åŠ¡ï¼‰
  const pendingBlackBox = getUncompletedReadEntries();
  if (pendingBlackBox.length > 0) {
    return convertBlackBoxToTask(pendingBlackBox[0]);
  }
  
  // 2. ç°æœ‰ä»»åŠ¡ç³»ç»Ÿä¸­çš„å¾…åŠä»»åŠ¡
  const todoTasks = tasksMap().values()
    .filter(t => t.status === 'active' && !t.deletedAt)
    .sort((a, b) => a.order - b.order);
  
  if (todoTasks.length > 0) {
    return todoTasks[0];
  }
  
  return null;
}
```

### 11.2 åœ°è´¨å±‚æ•°æ®æ¥æº

åœ°è´¨å±‚éœ€è¦æ•´åˆä¸¤ä¸ªæ•°æ®æºï¼š
1. é»‘åŒ£å­ä¸­æ ‡è®°ä¸º"å®Œæˆ"çš„æ¡ç›®
2. ç°æœ‰ä»»åŠ¡ç³»ç»Ÿä¸­ `status === 'completed'` çš„ä»»åŠ¡

```typescript
interface StrataItem {
  type: 'black_box' | 'task';
  id: string;
  title: string;
  completedAt: string;
  source: BlackBoxEntry | Task;
}

function getStrataItems(date: string): StrataItem[] {
  const blackBoxItems = getCompletedBlackBoxEntries(date)
    .map(e => ({ type: 'black_box', id: e.id, title: e.content, completedAt: e.updatedAt, source: e }));
  
  const taskItems = getCompletedTasks(date)
    .map(t => ({ type: 'task', id: t.id, title: t.title, completedAt: t.updatedAt, source: t }));
  
  return [...blackBoxItems, ...taskItems]
    .sort((a, b) => new Date(b.completedAt).getTime() - new Date(a.completedAt).getTime());
}
```

### 11.3 IndexedDB å­˜å‚¨ç»“æ„

```typescript
// æ–°å¢ IndexedDB Object Store
const FOCUS_STORES = {
  BLACK_BOX_ENTRIES: 'black_box_entries',
  FOCUS_PREFERENCES: 'focus_preferences',
  TRANSCRIPTION_CACHE: 'transcription_cache'  // ç¦»çº¿æ—¶æš‚å­˜éŸ³é¢‘
};

// ä¸ç°æœ‰ IndexedDB ç»“æ„ä¿æŒä¸€è‡´
interface FocusDatabase {
  black_box_entries: {
    key: string;  // entry.id
    value: BlackBoxEntry;
    indexes: {
      'by-date': string;
      'by-updated': string;
      'by-sync-status': string;
    };
  };
}
```

### 11.4 åŒæ­¥ç­–ç•¥

é»‘åŒ£å­åŒæ­¥éµå¾ªç°æœ‰æ¶æ„ï¼š

```typescript
// ä¸ SimpleSyncService ä¿æŒä¸€è‡´çš„åŒæ­¥ç­–ç•¥
class BlackBoxSyncService {
  // å¢é‡æ‹‰å–ï¼šupdated_at > last_sync_time
  async pullChanges(): Promise<void> {
    const lastSync = await this.getLastSyncTime('black_box');
    const { data } = await supabase
      .from('black_box_entries')
      .select('*')
      .gt('updated_at', lastSync)
      .order('updated_at', { ascending: true });
    
    // åˆå¹¶åˆ°æœ¬åœ° IndexedDB
    for (const entry of data ?? []) {
      await this.mergeWithLocal(entry);
    }
  }
  
  // å†²çªè§£å†³ï¼šLWW
  private async mergeWithLocal(remote: BlackBoxEntry): Promise<void> {
    const local = await this.localStorage.get(remote.id);
    if (!local || remote.updatedAt > local.updatedAt) {
      await this.localStorage.save(remote);
      this.updateSignal(remote);
    }
  }
}
```

---

## åäºŒã€å¯è®¿é—®æ€§è®¾è®¡ï¼ˆğŸ†• æ–°å¢ç« èŠ‚ï¼‰

### 12.1 é”®ç›˜å¯¼èˆª

| å…ƒç´  | å¿«æ·é”® | è¡Œä¸º |
|------|--------|------|
| å¤§é—¨ | `1` / `Enter` | æ ‡è®°å·²è¯» |
| å¤§é—¨ | `2` / `Space` | æ ‡è®°å®Œæˆ |
| å¤§é—¨ | `3` / `S` | ç¨åæé†’ |
| å¤§é—¨ | `Escape` | æ— æ“ä½œï¼ˆä¸å…è®¸å…³é—­ï¼‰ |
| å½•éŸ³æŒ‰é’® | `Space` (é•¿æŒ‰) | å¼€å§‹/åœæ­¢å½•éŸ³ |
| é»‘åŒ£å­æ¡ç›® | `R` | å·²è¯» |
| é»‘åŒ£å­æ¡ç›® | `C` | å®Œæˆ |
| é»‘åŒ£å­æ¡ç›® | `A` | å½’æ¡£ |

### 12.2 ARIA æ ‡ç­¾

```html
<!-- å¤§é—¨é®ç½© -->
<div role="dialog" 
     aria-modal="true" 
     aria-labelledby="gate-title"
     aria-describedby="gate-description">
  <h2 id="gate-title">æ˜¨æ—¥é—ç•™äº‹é¡¹</h2>
  <p id="gate-description">è¯·å¤„ç†ä»¥ä¸‹é—ç•™äº‹é¡¹åç»§ç»­</p>
</div>

<!-- å½•éŸ³æŒ‰é’® -->
<button [attr.aria-pressed]="isRecording()"
        [attr.aria-label]="isRecording() ? 'æ¾å¼€åœæ­¢å½•éŸ³' : 'æŒ‰ä½å¼€å§‹å½•éŸ³'"
        role="switch">
</button>

<!-- åœ°è´¨å±‚ -->
<section role="feed" aria-label="å·²å®Œæˆäº‹é¡¹å†å²">
  <article role="article" *ngFor="let item of items">
    ...
  </article>
</section>
```

### 12.3 å±å¹•é˜…è¯»å™¨æ”¯æŒ

- å¤§é—¨å‡ºç°æ—¶è‡ªåŠ¨èšç„¦ï¼Œæ’­æŠ¥"æ˜¨æ—¥é—ç•™ X é¡¹å¾…å¤„ç†"
- å½•éŸ³çŠ¶æ€å˜åŒ–æ—¶æ’­æŠ¥"å¼€å§‹å½•éŸ³"/"å½•éŸ³ç»“æŸï¼Œæ­£åœ¨è½¬å†™"
- æ¡ç›®å¤„ç†åæ’­æŠ¥"å·²æ ‡è®°ä¸ºå·²è¯»"/"å·²æ ‡è®°ä¸ºå®Œæˆ"

---

## åä¸‰ã€æµ‹è¯•ç­–ç•¥ï¼ˆğŸ†• æ–°å¢ç« èŠ‚ï¼‰

### 13.1 å•å…ƒæµ‹è¯•

```typescript
// black-box.service.spec.ts
describe('BlackBoxService', () => {
  it('should create entry with client-generated UUID', () => {
    const entry = service.create({ content: 'test' });
    expect(entry.ok).toBe(true);
    expect(entry.value.id).toMatch(/^[0-9a-f-]{36}$/);
  });
  
  it('should mark entry as pending sync when offline', () => {
    networkService.setOffline(true);
    const entry = service.create({ content: 'offline test' });
    expect(entry.value.syncStatus).toBe('pending');
  });
});

// gate.service.spec.ts
describe('GateService', () => {
  it('should respect user preference to disable gate', () => {
    focusPreferences.set({ gateEnabled: false, ... });
    service.checkGate();
    expect(service.isActive()).toBe(false);
  });
  
  it('should limit snooze count per day', () => {
    // è·³è¿‡ 3 æ¬¡ååº”è¯¥å¤±è´¥
    for (let i = 0; i < 3; i++) {
      expect(service.snooze().ok).toBe(true);
    }
    expect(service.snooze().ok).toBe(false);
  });
});
```

### 13.2 E2E æµ‹è¯•

```typescript
// e2e/focus-mode.spec.ts
test('gate blocks entry until all items processed', async ({ page }) => {
  // å‡†å¤‡ï¼šåˆ›å»ºæ˜¨æ—¥æœªå¤„ç†æ¡ç›®
  await seedBlackBoxEntries([
    { date: yesterday, isRead: false, isCompleted: false }
  ]);
  
  // æ‰“å¼€åº”ç”¨
  await page.goto('/');
  
  // éªŒè¯å¤§é—¨æ˜¾ç¤º
  await expect(page.locator('.gate-overlay')).toBeVisible();
  
  // æ— æ³•ç‚¹å‡»èƒŒæ™¯å†…å®¹
  await expect(page.locator('.main-content')).toHaveCSS('pointer-events', 'none');
  
  // å¤„ç†æ¡ç›®
  await page.click('[data-action="mark-read"]');
  
  // éªŒè¯å¤§é—¨æ¶ˆå¤±
  await expect(page.locator('.gate-overlay')).not.toBeVisible();
});

test('recording falls back to text input on unsupported browser', async ({ page }) => {
  // æ¨¡æ‹Ÿä¸æ”¯æŒ getUserMedia
  await page.addInitScript(() => {
    delete navigator.mediaDevices;
  });
  
  await page.goto('/');
  
  // éªŒè¯æ˜¾ç¤ºæ–‡å­—è¾“å…¥
  await expect(page.locator('.black-box-text-input')).toBeVisible();
  await expect(page.locator('.black-box-recorder')).not.toBeVisible();
});
```

---

## åå››ã€å¿«é€Ÿéƒ¨ç½²æŒ‡å—

### 14.1 éƒ¨ç½² Edge Functionï¼ˆä¸€æ¬¡æ€§è®¾ç½®ï¼‰

```bash
# 1. åˆ›å»º Edge Function
supabase functions new transcribe

# 2. å¤åˆ¶ Edge Function ä»£ç ï¼ˆè§ 2.4.6 èŠ‚ï¼‰åˆ° supabase/functions/transcribe/index.ts

# 3. è®¾ç½® Groq API Keyï¼ˆå®‰å…¨å­˜å‚¨åœ¨ Supabaseï¼‰
supabase secrets set GROQ_API_KEY=gsk_your_actual_key_here

# 4. éƒ¨ç½²å‡½æ•°
supabase functions deploy transcribe

# 5. éªŒè¯éƒ¨ç½²æˆåŠŸ
supabase functions list
```

### 14.2 åˆ›å»ºæ•°æ®åº“è¡¨

```sql
-- åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œ

-- é»‘åŒ£å­æ¡ç›®è¡¨
CREATE TABLE black_box_entries (
  id UUID PRIMARY KEY,  -- å®¢æˆ·ç«¯ç”Ÿæˆ
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  content TEXT NOT NULL,
  date DATE NOT NULL DEFAULT CURRENT_DATE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  is_read BOOLEAN DEFAULT FALSE,
  is_completed BOOLEAN DEFAULT FALSE,
  is_archived BOOLEAN DEFAULT FALSE,
  snooze_until DATE DEFAULT NULL,
  snooze_count INTEGER DEFAULT 0,
  deleted_at TIMESTAMPTZ DEFAULT NULL
);

-- è½¬å†™ä½¿ç”¨é‡è¡¨ï¼ˆé…é¢æ§åˆ¶ï¼‰
CREATE TABLE transcription_usage (
  id UUID PRIMARY KEY,  -- å®¢æˆ·ç«¯ç”Ÿæˆ
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  date DATE NOT NULL DEFAULT CURRENT_DATE,
  audio_seconds INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_black_box_user_date ON black_box_entries(user_id, date);
CREATE INDEX idx_black_box_updated_at ON black_box_entries(updated_at);
CREATE UNIQUE INDEX idx_transcription_usage_user_date ON transcription_usage(user_id, date);

-- RLS
ALTER TABLE black_box_entries ENABLE ROW LEVEL SECURITY;
ALTER TABLE transcription_usage ENABLE ROW LEVEL SECURITY;

CREATE POLICY "ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„é»‘åŒ£å­" ON black_box_entries FOR ALL USING (auth.uid() = user_id);
CREATE POLICY "ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„ä½¿ç”¨é‡" ON transcription_usage FOR ALL USING (auth.uid() = user_id);
```

### 14.3 æœ¬åœ°æµ‹è¯•

```bash
# 1. å¯åŠ¨æœ¬åœ° Supabaseï¼ˆå¯é€‰ï¼‰
supabase start

# 2. æœ¬åœ°æµ‹è¯• Edge Function
supabase functions serve transcribe --env-file .env.local

# 3. æµ‹è¯•è¯·æ±‚
curl -X POST http://localhost:54321/functions/v1/transcribe \
  -H "Authorization: Bearer YOUR_ANON_KEY" \
  -F "file=@test-audio.webm"
```

### 14.4 è·å– Groq API Key

1. è®¿é—® [console.groq.com](https://console.groq.com)
2. æ³¨å†Œ/ç™»å½•è´¦å·
3. åˆ›å»ºæ–°çš„ API Key
4. ä½¿ç”¨ `supabase secrets set GROQ_API_KEY=gsk_xxx` å®‰å…¨å­˜å‚¨
