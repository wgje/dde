<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¯­éŸ³è½¬å†™åŠŸèƒ½è¯Šæ–­å·¥å…·</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .section {
      margin-bottom: 25px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
      border-left: 4px solid #4CAF50;
    }
    .section h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #333;
    }
    input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      margin-bottom: 10px;
      font-family: monospace;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }
    button:hover:not(:disabled) { background: #45a049; }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .result {
      margin-top: 15px;
      padding: 15px;
      border-radius: 6px;
      font-size: 14px;
      white-space: pre-wrap;
      word-break: break-all;
      display: none;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .code {
      background: #f4f4f4;
      padding: 3px 6px;
      border-radius: 3px;
      font-family: monospace;
      font-size: 12px;
    }
    .status-item {
      display: flex;
      align-items: center;
      margin: 10px 0;
      padding: 10px;
      background: white;
      border-radius: 6px;
    }
    .status-icon {
      font-size: 24px;
      margin-right: 12px;
    }
    .recorder {
      text-align: center;
      padding: 20px;
    }
    .record-btn {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      font-size: 40px;
      border: 4px solid #4CAF50;
      background: white;
      color: #4CAF50;
      cursor: pointer;
      transition: all 0.3s;
    }
    .record-btn:active { transform: scale(0.95); }
    .record-btn.recording {
      background: #f44336;
      color: white;
      border-color: #f44336;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ™ï¸ è¯­éŸ³è½¬å†™åŠŸèƒ½è¯Šæ–­å·¥å…·</h1>
    <p class="subtitle">æµ‹è¯• NanoFlow è¯­éŸ³è½¬å†™åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ</p>

    <!-- é…ç½®è¾“å…¥ -->
    <div class="section">
      <h2>1ï¸âƒ£ é…ç½®ä¿¡æ¯</h2>
      <input type="text" id="supabaseUrl" placeholder="Supabase URL (ä¾‹: https://xxx.supabase.co)">
      <input type="text" id="supabaseKey" placeholder="Supabase Anon Key">
      <input type="email" id="email" placeholder="æµ‹è¯•ç”¨æˆ·é‚®ç®±">
      <input type="password" id="password" placeholder="æµ‹è¯•ç”¨æˆ·å¯†ç ">
      <button onclick="saveConfig()">ä¿å­˜é…ç½®</button>
      <div id="configResult" class="result"></div>
    </div>

    <!-- è¿æ¥æµ‹è¯• -->
    <div class="section">
      <h2>2ï¸âƒ£ è¿æ¥æµ‹è¯•</h2>
      <button onclick="testConnection()">æµ‹è¯• Supabase è¿æ¥</button>
      <div id="connectionResult" class="result"></div>
    </div>

    <!-- è®¤è¯æµ‹è¯• -->
    <div class="section">
      <h2>3ï¸âƒ£ ç”¨æˆ·è®¤è¯</h2>
      <button onclick="testAuth()">ç™»å½•æµ‹è¯•</button>
      <div id="authResult" class="result"></div>
    </div>

    <!-- æ•°æ®åº“æµ‹è¯• -->
    <div class="section">
      <h2>4ï¸âƒ£ æ•°æ®åº“æ£€æŸ¥</h2>
      <button onclick="testDatabase()">æ£€æŸ¥æ•°æ®åº“è¡¨</button>
      <div id="dbResult" class="result"></div>
    </div>

    <!-- Edge Function æµ‹è¯• -->
    <div class="section">
      <h2>5ï¸âƒ£ Edge Function æµ‹è¯•</h2>
      <input type="file" id="audioFile" accept="audio/*">
      <button onclick="testEdgeFunction()">æµ‹è¯•è½¬å†™ API</button>
      <div id="edgeFunctionResult" class="result"></div>
    </div>

    <!-- å½•éŸ³æµ‹è¯• -->
    <div class="section">
      <h2>6ï¸âƒ£ å®Œæ•´å½•éŸ³è½¬å†™æµ‹è¯•</h2>
      <div class="recorder">
        <button id="recordBtn" class="record-btn" onclick="toggleRecording()">ğŸ™ï¸</button>
        <p id="recordStatus">ç‚¹å‡»å¼€å§‹å½•éŸ³</p>
      </div>
      <div id="recordResult" class="result"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    let supabase = null;
    let mediaRecorder = null;
    let audioChunks = [];

    function showResult(elementId, message, type = 'info') {
      const el = document.getElementById(elementId);
      el.textContent = message;
      el.className = `result ${type}`;
      el.style.display = 'block';
    }

    function saveConfig() {
      const url = document.getElementById('supabaseUrl').value;
      const key = document.getElementById('supabaseKey').value;
      
      if (!url || !key) {
        showResult('configResult', 'âŒ è¯·å¡«å†™å®Œæ•´çš„ Supabase é…ç½®', 'error');
        return;
      }
      
      try {
        supabase = window.supabase.createClient(url, key);
        localStorage.setItem('supabaseUrl', url);
        localStorage.setItem('supabaseKey', key);
        localStorage.setItem('email', document.getElementById('email').value);
        localStorage.setItem('password', document.getElementById('password').value);
        showResult('configResult', 'âœ… é…ç½®å·²ä¿å­˜', 'success');
      } catch (err) {
        showResult('configResult', `âŒ é…ç½®é”™è¯¯: ${err.message}`, 'error');
      }
    }

    async function testConnection() {
      if (!supabase) {
        showResult('connectionResult', 'âŒ è¯·å…ˆä¿å­˜é…ç½®', 'error');
        return;
      }
      
      try {
        const { data, error } = await supabase.from('projects').select('count').limit(1);
        if (error) throw error;
        showResult('connectionResult', 'âœ… Supabase è¿æ¥æˆåŠŸ', 'success');
      } catch (err) {
        showResult('connectionResult', `âŒ è¿æ¥å¤±è´¥: ${err.message}`, 'error');
      }
    }

    async function testAuth() {
      if (!supabase) {
        showResult('authResult', 'âŒ è¯·å…ˆä¿å­˜é…ç½®', 'error');
        return;
      }
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      if (!email || !password) {
        showResult('authResult', 'âŒ è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ', 'error');
        return;
      }
      
      try {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
        showResult('authResult', `âœ… ç™»å½•æˆåŠŸ\nç”¨æˆ· ID: ${data.user.id}\nToken: ${data.session.access_token.substring(0, 50)}...`, 'success');
      } catch (err) {
        showResult('authResult', `âŒ ç™»å½•å¤±è´¥: ${err.message}`, 'error');
      }
    }

    async function testDatabase() {
      if (!supabase) {
        showResult('dbResult', 'âŒ è¯·å…ˆä¿å­˜é…ç½®', 'error');
        return;
      }
      
      try {
        // æ£€æŸ¥ transcription_usage è¡¨
        const { data, error } = await supabase.from('transcription_usage').select('count').limit(1);
        if (error && error.message.includes('does not exist')) {
          showResult('dbResult', 'âŒ è¡¨ transcription_usage ä¸å­˜åœ¨\nè¯·åœ¨ Supabase SQL Editor æ‰§è¡Œ scripts/init-supabase.sql', 'error');
        } else if (error) {
          showResult('dbResult', `âš ï¸ æƒé™æ£€æŸ¥: ${error.message}`, 'info');
        } else {
          showResult('dbResult', 'âœ… æ•°æ®åº“è¡¨ transcription_usage å­˜åœ¨ä¸”å¯è®¿é—®', 'success');
        }
      } catch (err) {
        showResult('dbResult', `âŒ æ•°æ®åº“æ£€æŸ¥å¤±è´¥: ${err.message}`, 'error');
      }
    }

    async function testEdgeFunction() {
      if (!supabase) {
        showResult('edgeFunctionResult', 'âŒ è¯·å…ˆä¿å­˜é…ç½®', 'error');
        return;
      }
      
      const fileInput = document.getElementById('audioFile');
      const file = fileInput.files[0];
      
      if (!file) {
        showResult('edgeFunctionResult', 'âŒ è¯·é€‰æ‹©éŸ³é¢‘æ–‡ä»¶', 'error');
        return;
      }
      
      try {
        showResult('edgeFunctionResult', 'â³ æ­£åœ¨è°ƒç”¨ Edge Function...', 'info');
        
        const formData = new FormData();
        formData.append('file', file);
        
        const { data, error } = await supabase.functions.invoke('transcribe', { body: formData });
        
        if (error) {
          throw error;
        }
        
        showResult('edgeFunctionResult', 
          `âœ… è½¬å†™æˆåŠŸï¼\n\nè½¬å†™æ–‡æœ¬: ${data.text}\næ—¶é•¿: ${data.duration}ç§’\nè¯­è¨€: ${data.language}`, 
          'success');
      } catch (err) {
        const errorMsg = typeof err === 'object' ? JSON.stringify(err, null, 2) : err.message || String(err);
        showResult('edgeFunctionResult', `âŒ Edge Function è°ƒç”¨å¤±è´¥:\n${errorMsg}`, 'error');
      }
    }

    async function toggleRecording() {
      if (!mediaRecorder || mediaRecorder.state === 'inactive') {
        await startRecording();
      } else {
        await stopRecording();
      }
    }

    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          document.getElementById('recordStatus').textContent = 'â³ æ­£åœ¨è½¬å†™...';
          await transcribeAudio(audioBlob);
          stream.getTracks().forEach(track => track.stop());
        };
        
        mediaRecorder.start(1000);
        document.getElementById('recordBtn').classList.add('recording');
        document.getElementById('recordStatus').textContent = 'ğŸ”´ å½•éŸ³ä¸­... ç‚¹å‡»åœæ­¢';
      } catch (err) {
        showResult('recordResult', `âŒ å½•éŸ³å¤±è´¥: ${err.message}`, 'error');
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        document.getElementById('recordBtn').classList.remove('recording');
        document.getElementById('recordStatus').textContent = 'å¤„ç†ä¸­...';
      }
    }

    async function transcribeAudio(audioBlob) {
      if (!supabase) {
        showResult('recordResult', 'âŒ è¯·å…ˆä¿å­˜é…ç½®', 'error');
        return;
      }
      
      try {
        const formData = new FormData();
        formData.append('file', audioBlob, 'recording.webm');
        
        const { data, error } = await supabase.functions.invoke('transcribe', { body: formData });
        
        if (error) throw error;
        
        document.getElementById('recordStatus').textContent = 'âœ… è½¬å†™å®Œæˆ';
        showResult('recordResult', `âœ… è½¬å†™ç»“æœ:\n\n${data.text}`, 'success');
      } catch (err) {
        document.getElementById('recordStatus').textContent = 'âŒ è½¬å†™å¤±è´¥';
        const errorMsg = typeof err === 'object' ? JSON.stringify(err, null, 2) : err.message || String(err);
        showResult('recordResult', `âŒ è½¬å†™å¤±è´¥:\n${errorMsg}`, 'error');
      }
    }

    // é¡µé¢åŠ è½½æ—¶æ¢å¤é…ç½®
    window.onload = () => {
      const url = localStorage.getItem('supabaseUrl');
      const key = localStorage.getItem('supabaseKey');
      const email = localStorage.getItem('email');
      const password = localStorage.getItem('password');
      
      if (url) document.getElementById('supabaseUrl').value = url;
      if (key) document.getElementById('supabaseKey').value = key;
      if (email) document.getElementById('email').value = email;
      if (password) document.getElementById('password').value = password;
      
      if (url && key) {
        supabase = window.supabase.createClient(url, key);
      }
    };
  </script>
</body>
</html>
