<!-- 移动端：双向抽屉布局 -->
@if (uiState.isMobile()) {
  <app-mobile-drawer-container
    class="flex-1 min-h-0"
    (drawerStateChange)="onDrawerStateChange($event)">
    
    <!-- 顶层抽屉：待办 + 待分配 -->
    <div slot="top" class="h-full">
      <app-mobile-todo-drawer
        [isDropTargetActive]="dragDrop.isDropTargetActive()"
        (centerOnNode)="onMobileDrawerCenterOnNode($event)"
        (createUnassigned)="createUnassigned()"
        (taskClick)="onUnassignedTaskClick($event)"
        (taskDragStart)="onDragStart($event.event, $event.task)"
        (taskDrop)="onUnassignedDrop($event.event)"
        (taskTouchStart)="onUnassignedTouchStart($event.event, $event.task)"
        (taskTouchMove)="onUnassignedTouchMove($event.event)"
        (taskTouchEnd)="onUnassignedTouchEnd($event.event)"
        (swipeToSwitch)="onDrawerSwipeToSwitch($event)">
      </app-mobile-todo-drawer>
    </div>
    
    <!-- 中间层：流程图 -->
    <div slot="middle" class="h-full relative" [style.backgroundColor]="'var(--theme-bg, #F5F2E9)'">
      @if (!diagram.error()) {
        <div #diagramDiv data-testid="flow-diagram" class="absolute inset-0 w-full h-full z-0 flow-canvas-container"></div>
        
        <!-- 移动端导航按钮 -->
        <!-- 左下角：前往文本视图 -->
        <button
          (click)="goBackToText.emit()"
          class="absolute left-0 bottom-16 z-40 flex items-center justify-center w-5 h-10 bg-white/90 dark:bg-stone-800/90 backdrop-blur border border-l-0 border-stone-200 dark:border-stone-700 rounded-r-lg shadow-md hover:bg-stone-50 dark:hover:bg-stone-700 hover:w-6 transition-all focus:outline-none"
          title="返回文本">
          <span class="text-[8px] text-stone-400">◀</span>
        </button>

        <!-- 右侧小地图上方：展开项目列表 -->
        <button
          (click)="toggleRightPanel()"
          class="absolute right-0 z-40 flex items-center justify-center w-5 h-10 bg-white/90 dark:bg-stone-800/90 backdrop-blur border border-r-0 border-stone-200 dark:border-stone-700 rounded-l-lg shadow-md hover:bg-stone-50 dark:hover:bg-stone-700 hover:w-6 transition-all focus:outline-none"
          style="bottom: 96px;" 
          title="项目列表">
          <span class="text-[8px] text-stone-400">◀</span>
        </button>
        
        <!-- 批量操作浮动工具栏 -->
        @if (selectionService.hasMultipleSelection()) {
          <div class="absolute left-2 z-40 animate-slide-up" style="bottom: 56px;">
            <div class="bg-white/95 dark:bg-stone-800/95 backdrop-blur rounded-lg shadow-lg border border-stone-200 dark:border-stone-600 px-2.5 py-1.5 flex items-center gap-1.5">
              <span class="text-xs text-stone-600 dark:text-stone-300">
                已选 <span class="font-semibold text-stone-800 dark:text-stone-100">{{ selectionService.selectionCount() }}</span>
              </span>
              <div class="w-px h-3 bg-stone-200 dark:bg-stone-600"></div>
              <button 
                (click)="requestBatchDelete()"
                class="flex items-center gap-1 px-1.5 py-1 text-xs font-medium text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/30 rounded transition-colors">
                <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                删除
              </button>
              <button 
                (click)="selectionService.clearSelection()"
                class="px-1.5 py-1 text-xs font-medium text-stone-500 dark:text-stone-400 hover:bg-stone-100 dark:hover:bg-stone-700 rounded transition-colors">
                取消
              </button>
            </div>
          </div>
        }
        
        <!-- 小地图/导航器 -->
        @if (isOverviewVisible()) {
          <div 
            class="absolute z-50 pointer-events-auto bg-white/90 dark:bg-stone-800/90 backdrop-blur rounded-lg shadow-md border border-stone-200/60 dark:border-stone-700/60 select-none"
            style="overflow: hidden;"
            [ngClass]="{ 'opacity-40 hover:opacity-100': isOverviewCollapsed() }"
            [style.right.px]="8"
            [style.bottom]="'8px'"
            [style.width.px]="isOverviewCollapsed() ? 24 : overviewSize().width"
            [style.height.px]="isOverviewCollapsed() ? 24 : overviewSize().height">
            @if (!isOverviewCollapsed()) {
              <div #overviewDiv class="w-full h-full relative z-0" style="overflow: hidden; position: relative;"></div>
            }
            <button
              (pointerdown)="onOverviewTogglePointerDown($event)"
              type="button"
              class="absolute top-0.5 right-0.5 z-50 pointer-events-auto rounded bg-white/80 dark:bg-stone-700/80 hover:bg-stone-100 dark:hover:bg-stone-600 flex items-center justify-center transition-colors w-6 h-6"
              [title]="isOverviewCollapsed() ? '展开小地图' : '折叠小地图'">
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="w-3 h-3 text-stone-500 dark:text-stone-400">
                @if (isOverviewCollapsed()) {
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                } @else {
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 12h12" />
                }
              </svg>
            </button>
          </div>
        }
      } @else {
        <!-- 流程图加载失败降级 UI -->
        <div class="absolute inset-0 flex flex-col items-center justify-center bg-stone-50 dark:bg-stone-900 p-6">
          <div class="w-16 h-16 rounded-full bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center mb-4">
            <svg class="w-8 h-8 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-stone-800 dark:text-stone-200 mb-2">流程图加载失败</h3>
          <p class="text-sm text-stone-500 dark:text-stone-400 text-center mb-4">{{ diagram.error() }}</p>
          <div class="flex gap-3">
            <button (click)="goBackToText.emit()" class="px-4 py-2 bg-stone-200 dark:bg-stone-700 text-stone-700 dark:text-stone-200 rounded-lg hover:bg-stone-300 dark:hover:bg-stone-600 transition-colors text-sm font-medium">
              切换到文本视图
            </button>
          </div>
        </div>
      }

      <!-- 工具栏 -->
      <app-flow-toolbar
        [isLinkMode]="link.isLinkMode()"
        [isPaletteOpen]="isPaletteOpen()"
        [linkSourceTask]="link.linkSourceTask()"
        [isResizingDrawer]="isResizingDrawerSignal()"
        [drawerHeightVh]="drawerHeight()"
        [isSelectMode]="isSelectMode()"
        (zoomIn)="zoomIn()"
        (zoomOut)="zoomOut()"
        (autoLayout)="applyAutoLayout()"
        (toggleLinkMode)="link.toggleLinkMode()"
        (cancelLinkMode)="link.cancelLinkMode()"
        (toggleSidebar)="emitToggleSidebar()"
        (goBackToText)="goBackToText.emit()"
        (exportPng)="exportToPng()"
        (exportSvg)="exportToSvg()"
        (saveToCloud)="saveToCloud()"
        (toggleSelectMode)="toggleSelectMode()">
      </app-flow-toolbar>

      <!-- 任务详情面板 -->
      <app-flow-task-detail
        [task]="selectedTask()"
        [position]="taskDetailPos()"
        [drawerHeight]="drawerHeight()"
        [autoHeightEnabled]="!drawerManualOverride()"
        (positionChange)="taskDetailPos.set($event)"
        (drawerHeightChange)="drawerHeight.set($event)"
        (isResizingChange)="isResizingDrawerSignal.set($event)"
        (titleChange)="taskOps.updateTaskTitle($event.taskId, $event.title)"
        (contentChange)="taskOps.updateTaskContent($event.taskId, $event.content)"
        (priorityChange)="taskOps.updateTaskPriority($event.taskId, $event.priority)"
        (dueDateChange)="taskOps.updateTaskDueDate($event.taskId, $event.dueDate)"
        (tagAdd)="taskOps.addTaskTag($event.taskId, $event.tag)"
        (tagRemove)="taskOps.removeTaskTag($event.taskId, $event.tag)"
        (addSibling)="addSiblingTask($event)"
        (addChild)="addChildTask($event)"
        (toggleStatus)="taskOps.toggleTaskStatus($event)"
        (archiveTask)="archiveTask($event)"
        (deleteTask)="deleteTask($event)"
        (quickTodoAdd)="taskOps.addQuickTodo($event.taskId, $event.text)"
        (attachmentAdd)="taskOps.addTaskAttachment($event.taskId, $event.attachment)"
        (attachmentRemove)="taskOps.removeTaskAttachment($event.taskId, $event.attachmentId)"
        (attachmentsChange)="taskOps.updateTaskAttachments($event.taskId, $event.attachments)"
        (attachmentError)="taskOps.handleAttachmentError($event)">
      </app-flow-task-detail>
    </div>
    
    <!-- 底层抽屉：黑匣子 -->
    <div slot="bottom" class="h-full">
      <app-mobile-black-box-drawer
        (swipeToSwitch)="onDrawerSwipeToSwitch($event)">
      </app-mobile-black-box-drawer>
    </div>
  </app-mobile-drawer-container>
  
  <!-- 移动端右侧滑出项目面板 -->
  @if (isRightPanelOpen()) {
    <!-- 背景遮罩 - 无模糊效果 -->
    <div 
      class="fixed inset-0 bg-black/20 z-[100]"
      (click)="isRightPanelOpen.set(false)"
      (touchstart)="onRightPanelBackdropTouchStart($event)"
      (touchmove)="onRightPanelBackdropTouchMove($event)"
      (touchend)="onRightPanelBackdropTouchEnd($event)">
    </div>
    
    <!-- 右侧面板 - 紧凑宽度 -->
    <div 
      class="fixed top-0 right-0 bottom-0 w-20 bg-white dark:bg-stone-900 z-[101] shadow-xl
             flex flex-col animate-slide-in-right border-l border-stone-200 dark:border-stone-700"
      (touchstart)="onRightPanelTouchStart($event)"
      (touchmove)="onRightPanelTouchMove($event)"
      (touchend)="onRightPanelTouchEnd($event)">
      
      <!-- 面板标题 -->
      <div class="shrink-0 px-3 py-2.5 bg-gradient-to-r from-indigo-500 to-indigo-600 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <svg class="w-4 h-4 text-white/80" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
          </svg>
          <h2 class="text-sm font-semibold text-white">项目</h2>
        </div>
        <button 
          (click)="isRightPanelOpen.set(false)"
          class="p-1 rounded hover:bg-white/20 transition-colors">
          <svg class="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      
      <!-- 项目数量统计 -->
      <div class="shrink-0 px-3 py-1.5 bg-stone-50 dark:bg-stone-800/50 border-b border-stone-100 dark:border-stone-700">
        <span class="text-[10px] text-stone-500 dark:text-stone-400">
          共 {{ projectState.projects().length }} 个项目
        </span>
      </div>
      
      <!-- 项目列表 -->
      <div class="flex-1 overflow-y-auto py-1.5">
        @for (project of projectState.projects(); track project.id) {
          <div 
            class="mx-1.5 mb-0.5 px-2.5 py-2 rounded-md cursor-pointer transition-all flex items-center gap-2 group"
            [ngClass]="{
              'bg-indigo-50 dark:bg-indigo-900/30 border-l-2 border-indigo-500': project.id === projectState.activeProjectId(),
              'hover:bg-stone-50 dark:hover:bg-stone-800 active:bg-stone-100 dark:active:bg-stone-700': project.id !== projectState.activeProjectId()
            }"
            (click)="onRightPanelProjectClick(project.id)">
            <div class="w-1.5 h-1.5 rounded-full shrink-0"
                 [ngClass]="{
                   'bg-indigo-500': project.id === projectState.activeProjectId(),
                   'bg-stone-300 dark:bg-stone-600 group-hover:bg-stone-400': project.id !== projectState.activeProjectId()
                 }">
            </div>
            <span class="text-xs font-medium truncate flex-1"
                  [ngClass]="{
                    'text-indigo-700 dark:text-indigo-300': project.id === projectState.activeProjectId(),
                    'text-stone-600 dark:text-stone-300': project.id !== projectState.activeProjectId()
                  }">
              {{ project.name || '未命名项目' }}
            </span>
            @if (project.id === projectState.activeProjectId()) {
              <svg class="w-3 h-3 text-indigo-500 shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
              </svg>
            }
          </div>
        }
        
        @if (projectState.projects().length === 0) {
          <div class="px-3 py-6 text-center">
            <svg class="w-8 h-8 mx-auto text-stone-300 dark:text-stone-600 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
            </svg>
            <p class="text-[11px] text-stone-400 dark:text-stone-500">暂无项目</p>
          </div>
        }
      </div>
      
      <!-- 底部操作提示 -->
      <div class="shrink-0 px-3 py-2 bg-stone-50 dark:bg-stone-800/50 border-t border-stone-100 dark:border-stone-700">
        <div class="flex items-center justify-center gap-1 text-[9px] text-stone-400 dark:text-stone-500">
          <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" />
          </svg>
          <span>滑动关闭</span>
        </div>
      </div>
    </div>
  }
} @else {
  <!-- 桌面端：保持原有布局 -->
  <div class="flex flex-col flex-1 min-h-0 relative">
    <!-- 顶部调色板区域 -->
    <app-flow-palette
      [height]="paletteHeight()"
      [isDropTargetActive]="dragDrop.isDropTargetActive()"
      (isOpenChange)="onPaletteOpenChange($event)"
      (heightChange)="paletteHeight.set($event)"
      (centerOnNode)="centerOnNode($event)"
      (createUnassigned)="createUnassigned()"
      (taskClick)="onUnassignedTaskClick($event)"
      (taskDragStart)="onDragStart($event.event, $event.task)"
      (taskDrop)="onUnassignedDrop($event.event)"
      (taskTouchStart)="onUnassignedTouchStart($event.event, $event.task)"
      (taskTouchMove)="onUnassignedTouchMove($event.event)"
      (taskTouchEnd)="onUnassignedTouchEnd($event.event)"
      (swipeToText)="goBackToText.emit()"
      (swipeToSidebar)="toggleRightPanel()">
    </app-flow-palette>

    <!-- 流程图区域 -->
  <div class="flex-1 min-h-0 relative overflow-hidden dark:bg-stone-950 md:border-t md:border-[#78716C]/50" [style.backgroundColor]="'var(--theme-bg, #F5F2E9)'">
    @if (!diagram.error()) {
      <div #diagramDiv data-testid="flow-diagram" class="absolute inset-0 w-full h-full z-0 flow-canvas-container"></div>
      
      <!-- 移动端导航按钮 -->
      @if (uiState.isMobile()) {
        <!-- 左下角：前往文本视图 -->
        <button
          (click)="goBackToText.emit()"
          class="absolute left-0 bottom-16 z-40 flex items-center justify-center w-5 h-10 bg-white/90 dark:bg-stone-800/90 backdrop-blur border border-l-0 border-stone-200 dark:border-stone-700 rounded-r-lg shadow-md hover:bg-stone-50 dark:hover:bg-stone-700 hover:w-6 transition-all focus:outline-none"
          title="返回文本">
          <span class="text-[8px] text-stone-400 group-hover:text-stone-600 dark:group-hover:text-stone-300 transform transition-transform duration-300">◀</span>
        </button>

        <!-- 右侧小地图上方：展开项目列表 -->
        <button
          (click)="toggleRightPanel()"
          class="absolute right-0 z-40 flex items-center justify-center w-5 h-10 bg-white/90 dark:bg-stone-800/90 backdrop-blur border border-r-0 border-stone-200 dark:border-stone-700 rounded-l-lg shadow-md hover:bg-stone-50 dark:hover:bg-stone-700 hover:w-6 transition-all focus:outline-none"
          style="bottom: 96px;" 
          title="项目列表">
          <span class="text-[8px] text-stone-400 group-hover:text-stone-600 dark:group-hover:text-stone-300 transform transition-transform duration-300">◀</span>
        </button>
      }
      
      <!-- 批量操作浮动工具栏（放在流程图画布内部） -->
      @if (selectionService.hasMultipleSelection()) {
        @if (uiState.isMobile()) {
          <!-- 移动端：左下角，工具栏上方（不遮挡工具框） -->
          <div class="absolute left-2 z-40 animate-slide-up" style="bottom: 56px;">
            <div class="bg-white/95 dark:bg-stone-800/95 backdrop-blur rounded-lg shadow-lg border border-stone-200 dark:border-stone-600 px-2.5 py-1.5 flex items-center gap-1.5">
              <span class="text-xs text-stone-600 dark:text-stone-300">
                已选 <span class="font-semibold text-stone-800 dark:text-stone-100">{{ selectionService.selectionCount() }}</span>
              </span>
              <div class="w-px h-3 bg-stone-200 dark:bg-stone-600"></div>
              <button 
                (click)="requestBatchDelete()"
                class="flex items-center gap-1 px-1.5 py-1 text-xs font-medium text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/30 rounded transition-colors">
                <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                删除
              </button>
              <button 
                (click)="selectionService.clearSelection()"
                class="px-1.5 py-1 text-xs font-medium text-stone-500 dark:text-stone-400 hover:bg-stone-100 dark:hover:bg-stone-700 rounded transition-colors">
                取消
              </button>
            </div>
          </div>
        } @else {
          <!-- 桌面端：流程图画布左上角 -->
          <div class="absolute left-4 top-4 z-40 animate-slide-up">
            <div class="bg-white/95 dark:bg-stone-800/95 backdrop-blur rounded-xl shadow-lg border border-stone-200 dark:border-stone-600 px-4 py-2.5 flex items-center gap-3">
              <span class="text-sm text-stone-600 dark:text-stone-300">
                已选择 <span class="font-semibold text-stone-800 dark:text-stone-100">{{ selectionService.selectionCount() }}</span> 个任务
              </span>
              <div class="w-px h-4 bg-stone-200 dark:bg-stone-600"></div>
              <button 
                (click)="requestBatchDelete()"
                class="flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-colors">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                删除
              </button>
              <button 
                (click)="selectionService.clearSelection()"
                class="flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-stone-500 dark:text-stone-400 hover:bg-stone-100 dark:hover:bg-stone-700 rounded-lg transition-colors">
                取消选择
              </button>
            </div>
          </div>
        }
      }
      
      <!-- 小地图/导航器 -->
      @if (isOverviewVisible()) {
        <div 
          class="absolute z-50 pointer-events-auto bg-white/90 dark:bg-stone-800/90 backdrop-blur rounded-lg shadow-md border border-stone-200/60 dark:border-stone-700/60 select-none"
          style="overflow: hidden;"
          [ngClass]="{
            'opacity-40 hover:opacity-100': isOverviewCollapsed()
          }"
          [style.right.px]="uiState.isMobile() ? 8 : 16"
          [style.bottom]="overviewBottomPosition()"
          [style.width.px]="isOverviewCollapsed() ? (uiState.isMobile() ? 24 : 28) : overviewSize().width"
          [style.height.px]="isOverviewCollapsed() ? (uiState.isMobile() ? 24 : 28) : overviewSize().height">
          
          <!-- 小地图内容 -->
          @if (!isOverviewCollapsed()) {
            <!-- 让 Overview 画布在更低层级渲染，避免覆盖右上角折叠按钮的点击区域 -->
            <!-- 添加明确的尺寸和 overflow 设置，确保 Canvas 正确渲染 -->
            <div #overviewDiv 
              class="w-full h-full relative z-0"
              style="overflow: hidden; position: relative;"></div>
          }
          
          <!-- 折叠/展开按钮 -->
          <button
            (pointerdown)="onOverviewTogglePointerDown($event)"
            type="button"
            class="absolute top-0.5 right-0.5 z-50 pointer-events-auto rounded bg-white/80 dark:bg-stone-700/80 hover:bg-stone-100 dark:hover:bg-stone-600 flex items-center justify-center transition-colors"
            [class.w-5]="!uiState.isMobile()"
            [class.h-5]="!uiState.isMobile()"
             [class.w-6]="uiState.isMobile()"
             [class.h-6]="uiState.isMobile()"
            [title]="isOverviewCollapsed() ? '展开小地图' : '折叠小地图'">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                 [class.w-3]="!uiState.isMobile()"
                 [class.h-3]="!uiState.isMobile()"
               [class.w-3]="uiState.isMobile()"
               [class.h-3]="uiState.isMobile()"
                 class="text-stone-500 dark:text-stone-400">
              @if (isOverviewCollapsed()) {
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
              } @else {
                <!-- 折叠图标：用"最小化"横线替代叉叉，避免误解为关闭按钮 -->
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 12h12" />
              }
            </svg>
          </button>
        </div>
      }
    } @else {
      <!-- 流程图加载失败时的降级 UI -->
      <div class="absolute inset-0 flex flex-col items-center justify-center bg-stone-50 dark:bg-stone-900 p-6">
        <div class="w-16 h-16 rounded-full bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center mb-4">
          <svg class="w-8 h-8 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-stone-800 dark:text-stone-200 mb-2">流程图加载失败</h3>
        <p class="text-sm text-stone-500 dark:text-stone-400 text-center mb-4">{{ diagram.error() }}</p>
        <div class="flex gap-3">
          @if (hasReachedRetryLimit()) {
            <!-- 达到重试上限后显示完全重置按钮 -->
            <button 
              (click)="resetAndRetryDiagram()"
              class="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition-colors text-sm font-medium flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
              </svg>
              完全重置
            </button>
          } @else {
            <button 
              (click)="retryInitDiagram()"
              [disabled]="isRetryingDiagram()"
              class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
              @if (isRetryingDiagram()) {
                <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>加载中...</span>
              } @else {
                重试加载
              }
            </button>
          }
          <button 
            (click)="goBackToText.emit()"
            class="px-4 py-2 bg-stone-200 dark:bg-stone-700 text-stone-700 dark:text-stone-200 rounded-lg hover:bg-stone-300 dark:hover:bg-stone-600 transition-colors text-sm font-medium">
            切换到文本视图
          </button>
        </div>
        <p class="text-xs text-stone-400 mt-4">
          提示：您仍可以在文本视图中管理任务
        </p>
      </div>
    }

    <!-- 工具栏 -->
    <app-flow-toolbar
      [isLinkMode]="link.isLinkMode()"
      [isPaletteOpen]="isPaletteOpen()"
      [linkSourceTask]="link.linkSourceTask()"
      [isResizingDrawer]="isResizingDrawerSignal()"
      [drawerHeightVh]="drawerHeight()"
      [isSelectMode]="isSelectMode()"
      (zoomIn)="zoomIn()"
      (zoomOut)="zoomOut()"
      (autoLayout)="applyAutoLayout()"
      (toggleLinkMode)="link.toggleLinkMode()"
      (cancelLinkMode)="link.cancelLinkMode()"
      (toggleSidebar)="emitToggleSidebar()"
      (goBackToText)="goBackToText.emit()"
      (exportPng)="exportToPng()"
      (exportSvg)="exportToSvg()"
      (saveToCloud)="saveToCloud()"
      (toggleSelectMode)="toggleSelectMode()">
    </app-flow-toolbar>

    <!-- 任务详情面板 -->
    <app-flow-task-detail
      [task]="selectedTask()"
      [position]="taskDetailPos()"
      [drawerHeight]="drawerHeight()"
      [autoHeightEnabled]="!drawerManualOverride()"
      (positionChange)="taskDetailPos.set($event)"
      (drawerHeightChange)="drawerHeight.set($event)"
      (isResizingChange)="isResizingDrawerSignal.set($event)"
      (titleChange)="taskOps.updateTaskTitle($event.taskId, $event.title)"
      (contentChange)="taskOps.updateTaskContent($event.taskId, $event.content)"
      (priorityChange)="taskOps.updateTaskPriority($event.taskId, $event.priority)"
      (dueDateChange)="taskOps.updateTaskDueDate($event.taskId, $event.dueDate)"
      (tagAdd)="taskOps.addTaskTag($event.taskId, $event.tag)"
      (tagRemove)="taskOps.removeTaskTag($event.taskId, $event.tag)"
      (addSibling)="addSiblingTask($event)"
      (addChild)="addChildTask($event)"
      (toggleStatus)="taskOps.toggleTaskStatus($event)"
      (archiveTask)="archiveTask($event)"
      (deleteTask)="deleteTask($event)"
      (quickTodoAdd)="taskOps.addQuickTodo($event.taskId, $event.text)"
      (attachmentAdd)="taskOps.addTaskAttachment($event.taskId, $event.attachment)"
      (attachmentRemove)="taskOps.removeTaskAttachment($event.taskId, $event.attachmentId)"
      (attachmentsChange)="taskOps.updateTaskAttachments($event.taskId, $event.attachments)"
      (attachmentError)="taskOps.handleAttachmentError($event)">
    </app-flow-task-detail>
  </div>
  
  <!-- 删除确认弹窗 -->
  <app-flow-delete-confirm
    [task]="deleteConfirmTask()"
    [keepChildren]="deleteKeepChildren()"
    [hasChildren]="deleteConfirmTask() ? taskOps.hasChildren(deleteConfirmTask()!) : false"
    [isMobile]="uiState.isMobile()"
    (cancel)="deleteConfirmTask.set(null); deleteKeepChildren.set(false)"
    (confirm)="confirmDelete($event)"
    (keepChildrenChange)="deleteKeepChildren.set($event)">
  </app-flow-delete-confirm>
  
  <!-- 批量删除确认弹窗 -->
  <app-flow-batch-delete-dialog
    [data]="batchDeleteDialog()"
    [isMobile]="uiState.isMobile()"
    (cancel)="batchDeleteDialog.set(null)"
    (confirm)="confirmBatchDelete()">
  </app-flow-batch-delete-dialog>
  
  <!-- 移动端连接线删除提示 -->
  @if (uiState.isMobile()) {
    <app-flow-link-delete-hint
      [hint]="link.linkDeleteHint()"
      (confirm)="confirmLinkDelete()"
      (cancel)="link.cancelLinkDelete()">
    </app-flow-link-delete-hint>
  }
  
  <!-- 联系块内联编辑器 -->
  <app-flow-connection-editor
    [data]="link.connectionEditorData()"
    [position]="link.connectionEditorPos()"
    [connectionTasks]="link.getConnectionTasks()"
    (close)="link.closeConnectionEditor()"
    (save)="saveConnectionDescription($event)"
    (delete)="deleteConnection()"
    (dragStart)="link.startDragConnEditor($event)">
  </app-flow-connection-editor>
  
  <!-- 连接类型选择对话框 -->
  <app-flow-link-type-dialog
    [data]="link.linkTypeDialog()"
    (cancel)="link.cancelLinkCreate()"
    (parentChildLink)="confirmParentChildLink()"
    (crossTreeLink)="confirmCrossTreeLink()">
  </app-flow-link-type-dialog>
  
  <!-- 级联分配确认对话框 -->
  <app-flow-cascade-assign-dialog
    [data]="cascadeAssignDialog()"
    (confirm)="confirmCascadeAssign()"
    (cancel)="cancelCascadeAssign()">
  </app-flow-cascade-assign-dialog>
  
  <!-- 移动端右侧滑出项目面板 (桌面端不显示) -->
</div>
}
