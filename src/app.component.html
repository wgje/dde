

<!-- 整体布局容器 -->
<div class="h-full w-full flex flex-col overflow-hidden">
  
  <!-- 启动失败阻断性 UI - 优先级最高，阻止所有其他内容 -->
  @if (bootstrapFailed() && !isCheckingSession()) {
    <div class="fixed inset-0 z-[9999] flex items-center justify-center" style="background-color: var(--theme-bg, #f5f5f4);">
      <div class="max-w-md mx-4 p-8 bg-white rounded-2xl shadow-2xl border border-red-100 text-center space-y-6">
        <!-- 错误图标 -->
        <div class="mx-auto w-16 h-16 bg-red-100 rounded-full flex items-center justify-center">
          <svg class="w-8 h-8 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
        </div>
        
        <!-- 标题 -->
        <h1 class="text-2xl font-bold text-stone-800">启动失败</h1>
        
        <!-- 错误信息 -->
        <div class="space-y-2">
          <p class="text-stone-600">应用初始化时遇到问题，无法建立会话连接。</p>
          @if (bootstrapErrorMessage()) {
            <div class="mt-3 p-3 bg-red-50 rounded-lg text-left">
              <p class="text-xs text-red-600 font-mono break-all">{{ bootstrapErrorMessage() }}</p>
            </div>
          }
        </div>
        
        <!-- 可能的原因 -->
        <div class="text-left text-sm text-stone-500 space-y-1 bg-stone-50 p-4 rounded-lg">
          <p class="font-medium text-stone-600 mb-2">可能的原因：</p>
          <ul class="list-disc list-inside space-y-1">
            <li>网络连接中断或不稳定</li>
            <li>本地登录凭证已损坏</li>
            <li>服务端 API 暂时不可用</li>
          </ul>
        </div>
        
        <!-- 重试按钮 -->
        <button 
          (click)="retryBootstrap()"
          [disabled]="isCheckingSession()"
          class="w-full py-4 px-6 bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-300 text-white font-semibold rounded-xl transition-colors flex items-center justify-center gap-2 text-lg">
          @if (isCheckingSession()) {
            <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>正在重试...</span>
          } @else {
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            <span>重试</span>
          }
        </button>
        
        <!-- 离线模式入口（备用） -->
        <button 
          (click)="bootstrapFailed.set(false)"
          class="text-sm text-stone-400 hover:text-stone-600 underline transition-colors">
          以离线模式继续（数据仅保存本地）
        </button>
      </div>
    </div>
  }
  
  <!-- 离线状态横幅 - 固定在顶部，不阻碍操作 -->
  <app-offline-banner data-testid="offline-indicator"></app-offline-banner>

  <!-- 全局错误边界 - 防止致命渲染错误导致白屏 -->
  <app-error-boundary 
    [title]="'应用出现异常'"
    [defaultMessage]="'发生了意外错误，请尝试刷新页面。如问题持续，请联系支持。'"
    [showRetry]="false"
    [showRefresh]="true"
    [showHome]="true"
    [fatal]="true"
    [containerClass]="'full-page'">
    
  <div data-testid="app-container" class="flex flex-1 w-full min-h-0 overflow-hidden font-sans" style="background-color: var(--theme-bg); color: var(--theme-text);">
  
  <!-- Toast 通知容器 -->
  <app-toast-container data-testid="toast-container"></app-toast-container>
  
  <!-- Left Sidebar: Project List -->
  <aside data-testid="project-selector" class="border-r flex flex-col shrink-0 transition-all duration-75 shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-10 overflow-hidden" style="background-color: var(--theme-sidebar-bg); border-color: var(--theme-border);"
         [style.width.px]="isSidebarOpen() ? (isMobile() ? 180 : sidebarWidth()) : 0"
         [class.w-0]="!isSidebarOpen()"
         (touchstart)="onSidebarTouchStart($event)"
         (touchmove)="onSidebarTouchMove($event)"
         (touchend)="onSidebarTouchEnd($event)"
         role="navigation"
         aria-label="项目导航">
    
    <!-- Sidebar Header -->
    <div class="flex justify-between items-center shrink-0"
         [ngClass]="{'mx-6 mt-8 mb-6': !isMobile(), 'mx-3 mt-4 mb-3': isMobile()}">
      <h1 class="font-bold text-stone-800 tracking-tight font-serif"
          [ngClass]="{'text-2xl': !isMobile(), 'text-base': isMobile()}">NanoFlow</h1>
      <div class="flex items-center gap-1">
        <button data-testid="create-project-btn" (click)="createNewProject()" 
                class="text-stone-400 hover:text-stone-800 hover:bg-stone-200/50 flex items-center justify-center rounded-full transition-all font-light" 
                [ngClass]="{'w-8 h-8 text-xl': !isMobile(), 'w-6 h-6 text-lg': isMobile()}"
                title="新建项目" aria-label="新建项目">+</button>
        <!-- 移动端关闭侧边栏按钮 -->
        @if (isMobile()) {
          <button (click)="isSidebarOpen.set(false)" 
                  class="text-stone-400 hover:text-stone-600 w-6 h-6 flex items-center justify-center rounded-full transition-all active:bg-stone-200"
                  title="关闭" aria-label="关闭侧边栏">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        }
      </div>
    </div>

    <!-- Project List -->
    <div class="flex-1 overflow-y-auto space-y-1"
         [ngClass]="{'px-4': !isMobile(), 'px-2': isMobile()}">
      <!-- 统一搜索框（模糊搜索项目和任务） -->
      <div class="mb-3 relative">
        <input 
          type="text" 
          [ngModel]="unifiedSearchQuery()" 
          (ngModelChange)="onUnifiedSearchChange($event)"
          placeholder="搜索项目或任务..."
          class="w-full px-3 py-2 text-xs border border-stone-200 rounded-lg bg-white/80 focus:outline-none focus:ring-1 focus:ring-indigo-300 focus:border-indigo-300 transition-all pl-8"
          aria-label="搜索项目或任务">
        <svg class="absolute left-2.5 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-stone-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
        @if (unifiedSearchQuery()) {
          <button 
            (click)="clearUnifiedSearch()" 
            class="absolute right-2 top-1/2 -translate-y-1/2 text-stone-400 hover:text-stone-600"
            aria-label="清除搜索">
            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        }
      </div>
      
      <!-- 搜索结果 -->
      @if (unifiedSearchQuery() && searchResults().length > 0) {
        <div class="mb-3 p-2 bg-indigo-50 rounded-lg border border-indigo-100 animate-fade-in">
          <div class="text-[10px] font-semibold text-indigo-600 mb-1.5 uppercase tracking-wide">
            任务搜索结果 ({{searchResults().length}})
          </div>
          <div class="space-y-1 max-h-48 overflow-y-auto">
            @for (task of searchResults(); track task.id) {
              <div 
                (click)="setActiveProjectId(activeProject()?.id ?? null); onFocusFlowNode(task.id)"
                class="px-2 py-1.5 bg-white rounded-md text-xs cursor-pointer hover:bg-indigo-100 transition-colors group">
                <div class="flex items-center gap-1.5">
                  <span class="font-mono text-[9px] text-indigo-400">{{task.shortId || compressDisplayId(task.displayId)}}</span>
                  <span class="font-medium text-stone-700 truncate group-hover:text-indigo-700">{{task.title || '未命名'}}</span>
                </div>
              </div>
            }
          </div>
        </div>
      } @else if (unifiedSearchQuery() && searchResults().length === 0 && filteredProjects().length === projects().length) {
        <div class="mb-3 p-2 bg-stone-50 rounded-lg text-xs text-stone-400 text-center">
          未找到匹配的项目或任务
        </div>
      }
      
      <!-- 项目搜索提示 -->
      @if (unifiedSearchQuery() && filteredProjects().length > 0 && filteredProjects().length < projects().length) {
        <div class="mb-2 text-[10px] text-emerald-600 font-medium">
          匹配项目 ({{filteredProjects().length}}/{{projects().length}})
        </div>
      }
      
      @for (proj of filteredProjects(); track proj.id) {
        <div class="space-y-2">
          <div data-testid="project-item" [attr.data-project-id]="proj.id"
               (click)="selectProject(proj.id)" (dblclick)="handleProjectDoubleClick(proj.id, $event)" 
               class="rounded-lg cursor-pointer transition-all duration-200 group hover:bg-stone-100" 
               [ngClass]="{'px-4 py-3': !isMobile(), 'px-2 py-2': isMobile()}"
               [class.bg-indigo-100]="activeProjectId() === proj.id" 
               [class.text-indigo-900]="activeProjectId() === proj.id" 
               [class.text-stone-500]="activeProjectId() !== proj.id">
            <div class="flex items-center justify-between gap-1 min-w-0">
              @if (renamingProjectId() === proj.id) {
                <!-- 重命名输入框 -->
                <input 
                  type="text"
                  class="flex-1 min-w-0 font-medium bg-white border border-indigo-300 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-indigo-400"
                  [ngClass]="{'text-sm': !isMobile(), 'text-xs': isMobile()}"
                  [ngModel]="renameProjectName()"
                  (ngModelChange)="renameProjectName.set($event)"
                  (keydown)="onRenameKeydown($event)"
                  (blur)="executeRenameProject()"
                  (click)="$event.stopPropagation()"
                  #renameInput
                  autofocus
                  aria-label="重命名项目">
              } @else {
                <div class="font-medium transition-colors flex-1 min-w-0 truncate"
                     [ngClass]="{'text-sm': !isMobile(), 'text-xs': isMobile()}">{{ proj.name }}</div>
                @if (activeProjectId() === proj.id) {
                  <button 
                    (click)="startRenameProject(proj.id, proj.name, $event)"
                    class="opacity-0 group-hover:opacity-100 p-1 rounded hover:bg-indigo-200/50 transition-all flex-shrink-0"
                    title="重命名项目"
                    aria-label="重命名项目">
                    <svg class="w-3.5 h-3.5 text-indigo-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                  </button>
                }
              }
            </div>
            @if (activeProjectId() === proj.id) {
              <div class="text-[10px] text-indigo-400 mt-1 animate-fade-in leading-relaxed font-mono">
                {{ proj.createdDate | date:'MM/dd' }}
              </div>
            }
          </div>

          @if (expandedProjectId() === proj.id) {
            @if (projectDraft(proj.id); as draft) {
              <div class="mt-1 mb-2 rounded-lg border border-stone-200 bg-white/90 text-stone-600 shadow-sm cursor-default animate-fade-in" 
                   [ngClass]="{'mx-4 p-3 space-y-2 text-xs rounded-xl': !isMobile(), 'mx-1 p-2 space-y-1.5 text-[10px]': isMobile()}"
                   (click)="$event.stopPropagation()"
                   (touchstart)="$event.stopPropagation()">
                <!-- 创建时间和简介合并为紧凑布局 -->
                <div class="flex items-start gap-2 text-stone-400">
                  <svg class="w-3 h-3 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                  <span class="text-stone-500 text-[11px]">{{ proj.createdDate | date:'yyyy-MM-dd HH:mm' }}</span>
                </div>
                <!-- 简介 -->
                <div class="flex flex-col gap-0.5">
                  @if (isEditingDescription()) {
                    <div class="animate-fade-in flex gap-1.5 items-end" (click)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()">
                      <textarea
                        [rows]="isMobile() ? 2 : 2"
                        class="flex-1 border border-stone-200 rounded text-stone-600 bg-transparent focus:outline-none focus:ring-1 focus:ring-indigo-300 resize-none touch-manipulation text-[11px]"
                        [ngClass]="{'px-2 py-1.5': !isMobile(), 'px-2 py-1 text-[10px]': isMobile()}"
                        [ngModel]="draft.description"
                        (ngModelChange)="updateProjectDraft(proj.id, 'description', $event)"
                        (click)="$event.stopPropagation()"
                        (touchstart)="$event.stopPropagation()"
                        (focus)="$event.stopPropagation()"
                        spellcheck="false"
                        placeholder="添加项目简介..."
                        aria-label="项目简介"></textarea>
                      <button
                        type="button"
                        class="rounded bg-indigo-600 text-white font-medium hover:bg-indigo-500 transition px-2 py-1.5 text-[11px] flex-shrink-0"
                        (click)="saveProjectDetails(proj.id); $event.stopPropagation()">
                        保存
                      </button>
                    </div>
                  } @else {
                    <div 
                      class="w-full text-stone-500 whitespace-pre-wrap hover:bg-stone-50 rounded px-2 py-1 transition-colors cursor-text text-[11px] line-clamp-2"
                      [ngClass]="{'min-h-[1.5em]': !isMobile(), 'text-[10px]': isMobile()}"
                      (click)="isEditingDescription.set(true); $event.stopPropagation()"
                      (touchend)="isEditingDescription.set(true); $event.stopPropagation()"
                      title="点击编辑简介"
                      role="button"
                      tabindex="0"
                      (keydown.enter)="isEditingDescription.set(true); $event.stopPropagation()">
                      {{ draft.description || '点击添加简介...' }}
                    </div>
                  }
                </div>
                <!-- 操作按钮区 -->
                <div class="flex border-t border-stone-100 pt-2 gap-2">
                  <!-- 进入项目按钮 -->
                  <button
                    type="button"
                    class="flex-1 rounded bg-indigo-500 hover:bg-indigo-600 text-white font-medium transition-colors flex items-center justify-center px-2 py-1.5 text-[11px] gap-1"
                    (click)="enterProject(proj.id); $event.stopPropagation()">
                    <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                    </svg>
                    进入项目
                  </button>
                  <!-- 删除项目按钮 -->
                  <button
                    type="button"
                    class="rounded bg-stone-50 hover:bg-red-50 text-stone-400 hover:text-red-500 font-medium transition-colors flex items-center justify-center px-2 py-1.5 text-[11px] disabled:opacity-50 disabled:cursor-not-allowed"
                    [disabled]="isDeleting?.() ?? false"
                    (click)="confirmDeleteProject(proj.id, proj.name, $event)"
                    title="删除项目">
                    <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                  </button>
                </div>
              </div>
            }
          }
        </div>
      }
    </div>
    
    <!-- Sidebar Footer -->
    <div class="mb-4 shrink-0 space-y-2"
         [ngClass]="{'mx-4': !isMobile(), 'mx-2': isMobile()}">
      <!-- 嵌入式同步状态组件 -->
      <app-sync-status data-testid="sync-status" [embedded]="true"></app-sync-status>
      
      <!-- 配置帮助按钮(仅在配置错误时显示) -->
      @if (offlineMode() && supabaseClient.configurationError()) {
        <button 
          (click)="modal.show('configHelp'); $event.stopPropagation()" 
          class="w-full px-3 py-2 text-[11px] text-amber-600 hover:text-amber-700 hover:bg-amber-50 rounded-lg transition-colors flex items-center justify-center gap-1.5"
          title="查看配置指南">
          <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          配置帮助
        </button>
      }
      
      <!-- 会话过期警告 -->
      @if (sessionExpired()) {
        <div class="flex items-center gap-2 px-3 py-2 rounded-lg text-xs bg-red-50 text-red-600">
          <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <span>登录已过期</span>
          <button (click)="startRelogin()" class="ml-auto underline hover:no-underline">重新登录</button>
        </div>
      }
      
      <!-- 登录/用户状态按钮 -->
      @if (currentUserId()) {
        <button data-testid="user-menu" (click)="openSettings()" class="w-full py-2.5 px-3 text-emerald-600 hover:text-emerald-700 hover:bg-emerald-50 rounded-lg text-xs font-medium transition-all flex items-center gap-2.5" aria-label="已登录用户">
          <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <span class="truncate">{{ sessionEmail() || '已登录' }}</span>
        </button>
      } @else {
        <button data-testid="login-btn" (click)="modal.show('login')" class="w-full py-2.5 px-3 text-indigo-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-lg text-xs font-medium transition-all flex items-center gap-2.5" aria-label="登录">
          <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/>
          </svg>
          登录同步
        </button>
      }
      
      <button (click)="openSettings()" class="w-full py-2.5 px-3 text-stone-500 hover:text-stone-800 hover:bg-stone-100 rounded-lg text-xs font-medium transition-all flex items-center gap-2.5" aria-label="打开设置">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
        系统设置
      </button>
      
      <!-- 回收站按钮 -->
      <button (click)="modal.show('trash')" class="w-full py-2.5 px-3 text-stone-500 hover:text-stone-800 hover:bg-stone-100 rounded-lg text-xs font-medium transition-all flex items-center gap-2.5" aria-label="打开回收站">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
        </svg>
        回收站
        @if (deletedTasks().length > 0) {
          <span class="ml-auto bg-stone-200 text-stone-600 text-[10px] px-1.5 py-0.5 rounded-full">{{ deletedTasks().length }}</span>
        }
      </button>
    </div>
  </aside>

  <!-- Sidebar Resizer -->
  @if (!isMobile()) {
    <div class="w-1 hover:w-1.5 bg-transparent hover:bg-stone-300 cursor-col-resize transition-all z-20 flex-shrink-0 relative group"
         (mousedown)="startSidebarResize($event)">
         <div class="absolute inset-y-0 left-0 w-px bg-stone-200 group-hover:bg-stone-400 transition-colors"></div>
    </div>
  }

  <!-- Main Content - 使用 router-outlet 渲染子路由组件 -->
  <main class="flex-1 flex relative responsive-stack overflow-hidden min-h-0" style="background-color: var(--theme-bg);"
        role="main"
        aria-label="任务管理区域"
        (touchstart)="onMainTouchStart($event)"
        (touchmove)="onMainTouchMove($event)"
        (touchend)="onMainTouchEnd($event)">
    
    <!-- 未登录提示界面 - 当用户关闭登录模态框但仍未登录时显示 -->
    @if (showLoginRequired()) {
      <div class="absolute inset-0 flex items-center justify-center p-4" style="background-color: var(--theme-bg);">
        <div class="max-w-sm w-full text-center space-y-6 animate-fade-in">
          <!-- 图标 -->
          <div class="mx-auto w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center">
            <svg class="w-10 h-10 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
          </div>
          
          <!-- 标题 -->
          <div>
            <h2 class="text-xl font-bold text-stone-800 mb-2">请先登录</h2>
            <p class="text-sm text-stone-500">登录后即可访问您的任务和项目</p>
          </div>
          
          <!-- 登录按钮 -->
          <button 
            (click)="modal.show('login')"
            class="w-full py-3 px-6 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-xl transition-colors flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/>
            </svg>
            登录账号
          </button>
          
          <!-- 移动端：打开侧边栏提示 -->
          @if (isMobile()) {
            <p class="text-xs text-stone-400">
              或者 <button (click)="isSidebarOpen.set(true)" class="text-indigo-600 hover:underline">打开侧边栏</button> 查看更多选项
            </p>
          }
        </div>
      </div>
    }
    
    <router-outlet></router-outlet>
  </main>

  <!-- Settings Modal -->
  @if (showSettings()) {
    <app-settings-modal
      [sessionEmail]="sessionEmail()"
      (close)="closeSettings()"
      (signOut)="signOut()"
      (themeChange)="updateTheme($event)"
      (openDashboard)="openDashboardFromSettings()">
    </app-settings-modal>
  }
  
  <!-- New Project Modal -->
  @if(showNewProjectModal()) {
    <app-new-project-modal
      (close)="modal.closeByType('newProject')"
      (confirm)="confirmCreateProject($event.name, $event.description)">
    </app-new-project-modal>
  }
  
  <!-- Delete Project Modal 已迁移到动态渲染，不再需要模板条件 -->
  
  <!-- Login Modal -->
  @if (showLoginModal()) {
    <app-login-modal
      [authError]="authError()"
      [isLoading]="isAuthLoading()"
      [resetPasswordSent]="resetPasswordSent()"
      (close)="modal.closeByType('login', { success: false })"
      (login)="handleLoginFromModal($event)"
      (signup)="handleSignupFromModal($event)"
      (resetPassword)="handleResetPasswordFromModal($event)"
      (localMode)="handleLocalModeFromModal()">
    </app-login-modal>
  }
  
  <!-- Conflict Resolution Modal -->
  @if (showConflictModal() && conflictData()) {
    <app-conflict-modal
      [conflictData]="conflictData()"
      (resolveLocal)="resolveConflictLocal()"
      (resolveRemote)="resolveConflictRemote()"
      (resolveMerge)="resolveConflictMerge()"
      (cancel)="cancelConflictResolution()">
    </app-conflict-modal>
  }

  <!-- 配置帮助对话框 -->
  @if (modal.isOpen('configHelp')) {
    <app-config-help-modal (close)="modal.closeByType('configHelp')"></app-config-help-modal>
  }
  
  <!-- 回收站模态框 -->
  <app-trash-modal 
    [show]="showTrashModal()" 
    (close)="modal.closeByType('trash')">
  </app-trash-modal>
  
  <!-- 数据迁移对话框 -->
  @if (showMigrationModal()) {
    <app-migration-modal
      (close)="closeMigrationModal()"
      (migrated)="handleMigrationComplete()">
    </app-migration-modal>
  }
  
  <!-- 错误恢复对话框 -->
  @if (errorHandler.recoverableError(); as error) {
    <app-error-recovery-modal
      [title]="error.title"
      [message]="error.message"
      [details]="error.details"
      [options]="error.options"
      [defaultOptionId]="error.defaultOptionId"
      [autoSelectIn]="error.autoSelectIn ?? null"
      (select)="error.resolve($event.optionId)"
      (close)="errorHandler.dismissRecoveryDialog()">
    </app-error-recovery-modal>
  }
  
  <!-- 存储失败逃生模态框 -->
  <app-storage-escape-modal
    [show]="showStorageEscapeModal()"
    [data]="storageEscapeData()"
    (close)="closeStorageEscapeModal()">
  </app-storage-escape-modal>
  
  <!-- 系统仪表盘模态框 -->
  @if (modal.isOpen('dashboard')) {
    <app-dashboard-modal
      (close)="modal.closeByType('dashboard')"
      (openConflictCenter)="openConflictCenterFromDashboard()">
    </app-dashboard-modal>
  }

</div>
  </app-error-boundary>
</div>
