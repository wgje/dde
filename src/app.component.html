

<div class="flex h-full w-full overflow-hidden font-sans" style="background-color: var(--theme-bg); color: var(--theme-text);">
  
  <!-- Toast 通知容器 -->
  <app-toast-container></app-toast-container>
  
  <!-- Left Sidebar: Project List -->
  <aside class="border-r flex flex-col shrink-0 transition-all duration-75 shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-10 overflow-hidden" style="background-color: var(--theme-sidebar-bg); border-color: var(--theme-border);"
         [style.width.px]="isSidebarOpen() ? store.sidebarWidth() : 0"
         [class.w-0]="!isSidebarOpen()"
         (touchstart)="onSidebarTouchStart($event)"
         (touchmove)="onSidebarTouchMove($event)"
         (touchend)="onSidebarTouchEnd($event)"
         role="navigation"
         aria-label="项目导航">
    
    <!-- Sidebar Header -->
    <div class="mx-6 mt-8 mb-6 flex justify-between items-center min-w-[200px] shrink-0">
      <h1 class="font-bold text-2xl text-stone-800 tracking-tight font-serif">NanoFlow</h1>
      <button (click)="createNewProject()" class="text-stone-400 hover:text-stone-800 hover:bg-stone-200/50 w-8 h-8 flex items-center justify-center rounded-full transition-all text-xl font-light" title="新建项目" aria-label="新建项目">+</button>
    </div>

    <!-- Project List -->
    <div class="flex-1 overflow-y-auto px-4 space-y-1 min-w-[240px]">
      <!-- 全局搜索框 -->
      <div class="mb-3 relative">
        <input 
          type="text" 
          [ngModel]="store.searchQuery()" 
          (ngModelChange)="store.searchQuery.set($event)"
          placeholder="搜索任务..."
          class="w-full px-3 py-2 text-xs border border-stone-200 rounded-lg bg-white/80 focus:outline-none focus:ring-1 focus:ring-indigo-300 focus:border-indigo-300 transition-all pl-8"
          aria-label="搜索任务">
        <svg class="absolute left-2.5 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-stone-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
        @if (store.searchQuery()) {
          <button 
            (click)="store.searchQuery.set('')" 
            class="absolute right-2 top-1/2 -translate-y-1/2 text-stone-400 hover:text-stone-600"
            aria-label="清除搜索">
            <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        }
      </div>
      
      <!-- 搜索结果 -->
      @if (store.searchQuery() && store.searchResults().length > 0) {
        <div class="mb-3 p-2 bg-indigo-50 rounded-lg border border-indigo-100 animate-fade-in">
          <div class="text-[10px] font-semibold text-indigo-600 mb-1.5 uppercase tracking-wide">
            搜索结果 ({{store.searchResults().length}})
          </div>
          <div class="space-y-1 max-h-48 overflow-y-auto">
            @for (task of store.searchResults(); track task.id) {
              <div 
                (click)="store.activeProjectId.set(store.activeProject()?.id ?? null); onFocusFlowNode(task.id)"
                class="px-2 py-1.5 bg-white rounded-md text-xs cursor-pointer hover:bg-indigo-100 transition-colors group">
                <div class="flex items-center gap-1.5">
                  <span class="font-mono text-[9px] text-indigo-400">{{store.compressDisplayId(task.displayId)}}</span>
                  <span class="font-medium text-stone-700 truncate group-hover:text-indigo-700">{{task.title || '未命名'}}</span>
                </div>
              </div>
            }
          </div>
        </div>
      } @else if (store.searchQuery() && store.searchResults().length === 0) {
        <div class="mb-3 p-2 bg-stone-50 rounded-lg text-xs text-stone-400 text-center">
          未找到匹配的任务
        </div>
      }
      
      @for (proj of store.projects(); track proj.id) {
        <div class="space-y-2">
          <div (click)="selectProject(proj.id)" (dblclick)="handleProjectDoubleClick(proj.id, $event)" class="px-4 py-3 rounded-lg cursor-pointer transition-all duration-200 group hover:bg-stone-100" [class.bg-indigo-100]="store.activeProjectId() === proj.id" [class.text-indigo-900]="store.activeProjectId() === proj.id" [class.text-stone-500]="store.activeProjectId() !== proj.id">
            <div class="font-medium text-sm transition-colors">{{ proj.name }}</div>
            @if (store.activeProjectId() === proj.id) {
              <div class="text-[10px] text-indigo-400 mt-1 animate-fade-in leading-relaxed font-mono">
                {{ proj.createdDate | date:'MM/dd' }}
              </div>
            }
          </div>

          @if (expandedProjectId() === proj.id) {
            @if (projectDraft(proj.id); as draft) {
              <div class="mx-4 mt-1 mb-3 p-4 rounded-xl border border-stone-200 bg-white/90 text-xs text-stone-600 space-y-3 shadow-sm cursor-default animate-fade-in" 
                   (click)="$event.stopPropagation()"
                   (touchstart)="$event.stopPropagation()">
                <div class="flex flex-col gap-1">
                  <label class="font-semibold text-[11px] text-stone-400 uppercase tracking-wide">创建时间</label>
                  <div class="w-full border border-transparent px-3 py-2 text-stone-500">
                    {{ proj.createdDate | date:'yyyy-MM-dd HH:mm' }}
                  </div>
                </div>
                <div class="flex flex-col gap-1">
                  <label class="font-semibold text-[11px] text-stone-400 uppercase tracking-wide">简介</label>
                  @if (isEditingDescription()) {
                    <div class="animate-fade-in" (click)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()">
                      <textarea
                        rows="3"
                        class="w-full border border-stone-200 rounded-lg px-3 py-2 text-stone-600 bg-transparent focus:outline-none focus:ring-1 focus:ring-indigo-300 resize-none touch-manipulation"
                        [ngModel]="draft.description"
                        (ngModelChange)="updateProjectDraft(proj.id, 'description', $event)"
                        (click)="$event.stopPropagation()"
                        (touchstart)="$event.stopPropagation()"
                        (focus)="$event.stopPropagation()"
                        aria-label="项目简介"></textarea>
                      <div class="flex justify-end mt-1">
                        <button
                          type="button"
                          class="px-4 py-2 rounded-lg bg-indigo-600 text-white text-xs font-medium hover:bg-indigo-500 transition"
                          (click)="saveProjectDetails(proj.id); $event.stopPropagation()">
                          保存
                        </button>
                      </div>
                    </div>
                  } @else {
                    <div 
                      class="w-full border border-transparent px-3 py-2 text-stone-600 whitespace-pre-wrap min-h-[3em] hover:bg-stone-50 rounded-lg transition-colors cursor-text"
                      (click)="isEditingDescription.set(true); $event.stopPropagation()"
                      (touchend)="isEditingDescription.set(true); $event.stopPropagation()"
                      title="点击编辑"
                      role="button"
                      tabindex="0"
                      (keydown.enter)="isEditingDescription.set(true); $event.stopPropagation()">
                      {{ draft.description || '无简介' }}
                    </div>
                  }
                </div>
                <!-- 删除项目按钮 -->
                <div class="pt-2 border-t border-stone-100">
                  <button
                    type="button"
                    class="w-full px-3 py-2 rounded-lg bg-stone-50 hover:bg-red-50 text-stone-400 hover:text-red-500 text-xs font-medium transition-colors flex items-center justify-center gap-1.5"
                    (click)="confirmDeleteProject(proj.id, proj.name, $event)">
                    <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                    删除项目
                  </button>
                </div>
              </div>
            }
          }
        </div>
      }
    </div>
    
    <!-- Sidebar Footer -->
    <div class="mx-4 mb-6 min-w-[200px] shrink-0 space-y-2">
      <!-- 网络/同步状态指示器 -->
      @if (!store.isOnline() || store.offlineMode() || store.isSyncing() || store.sessionExpired()) {
        <div class="flex items-center gap-2 px-4 py-2 rounded-lg text-xs animate-fade-in"
             [class.bg-red-50]="!store.isOnline() || store.sessionExpired()"
             [class.text-red-600]="!store.isOnline() || store.sessionExpired()"
             [class.bg-amber-50]="store.isOnline() && store.offlineMode() && !store.sessionExpired()"
             [class.text-amber-600]="store.isOnline() && store.offlineMode() && !store.sessionExpired()"
             [class.bg-indigo-50]="store.isOnline() && store.isSyncing() && !store.offlineMode() && !store.sessionExpired()"
             [class.text-indigo-600]="store.isOnline() && store.isSyncing() && !store.offlineMode() && !store.sessionExpired()">
          @if (store.sessionExpired()) {
            <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <span>登录已过期</span>
            <button (click)="startRelogin()" class="ml-1 underline hover:no-underline">重新登录</button>
          } @else if (!store.isOnline()) {
            <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"/>
              <line x1="2" y1="2" x2="22" y2="22" stroke-linecap="round"/>
            </svg>
            <span>网络已断开</span>
          } @else if (store.isSyncing()) {
            <svg class="w-3.5 h-3.5 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 12a9 9 0 11-6.219-8.56"/>
            </svg>
            <span>正在同步...</span>
          } @else if (store.offlineMode()) {
            <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M18.364 5.636a9 9 0 010 12.728m-3.536-3.536a4 4 0 010-5.656m-7.072 7.072a9 9 0 010-12.728m3.536 3.536a4 4 0 010 5.656"/>
              <line x1="4" y1="4" x2="20" y2="20" stroke-linecap="round"/>
            </svg>
            <span>离线模式</span>
            @if (supabaseClient.configurationError()) {
              <button (click)="showConfigHelp.set(true); $event.stopPropagation()" class="ml-1 text-amber-700 hover:text-amber-900 underline hover:no-underline text-[10px]" title="查看配置指南">
                配置帮助
              </button>
            }
          }
        </div>
      }
      
      <!-- 登录/用户状态按钮 -->
      @if (store.currentUserId()) {
        <button (click)="openSettings()" class="w-full py-3 px-4 text-emerald-600 hover:text-emerald-700 hover:bg-emerald-50 rounded-xl text-xs font-medium transition-all flex items-center gap-3" aria-label="已登录用户">
          <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <span class="truncate">{{ sessionEmail() || '已登录' }}</span>
        </button>
      } @else {
        <button (click)="showLoginModal.set(true)" class="w-full py-3 px-4 text-indigo-600 hover:text-indigo-700 hover:bg-indigo-50 rounded-xl text-xs font-medium transition-all flex items-center gap-3" aria-label="登录">
          <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/>
          </svg>
          登录同步
        </button>
      }
      
      <button (click)="openSettings()" class="w-full py-3 px-4 text-stone-500 hover:text-stone-800 hover:bg-stone-100 rounded-xl text-xs font-medium transition-all flex items-center gap-3" aria-label="打开设置">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
        全局设置
      </button>
    </div>
  </aside>

  <!-- Sidebar Resizer -->
  @if (!store.isMobile()) {
    <div class="w-1 hover:w-1.5 bg-transparent hover:bg-stone-300 cursor-col-resize transition-all z-20 flex-shrink-0 relative group"
         (mousedown)="startSidebarResize($event)">
         <div class="absolute inset-y-0 left-0 w-px bg-stone-200 group-hover:bg-stone-400 transition-colors"></div>
    </div>
  }

  <!-- Main Content -->
  <main class="flex-1 flex relative responsive-stack overflow-x-hidden h-full overflow-hidden" style="background-color: var(--theme-bg);"
        role="main"
        aria-label="任务管理区域"
        (touchstart)="onMainTouchStart($event)"
        (touchmove)="onMainTouchMove($event)"
        (touchend)="onMainTouchEnd($event)">
    @if (store.activeProjectId()) {
      <!-- Text Column -->
      <div class="flex flex-col border-r min-w-[300px]" style="background-color: var(--theme-bg); border-color: var(--theme-border);"
           [class.hidden]="store.isMobile() && mobileActiveView() !== 'text'"
           [class.w-full]="store.isMobile()"
           [class.flex-1]="store.isMobile()"
           [class.min-h-0]="store.isMobile()"
           [style.width.%]="store.isMobile() ? 100 : store.textColumnRatio()">
        <!-- Header for Text Column -->
        <div class="shrink-0 z-10"
             [ngClass]="{'h-16 mx-6 mt-6': !store.isMobile(), 'mx-2 mt-2 mb-1': store.isMobile()}">
           <!-- Desktop Layout -->
           @if (!store.isMobile()) {
             <div class="h-full flex items-center justify-between">
               <div class="flex items-center gap-3">
                 <button (click)="toggleSidebar()" class="text-stone-400 hover:text-stone-600 transition-colors p-2 hover:bg-stone-200/50 rounded-full" aria-label="切换侧边栏" [attr.aria-expanded]="isSidebarOpen()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                 </button>
                 <span class="font-bold text-stone-800 text-lg tracking-tight">文本视图</span>
               </div>
               <!-- Filter -->
               <div class="relative flex items-center gap-2">
                 <button 
                    (click)="isFilterOpen.set(!isFilterOpen()); $event.stopPropagation()"
                    class="flex items-center gap-2 bg-transparent text-xs font-medium text-stone-500 hover:text-indigo-800 transition-colors py-1.5 px-3 rounded-lg hover:bg-indigo-50 border border-transparent active:bg-indigo-100">
                     <span>{{ currentFilterLabel() }}</span>
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 transition-transform duration-200" [class.rotate-180]="isFilterOpen()" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                     </svg>
                 </button>
                 
                 @if (isFilterOpen()) {
                    <div class="fixed inset-0 z-40" (click)="isFilterOpen.set(false)"></div>
                    <div class="absolute right-0 top-full mt-1 w-48 bg-white/90 backdrop-blur-xl border border-stone-100 rounded-xl shadow-lg z-50 py-1 animate-dropdown overflow-hidden">
                        <div 
                            (click)="store.filterMode.set('all'); isFilterOpen.set(false)"
                            class="px-4 py-2.5 text-xs text-stone-600 hover:bg-indigo-50 hover:text-indigo-900 cursor-pointer flex items-center justify-between group transition-colors">
                            <span>全部任务</span>
                            @if (store.filterMode() === 'all') { <span class="text-indigo-600 font-bold">✓</span> }
                        </div>
                        <div class="h-px bg-stone-100 my-1"></div>
                        @for(root of store.rootTasks(); track root.id) {
                            <div 
                                (click)="store.filterMode.set(root.id); isFilterOpen.set(false)"
                                class="px-4 py-2.5 text-xs text-stone-600 hover:bg-indigo-50 hover:text-indigo-900 cursor-pointer flex items-center justify-between group transition-colors">
                                <span class="truncate">{{root.title}}</span>
                                @if (store.filterMode() === root.id) { <span class="text-indigo-600 font-bold">✓</span> }
                            </div>
                        }
                    </div>
                 }
               </div>
             </div>
           }
           
           <!-- Mobile Layout: Compact -->
           @if (store.isMobile()) {
             <div class="flex items-center justify-between gap-2">
               <!-- Left: Menu + Title -->
               <div class="flex items-center gap-2 min-w-0">
                 <button (click)="toggleSidebar()" class="btn-compact text-stone-400 p-1 rounded-lg active:bg-stone-200/50 shrink-0" aria-label="菜单">
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                 </button>
                 <span class="font-medium text-stone-700 text-xs">文本</span>
               </div>
               
               <!-- Right: Filter + Switch -->
               <div class="flex items-center gap-1 shrink-0">
                 <!-- Compact Filter -->
                 <button 
                    (click)="isFilterOpen.set(!isFilterOpen()); $event.stopPropagation()"
                    class="btn-compact flex items-center gap-1 text-[10px] text-stone-500 py-0.5 px-1.5 rounded bg-stone-100/80 active:bg-stone-200 max-w-[80px]">
                     <span class="truncate">{{ currentFilterLabel() }}</span>
                     <svg class="h-2 w-2 shrink-0" [class.rotate-180]="isFilterOpen()" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                     </svg>
                 </button>
                 
                 <!-- Switch Button -->
                 <button (click)="switchToFlow()" class="btn-compact bg-indigo-500 text-white px-2 py-0.5 rounded text-[10px] font-medium active:bg-indigo-600">
                    流程图
                 </button>
               </div>
             </div>
             
             <!-- Mobile Filter Dropdown -->
             @if (isFilterOpen()) {
                <div class="fixed inset-0 z-40" (click)="isFilterOpen.set(false)"></div>
                <div class="absolute right-3 top-12 w-44 bg-white/95 backdrop-blur-xl border border-stone-200 rounded-lg shadow-xl z-50 py-1 animate-dropdown overflow-hidden">
                    <div 
                        (click)="store.filterMode.set('all'); isFilterOpen.set(false)"
                        class="px-3 py-2 text-xs text-stone-600 active:bg-indigo-50 cursor-pointer flex items-center justify-between">
                        <span>全部任务</span>
                        @if (store.filterMode() === 'all') { <span class="text-indigo-600 font-bold">✓</span> }
                    </div>
                    <div class="h-px bg-stone-100"></div>
                    @for(root of store.rootTasks(); track root.id) {
                        <div 
                            (click)="store.filterMode.set(root.id); isFilterOpen.set(false)"
                            class="px-3 py-2 text-xs text-stone-600 active:bg-indigo-50 cursor-pointer flex items-center justify-between">
                            <span class="truncate">{{root.title}}</span>
                            @if (store.filterMode() === root.id) { <span class="text-indigo-600 font-bold">✓</span> }
                        </div>
                    }
                </div>
             }
           }
        </div>
        <app-text-view class="flex-1 min-h-0 overflow-hidden" (focusFlowNode)="onFocusFlowNode($event)"></app-text-view>
      </div>

      <!-- Content Resizer -->
      @if(!store.isMobile()) {
        <div class="w-1 hover:w-1.5 bg-transparent hover:bg-stone-300 cursor-col-resize z-20 flex-shrink-0 relative group"
             (mousedown)="startContentResize($event)">
             <div class="absolute inset-y-0 left-0 w-px bg-stone-200 group-hover:bg-stone-400 transition-colors"></div>
        </div>
      }

      <!-- Flow Column -->
      <div class="flex-1 flex flex-col min-w-[300px] relative" style="background-color: var(--theme-bg);"
           [class.hidden]="store.isMobile() && mobileActiveView() !== 'flow'"
           [class.w-full]="store.isMobile()">
         <div class="flex items-center justify-between shrink-0 z-10"
              [ngClass]="{'h-16 mx-6 mt-6': !store.isMobile(), 'mx-2 mt-2 mb-1': store.isMobile()}">
            <span class="font-medium text-stone-700" [ngClass]="{'text-lg font-bold text-stone-800': !store.isMobile(), 'text-xs': store.isMobile()}">
              @if (store.isMobile()) { 流程图 } @else { 流程视图 }
            </span>
            @if(store.isMobile()) {
                <button (click)="mobileActiveView.set('text')" class="btn-compact bg-indigo-500 text-white px-2 py-0.5 rounded text-[10px] font-medium active:bg-indigo-600">
                    文本
                </button>
            }
         </div>
         <app-flow-view class="flex-1 overflow-hidden" (goBackToText)="switchToText()"></app-flow-view>
      </div>
    } @else {
      <div class="flex-1 flex items-center justify-center text-stone-300 flex-col gap-6 p-4">
        <div class="w-24 h-24 rounded-full bg-stone-100 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 opacity-40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
        </div>
        <p class="font-light tracking-widest text-sm text-center">请选择或创建一个项目</p>
        @if (store.projects().length === 0) {
          <button (click)="createNewProject()" class="px-6 py-3 bg-indigo-600 text-white rounded-xl text-sm font-medium hover:bg-indigo-500 transition-all shadow-lg hover:shadow-xl">
            + 创建第一个项目
          </button>
        }
      </div>
    }
  </main>

  <!-- Settings Modal Overlay -->
  @if (showSettings()) {
    <div class="fixed inset-0 bg-black/30 z-50 flex items-center justify-center backdrop-blur-sm animate-fade-in p-4" (click)="closeSettings()">
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 animate-scale-in max-h-[90vh] overflow-y-auto" (click)="$event.stopPropagation()">
        <h2 class="text-xl font-bold mb-5 text-slate-800">设置</h2>
        
        <div class="space-y-5">
          <!-- 主题设置 -->
          <div class="rounded-xl border border-stone-200 bg-stone-50/60 p-4 shadow-sm space-y-4">
            <div>
              <div class="text-[11px] font-semibold text-stone-400 uppercase tracking-wide mb-1">外观</div>
              <div class="text-sm font-semibold text-stone-800">主题风格</div>
            </div>
            
            <div class="grid grid-cols-5 gap-2">
              <!-- 默认主题 -->
              <button (click)="updateTheme('default')" 
                      class="flex flex-col items-center gap-1.5 p-2 rounded-lg border-2 transition-all"
                      [class.border-indigo-500]="store.theme() === 'default'"
                      [class.bg-indigo-50]="store.theme() === 'default'"
                      [class.border-stone-200]="store.theme() !== 'default'"
                      [class.hover:border-stone-300]="store.theme() !== 'default'">
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-stone-100 to-stone-300 border border-stone-300"></div>
                <span class="text-[10px] text-stone-600">默认</span>
              </button>
              
              <!-- 海洋主题 -->
              <button (click)="updateTheme('ocean')" 
                      class="flex flex-col items-center gap-1.5 p-2 rounded-lg border-2 transition-all"
                      [class.border-sky-500]="store.theme() === 'ocean'"
                      [class.bg-sky-50]="store.theme() === 'ocean'"
                      [class.border-stone-200]="store.theme() !== 'ocean'"
                      [class.hover:border-stone-300]="store.theme() !== 'ocean'">
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-sky-200 to-cyan-400 border border-sky-300"></div>
                <span class="text-[10px] text-stone-600">海洋</span>
              </button>
              
              <!-- 森林主题 -->
              <button (click)="updateTheme('forest')" 
                      class="flex flex-col items-center gap-1.5 p-2 rounded-lg border-2 transition-all"
                      [class.border-green-500]="store.theme() === 'forest'"
                      [class.bg-green-50]="store.theme() === 'forest'"
                      [class.border-stone-200]="store.theme() !== 'forest'"
                      [class.hover:border-stone-300]="store.theme() !== 'forest'">
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-green-200 to-emerald-400 border border-green-300"></div>
                <span class="text-[10px] text-stone-600">森林</span>
              </button>
              
              <!-- 日落主题 -->
              <button (click)="updateTheme('sunset')" 
                      class="flex flex-col items-center gap-1.5 p-2 rounded-lg border-2 transition-all"
                      [class.border-orange-500]="store.theme() === 'sunset'"
                      [class.bg-orange-50]="store.theme() === 'sunset'"
                      [class.border-stone-200]="store.theme() !== 'sunset'"
                      [class.hover:border-stone-300]="store.theme() !== 'sunset'">
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-orange-200 to-red-400 border border-orange-300"></div>
                <span class="text-[10px] text-stone-600">日落</span>
              </button>
              
              <!-- 薰衣草主题 -->
              <button (click)="updateTheme('lavender')" 
                      class="flex flex-col items-center gap-1.5 p-2 rounded-lg border-2 transition-all"
                      [class.border-purple-500]="store.theme() === 'lavender'"
                      [class.bg-purple-50]="store.theme() === 'lavender'"
                      [class.border-stone-200]="store.theme() !== 'lavender'"
                      [class.hover:border-stone-300]="store.theme() !== 'lavender'">
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-200 to-fuchsia-400 border border-purple-300"></div>
                <span class="text-[10px] text-stone-600">薰衣草</span>
              </button>
            </div>
          </div>
          
          <!-- 账户信息 (只读显示) -->
          <div class="rounded-xl border border-stone-200 bg-stone-50/60 p-4 shadow-sm space-y-3">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-[11px] font-semibold text-stone-400 uppercase tracking-wide">账户</div>
                <div class="text-sm font-semibold text-stone-800">同步状态</div>
              </div>
              <span class="px-2.5 py-1 text-[11px] rounded-full border"
                    [class.bg-emerald-50]="store.currentUserId()"
                    [class.border-emerald-100]="store.currentUserId()"
                    [class.text-emerald-700]="store.currentUserId()"
                    [class.bg-amber-50]="!store.currentUserId()"
                    [class.border-amber-100]="!store.currentUserId()"
                    [class.text-amber-700]="!store.currentUserId()">
                @if (store.currentUserId()) { 已登录 } @else { 未登录 }
              </span>
            </div>

            <div class="text-xs text-stone-500">
              @if (store.currentUserId()) {
                当前账号：{{ sessionEmail() || "Supabase 用户" }}
              } @else {
                点击侧边栏底部的"登录同步"按钮进行登录。
              }
            </div>

            @if (store.currentUserId()) {
              <div class="flex flex-wrap gap-2 pt-1">
                <button type="button" (click)="signOut()" class="px-3 py-1.5 rounded-lg text-xs font-medium bg-red-50 text-red-600 border border-red-100 hover:bg-red-100 transition">退出登录</button>
              </div>
            }
          </div>
        </div>
        
        <div class="mt-6 flex justify-end">
          <button (click)="closeSettings()" class="px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 transition-colors text-sm font-medium">关闭</button>
        </div>
      </div>
    </div>
  }
  <!-- New Project Modal -->
  @if(showNewProjectModal()) {
      <div class="fixed inset-0 bg-black/30 z-50 flex items-center justify-center backdrop-blur-sm animate-fade-in p-4" (click)="showNewProjectModal.set(false)">
           <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 animate-scale-in" (click)="$event.stopPropagation()">
               <h2 class="text-xl font-bold mb-4 text-stone-800">新建项目</h2>
               <input #projName placeholder="项目名称" class="w-full border border-stone-200 p-3 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-300 text-stone-700" maxlength="50">
               <textarea #projDesc placeholder="项目描述（可选）" class="w-full border border-stone-200 p-3 rounded-lg mb-4 h-24 resize-none focus:outline-none focus:ring-2 focus:ring-indigo-300 text-stone-600" maxlength="500"></textarea>
               <div class="flex justify-end gap-2">
                   <button (click)="showNewProjectModal.set(false)" class="px-4 py-2 text-stone-600 hover:bg-stone-100 rounded-lg transition-colors">取消</button>
                   <button (click)="confirmCreateProject(projName.value.trim(), projDesc.value.trim())" 
                           [disabled]="!projName.value.trim()"
                           class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">创建</button>
               </div>
           </div>
      </div>
  }
  
  <!-- Delete Project Confirmation Modal -->
  @if(showDeleteProjectModal()) {
    <div class="fixed inset-0 bg-black/40 z-50 flex items-center justify-center backdrop-blur-sm animate-fade-in p-4" (click)="cancelDeleteProject()">
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 animate-scale-in" (click)="$event.stopPropagation()">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center">
            <svg class="w-5 h-5 text-red-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-stone-800">删除项目</h3>
        </div>
        <p class="text-stone-600 text-sm mb-2">确定要删除项目吗？</p>
        <p class="text-stone-800 font-medium text-sm mb-4 px-3 py-2 bg-stone-50 rounded-lg border border-stone-200 truncate">
          {{ deleteProjectTarget()?.name }}
        </p>
        <p class="text-red-500 text-xs mb-4">⚠️ 此操作将删除项目及其所有任务，且无法撤销！</p>
        <div class="flex justify-end gap-2">
          <button (click)="cancelDeleteProject()" class="px-4 py-2 text-stone-600 hover:bg-stone-100 rounded-lg transition-colors text-sm">取消</button>
          <button (click)="executeDeleteProject()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm font-medium">确认删除</button>
        </div>
      </div>
    </div>
  }
  
  <!-- Login Modal -->
  @if (showLoginModal()) {
    <div class="fixed inset-0 bg-black/30 z-50 flex items-center justify-center backdrop-blur-sm animate-fade-in p-4" (click)="showLoginModal.set(false)">
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 animate-scale-in" (click)="$event.stopPropagation()">
        <div class="flex items-center gap-3 mb-5">
          <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center">
            <svg class="w-5 h-5 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-stone-800">
              @if (isResetPasswordMode()) { 重置密码 }
              @else if (isSignupMode()) { 注册账号 }
              @else { 登录 }
            </h3>
            <p class="text-xs text-stone-500">
              @if (isResetPasswordMode()) { 输入邮箱接收重置链接 }
              @else if (isSignupMode()) { 创建新账号开始使用 }
              @else { 登录后可同步云端数据 }
            </p>
          </div>
        </div>
        
        <!-- 密码重置表单 -->
        @if (isResetPasswordMode()) {
          @if (resetPasswordSent()) {
            <div class="text-center py-4">
              <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center mx-auto mb-3">
                <svg class="w-6 h-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                </svg>
              </div>
              <p class="text-stone-700 text-sm mb-1">重置邮件已发送</p>
              <p class="text-stone-500 text-xs">请查收邮件并点击链接重置密码</p>
              <button type="button" (click)="switchToLogin()" class="mt-4 px-4 py-2 text-indigo-600 hover:bg-indigo-50 rounded-lg text-sm">返回登录</button>
            </div>
          } @else {
            <form (submit)="handleResetPassword($event)" class="space-y-4">
              <input type="email" placeholder="邮箱" 
                     [ngModel]="authEmail()" (ngModelChange)="authEmail.set($event)" 
                     [ngModelOptions]="{standalone: true}" name="resetEmail" 
                     class="w-full border border-stone-200 rounded-lg px-4 py-3 text-sm text-stone-700 bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 transition-all" 
                     autocomplete="email" required>
              
              @if (authError()) {
                <div class="text-xs text-red-500 bg-red-50 border border-red-100 rounded-lg px-3 py-2">{{ authError() }}</div>
              }
              
              <div class="flex gap-2 pt-2">
                <button type="button" (click)="switchToLogin()" class="flex-1 px-4 py-2.5 text-stone-600 hover:bg-stone-100 rounded-lg transition-colors text-sm font-medium">返回登录</button>
                <button type="submit" class="flex-1 px-4 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-sm font-semibold disabled:opacity-60" [disabled]="isAuthLoading()">
                  @if (isAuthLoading()) { 发送中... } @else { 发送重置邮件 }
                </button>
              </div>
            </form>
          }
        }
        <!-- 注册表单 -->
        @else if (isSignupMode()) {
          <form (submit)="handleSignup($event)" class="space-y-4">
            <div class="space-y-3">
              <input type="email" placeholder="邮箱" 
                     [ngModel]="authEmail()" (ngModelChange)="authEmail.set($event)" 
                     [ngModelOptions]="{standalone: true}" name="signupEmail" 
                     class="w-full border border-stone-200 rounded-lg px-4 py-3 text-sm text-stone-700 bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 transition-all" 
                     autocomplete="email" required>
              <input type="password" placeholder="密码（至少6位）" 
                     [ngModel]="authPassword()" (ngModelChange)="authPassword.set($event)" 
                     [ngModelOptions]="{standalone: true}" name="signupPassword" 
                     class="w-full border border-stone-200 rounded-lg px-4 py-3 text-sm text-stone-700 bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 transition-all" 
                     autocomplete="new-password" required minlength="6">
              <input type="password" placeholder="确认密码" 
                     [ngModel]="authConfirmPassword()" (ngModelChange)="authConfirmPassword.set($event)" 
                     [ngModelOptions]="{standalone: true}" name="signupConfirmPassword" 
                     class="w-full border border-stone-200 rounded-lg px-4 py-3 text-sm text-stone-700 bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 transition-all" 
                     autocomplete="new-password" required>
            </div>
            
            @if (authError()) {
              <div class="text-xs bg-amber-50 border border-amber-100 rounded-lg px-3 py-2"
                   [class.text-red-500]="!authError()?.includes('成功')"
                   [class.text-green-600]="authError()?.includes('成功')">{{ authError() }}</div>
            }
            
            <div class="flex gap-2 pt-2">
              <button type="button" (click)="switchToLogin()" class="flex-1 px-4 py-2.5 text-stone-600 hover:bg-stone-100 rounded-lg transition-colors text-sm font-medium">返回登录</button>
              <button type="submit" class="flex-1 px-4 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-sm font-semibold disabled:opacity-60" [disabled]="isAuthLoading()">
                @if (isAuthLoading()) { 注册中... } @else { 注册 }
              </button>
            </div>
          </form>
        }
        <!-- 登录表单 -->
        @else {
          <form (submit)="handleLogin($event, { closeSettings: false }); showLoginModal.set(false)" class="space-y-4">
            <div class="space-y-3">
              <input type="email" placeholder="邮箱" 
                     [ngModel]="authEmail()" (ngModelChange)="authEmail.set($event)" 
                     [ngModelOptions]="{standalone: true}" name="authEmailModal" 
                     class="w-full border border-stone-200 rounded-lg px-4 py-3 text-sm text-stone-700 bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 transition-all" 
                     autocomplete="email" required>
              <input type="password" placeholder="密码" 
                     [ngModel]="authPassword()" (ngModelChange)="authPassword.set($event)" 
                     [ngModelOptions]="{standalone: true}" name="authPasswordModal" 
                     class="w-full border border-stone-200 rounded-lg px-4 py-3 text-sm text-stone-700 bg-white focus:outline-none focus:ring-2 focus:ring-indigo-300 transition-all" 
                     autocomplete="current-password" required>
            </div>
            
            @if (authError()) {
              <div class="text-xs text-red-500 bg-red-50 border border-red-100 rounded-lg px-3 py-2">{{ authError() }}</div>
            }
            
            <div class="flex flex-col gap-2 pt-2">
              <div class="flex gap-2">
                <button type="button" (click)="showLoginModal.set(false)" class="flex-1 px-4 py-2.5 text-stone-600 hover:bg-stone-100 rounded-lg transition-colors text-sm font-medium">取消</button>
                <button type="submit" class="flex-1 px-4 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-sm font-semibold disabled:opacity-60" [disabled]="isAuthLoading()">
                  @if (isAuthLoading()) { 登录中... } @else { 登录 }
                </button>
              </div>
              <div class="flex justify-center gap-4 text-xs">
                <button type="button" (click)="switchToSignup()" class="text-indigo-600 hover:text-indigo-800">没有账号？注册</button>
                <button type="button" (click)="switchToResetPassword()" class="text-stone-500 hover:text-stone-700">忘记密码？</button>
              </div>
            </div>
          </form>
        }
      </div>
    </div>
  }
  
  <!-- Conflict Resolution Modal -->
  @if (showConflictModal() && conflictData()) {
    <div class="fixed inset-0 bg-black/40 z-50 flex items-center justify-center backdrop-blur-sm animate-fade-in p-4">
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 animate-scale-in max-h-[90vh] overflow-y-auto" (click)="$event.stopPropagation()">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center flex-shrink-0">
            <svg class="w-5 h-5 text-amber-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-stone-800">数据冲突</h3>
            <p class="text-xs text-stone-500">本地和云端数据存在差异，请选择解决方案</p>
          </div>
        </div>
        
        <!-- 差异概览 -->
        <div class="mb-4 p-3 bg-stone-50 rounded-lg border border-stone-200">
          <div class="text-xs font-medium text-stone-600 mb-2 flex items-center gap-1.5">
            <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            差异概览
          </div>
          <div class="grid grid-cols-3 gap-2 text-[10px]">
            <div class="p-2 bg-white rounded border border-stone-100">
              <div class="text-stone-400 mb-0.5">项目名称</div>
              <div class="font-medium text-stone-700">{{ conflictData()?.localProject?.name || conflictData()?.remoteProject?.name }}</div>
            </div>
            <div class="p-2 bg-white rounded border border-stone-100">
              <div class="text-stone-400 mb-0.5">本地任务数</div>
              <div class="font-medium text-indigo-600">{{ conflictData()?.localProject?.tasks?.length || 0 }}</div>
            </div>
            <div class="p-2 bg-white rounded border border-stone-100">
              <div class="text-stone-400 mb-0.5">云端任务数</div>
              <div class="font-medium text-teal-600">{{ conflictData()?.remoteProject?.tasks?.length || 0 }}</div>
            </div>
          </div>
        </div>
        
        <div class="grid grid-cols-2 gap-3 mb-4">
          <!-- 本地版本 -->
          <div class="p-3 rounded-lg border-2 border-stone-200 hover:border-indigo-400 transition-colors cursor-pointer group"
               (click)="resolveConflictLocal()">
            <div class="flex items-center gap-2 mb-2">
              <svg class="w-4 h-4 text-indigo-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="16" rx="2"/>
                <path d="M7 8h10M7 12h6"/>
              </svg>
              <span class="text-sm font-medium text-stone-700 group-hover:text-indigo-700">本地版本</span>
            </div>
            <div class="text-xs text-stone-500 space-y-1">
              <p class="flex items-center gap-1.5">
                <span class="w-1.5 h-1.5 rounded-full bg-indigo-400"></span>
                任务数：<span class="font-medium text-indigo-600">{{ conflictData()?.localProject?.tasks?.length || 0 }}</span>
              </p>
              <p class="flex items-center gap-1.5">
                <span class="w-1.5 h-1.5 rounded-full bg-stone-300"></span>
                修改：{{ conflictData()?.localProject?.updatedAt | date:'yyyy-MM-dd HH:mm' }}
              </p>
            </div>
            <div class="mt-2 text-[10px] text-indigo-600 bg-indigo-50 px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">
              点击选择本地版本
            </div>
          </div>
          
          <!-- 云端版本 -->
          <div class="p-3 rounded-lg border-2 border-stone-200 hover:border-teal-400 transition-colors cursor-pointer group"
               (click)="resolveConflictRemote()">
            <div class="flex items-center gap-2 mb-2">
              <svg class="w-4 h-4 text-teal-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 10h-1.26A8 8 0 109 20h9a5 5 0 000-10z"/>
              </svg>
              <span class="text-sm font-medium text-stone-700 group-hover:text-teal-700">云端版本</span>
            </div>
            <div class="text-xs text-stone-500 space-y-1">
              <p class="flex items-center gap-1.5">
                <span class="w-1.5 h-1.5 rounded-full bg-teal-400"></span>
                任务数：<span class="font-medium text-teal-600">{{ conflictData()?.remoteProject?.tasks?.length || 0 }}</span>
              </p>
              <p class="flex items-center gap-1.5">
                <span class="w-1.5 h-1.5 rounded-full bg-stone-300"></span>
                修改：{{ conflictData()?.remoteProject?.updated_at | date:'yyyy-MM-dd HH:mm' }}
              </p>
            </div>
            <div class="mt-2 text-[10px] text-teal-600 bg-teal-50 px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">
              点击选择云端版本
            </div>
          </div>
        </div>
        
        <!-- 智能合并选项 -->
        <div class="mb-4 p-3 bg-gradient-to-r from-violet-50 to-indigo-50 rounded-lg border border-violet-200">
          <div class="flex items-start gap-2">
            <svg class="w-4 h-4 text-violet-500 mt-0.5 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
            <div class="flex-1">
              <div class="text-xs font-medium text-violet-700 mb-1">智能合并（推荐）</div>
              <p class="text-[10px] text-violet-600 mb-2">保留双方的新增内容，合并修改。如果同一任务在双方都有修改，将优先使用较新的版本。</p>
              <button 
                (click)="resolveConflictMerge()"
                class="px-3 py-1.5 bg-violet-500 text-white text-xs font-medium rounded-lg hover:bg-violet-600 transition-colors flex items-center gap-1.5">
                <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M8 3v3a2 2 0 01-2 2H3m18 0h-3a2 2 0 01-2-2V3m0 18v-3a2 2 0 012-2h3M3 16h3a2 2 0 012 2v3"/>
                </svg>
                执行智能合并
              </button>
            </div>
          </div>
        </div>
        
        <div class="text-xs text-stone-400 mb-4 p-2 bg-stone-50 rounded-lg">
          💡 <span class="font-medium">提示：</span>选择「本地版本」将覆盖云端数据；选择「云端版本」将丢弃本地未同步的更改；「智能合并」会尝试保留双方的修改。
        </div>
        
        <div class="flex justify-between items-center">
          <button 
            (click)="cancelConflictResolution()"
            class="px-3 py-1.5 text-stone-500 hover:text-stone-700 text-xs transition-colors">
            稍后解决
          </button>
          <div class="flex gap-2">
            <button (click)="resolveConflictRemote()" class="px-4 py-2 text-stone-600 hover:bg-stone-100 rounded-lg transition-colors text-sm font-medium border border-stone-200">
              使用云端
            </button>
            <button (click)="resolveConflictLocal()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-sm font-medium">
              使用本地
            </button>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- 配置帮助对话框 -->
  @if (showConfigHelp()) {
    <div class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in p-4" (click)="showConfigHelp.set(false)">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden" (click)="$event.stopPropagation()">
        <div class="px-6 py-5 bg-gradient-to-r from-amber-50 to-orange-50 border-b border-amber-200">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center">
              <svg class="w-5 h-5 text-amber-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
              </svg>
            </div>
            <div>
              <h3 class="text-lg font-bold text-stone-800">Supabase 配置指南</h3>
              <p class="text-xs text-amber-700">启用云同步需要配置 Supabase 环境变量</p>
            </div>
          </div>
        </div>
        
        <div class="px-6 py-5 space-y-4 max-h-[60vh] overflow-y-auto">
          <div class="text-sm text-stone-600">
            <p class="mb-3">您当前处于<span class="font-semibold text-amber-600">离线模式</span>，数据只保存在本地浏览器中。要启用云端同步，请按以下步骤配置：</p>
          </div>
          
          <div class="space-y-3">
            <div class="p-3 bg-stone-50 rounded-lg">
              <div class="flex items-center gap-2 mb-2">
                <span class="w-5 h-5 rounded-full bg-indigo-100 text-indigo-600 text-xs font-bold flex items-center justify-center">1</span>
                <span class="font-medium text-stone-700 text-sm">创建 Supabase 项目</span>
              </div>
              <p class="text-xs text-stone-500 ml-7">
                访问 <a href="https://supabase.com" target="_blank" class="text-indigo-600 hover:underline">supabase.com</a> 创建免费账号和项目
              </p>
            </div>
            
            <div class="p-3 bg-stone-50 rounded-lg">
              <div class="flex items-center gap-2 mb-2">
                <span class="w-5 h-5 rounded-full bg-indigo-100 text-indigo-600 text-xs font-bold flex items-center justify-center">2</span>
                <span class="font-medium text-stone-700 text-sm">获取 API 密钥</span>
              </div>
              <p class="text-xs text-stone-500 ml-7">
                在项目设置 &gt; API 中找到 Project URL 和 anon public key
              </p>
            </div>
            
            <div class="p-3 bg-stone-50 rounded-lg">
              <div class="flex items-center gap-2 mb-2">
                <span class="w-5 h-5 rounded-full bg-indigo-100 text-indigo-600 text-xs font-bold flex items-center justify-center">3</span>
                <span class="font-medium text-stone-700 text-sm">配置环境变量</span>
              </div>
              <p class="text-xs text-stone-500 ml-7 mb-2">
                在项目根目录创建 <code class="px-1.5 py-0.5 bg-stone-200 rounded text-[11px] font-mono">.env.local</code> 文件：
              </p>
              <div class="ml-7 p-2 bg-stone-800 rounded text-[11px] font-mono text-stone-100 overflow-x-auto">
                <div>NG_APP_SUPABASE_URL=your-project-url</div>
                <div>NG_APP_SUPABASE_ANON_KEY=your-anon-key</div>
              </div>
            </div>
            
            <div class="p-3 bg-stone-50 rounded-lg">
              <div class="flex items-center gap-2 mb-2">
                <span class="w-5 h-5 rounded-full bg-indigo-100 text-indigo-600 text-xs font-bold flex items-center justify-center">4</span>
                <span class="font-medium text-stone-700 text-sm">运行配置脚本</span>
              </div>
              <p class="text-xs text-stone-500 ml-7 mb-2">
                执行以下命令生成环境配置：
              </p>
              <div class="ml-7 p-2 bg-stone-800 rounded text-[11px] font-mono text-stone-100">
                npm run config && npm start
              </div>
            </div>
          </div>
          
          <div class="p-3 bg-emerald-50 rounded-lg border border-emerald-200">
            <div class="flex items-start gap-2">
              <svg class="w-4 h-4 text-emerald-600 mt-0.5 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <p class="text-xs text-emerald-700">
                <span class="font-semibold">离线模式也能正常使用</span> - 您的数据会保存在浏览器本地存储中，但无法跨设备同步。
              </p>
            </div>
          </div>
        </div>
        
        <div class="px-6 py-4 bg-stone-50 border-t border-stone-200 flex justify-end gap-3">
          <a href="https://github.com/your-repo/nanoflow#readme" target="_blank" class="px-4 py-2 text-stone-600 hover:text-stone-800 text-sm font-medium transition-colors">
            查看文档
          </a>
          <button (click)="showConfigHelp.set(false)" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-sm font-medium">
            我知道了
          </button>
        </div>
      </div>
    </div>
  }

</div>
