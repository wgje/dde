---
description: "安全基线：密钥、认证、输入校验、RLS、日志脱敏"
applyTo: "src/**/*.ts,supabase/**,**/api/**,**/functions/**,**/*.env*"
---

# Security Standards (NanoFlow)

## 密钥管理
- 禁止硬编码 API Key、Token、密码。
- 前端不得持有第三方敏感密钥。
- Supabase / Edge Functions 密钥统一使用 Secrets 管理。

## 认证与授权
- 默认要求认证，最小权限原则。
- 数据访问通过 RLS 隔离到用户级别。
- 所有关键写操作必须校验 `user_id` 归属。

## 输入与输出安全
- 所有外部输入必须校验（参数、请求体、文件）。
- Markdown/富文本渲染必须经过 XSS 防护。
- SQL 查询必须参数化，禁止字符串拼接。

## 文件上传
- 必须做 MIME 类型与扩展名校验。
- 必须走病毒扫描流程。
- 失败应返回可审计的错误码，不暴露内部细节。

## 日志与审计
- 禁止记录敏感数据（密码、token、密钥、完整隐私数据）。
- 允许记录最小必要上下文（脱敏用户标识、操作类型、时间、错误码）。

## 发布前检查
- [ ] 无硬编码 secrets
- [ ] RLS 与策略覆盖新表/新接口
- [ ] 输入校验完整
- [ ] 日志脱敏
- [ ] 错误响应不泄露内部实现
